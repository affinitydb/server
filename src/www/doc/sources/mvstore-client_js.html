<head>
  <link href='../css/mvdoc.css' rel='stylesheet' type='text/css' />
  <link href='../css/source.css' rel='stylesheet' type='text/css' />
</head>
<div id="mvstore-client_js">
<h1>mvstore-client.js</h1>

<!-- begin highlighted code -->
<div class="highlight"><pre><span class="cm">/**************************************************************************************</span>

<span class="cm">Copyright Â© 2004-2011 VMware, Inc. All rights reserved.</span>

<span class="cm">**************************************************************************************/</span>

<span class="kd">var</span> <span class="nx">lib_fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">lib_http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">lib_https</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;https&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">lib_url</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">lib_events</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">lib_protobuf</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;protobuf_for_node&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">lib_assert</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;assert&#39;</span><span class="p">);</span>

<span class="c1">// Connection to a mvStore server.</span>
<span class="c1">// Notes:</span>
<span class="c1">//   . The connection is &#39;single-threaded&#39; in the sense that it can only handle</span>
<span class="c1">//     one transaction (i.e. one long http request) at a time; &#39;multi-threading&#39;</span>
<span class="c1">//     implies multiple connection objects.</span>
<span class="c1">//   . The connection object is effectively a meta-connection: it generates</span>
<span class="c1">//     a series of http connections, in a single logical thread.</span>
<span class="c1">//   . In a sense the connection object hides the notion of network connection,</span>
<span class="c1">//     in favor of the notion of transaction: the public interface</span>
<span class="c1">//     only needs to expose startTx and commitTx (even though underneath</span>
<span class="c1">//     a transaction implies a longer-lasting http connection).</span>
<span class="c1">//   . if pOptions specifies {keepalive:true}, then the connection becomes</span>
<span class="c1">//     a real, physical, long-lasting connection, that holds resources</span>
<span class="c1">//     on the server as long as it exists.</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">createConnection</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">createConnection</span><span class="p">(</span><span class="nx">pUrl</span><span class="p">,</span> <span class="nx">pOptions</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// HTTP client config.</span>
  <span class="kd">var</span> <span class="nx">lUri</span> <span class="o">=</span> <span class="nx">lib_url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">pUrl</span><span class="p">);</span>
  <span class="nx">lUri</span><span class="p">.</span><span class="nx">httpProtocol</span> <span class="o">=</span> <span class="p">(</span><span class="nx">lUri</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">==</span> <span class="s1">&#39;https:&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="nx">lib_https</span> <span class="o">:</span> <span class="nx">lib_http</span><span class="p">;</span>
  <span class="nx">lUri</span><span class="p">.</span><span class="nx">__proto__</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">host</span><span class="o">:</span><span class="s1">&#39;127.0.0.1:4560&#39;</span><span class="p">,</span> <span class="nx">port</span><span class="o">:</span><span class="mi">4560</span><span class="p">,</span> <span class="nx">hostname</span><span class="o">:</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="nx">pathname</span><span class="o">:</span><span class="s2">&quot;/db/&quot;</span> <span class="p">};</span> <span class="c1">// Note: Assignment to __proto__ means that any member of lUri not explicitly defined will default to the members of this __proto__.</span>

  <span class="c1">// Protobuf config.</span>
  <span class="kd">var</span> <span class="nx">lMvProtoSchema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">lib_protobuf</span><span class="p">.</span><span class="nx">Schema</span><span class="p">(</span><span class="nx">lib_fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">&#39;mvstore.desc&#39;</span><span class="p">));</span>
  <span class="kd">var</span> <span class="nx">lMvStream</span> <span class="o">=</span> <span class="nx">lMvProtoSchema</span><span class="p">[</span><span class="s1">&#39;MVStorePB.MVStream&#39;</span><span class="p">];</span>
  <span class="kd">var</span> <span class="nx">lTxCtx</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="c1">// Represents the current txctx/long-http-request for this connection.</span>
  <span class="kd">var</span> <span class="nx">lNextCid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// Next stmt id.</span>
  <span class="kd">var</span> <span class="nx">lKeepAlive</span> <span class="o">=</span> <span class="p">{</span><span class="nx">on</span><span class="o">:</span><span class="p">((</span><span class="s2">&quot;keepalive&quot;</span> <span class="k">in</span> <span class="nx">pOptions</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">pOptions</span><span class="p">.</span><span class="nx">keepalive</span><span class="p">),</span> <span class="nx">client</span><span class="o">:</span><span class="kc">null</span><span class="p">}</span>

  <span class="c1">// Protobuf constants.</span>
  <span class="c1">// Note: The unofficial trick of using enums as constants is simply not available in this protobuf implementation.</span>
  <span class="kd">var</span> <span class="nx">MV_FIRST_PROPID</span> <span class="o">=</span> <span class="mi">255</span><span class="cm">/*SP_MAX*/</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">MV_TIME_OFFSET</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="mi">1970</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">).</span><span class="nx">valueOf</span><span class="p">()</span> <span class="o">-</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="mi">1601</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">).</span><span class="nx">valueOf</span><span class="p">())</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">EID_COLLECTION</span> <span class="o">=</span> <span class="mi">4294967295</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">EID_LAST_ELEMENT</span> <span class="o">=</span> <span class="mi">4294967294</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">EID_FIRST_ELEMENT</span> <span class="o">=</span> <span class="mi">4294967293</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">RT_PIDS</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">RT_PINS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="cm">/**</span>
<span class="cm">   * Private implementation helpers.</span>
<span class="cm">   */</span>

  <span class="c1">// Generic http GET/POST to the mvstore server (supports both the pure mvsql path and the protobuf path).</span>
  <span class="kd">function</span> <span class="nx">private_http</span><span class="p">(</span><span class="nx">_pPath</span><span class="p">,</span> <span class="nx">_pBody</span><span class="p">,</span> <span class="nx">_pCallback</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_lStream</span> <span class="o">=</span> <span class="nx">_pCallback</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="k">new</span> <span class="nx">lib_events</span><span class="p">.</span><span class="nx">EventEmitter</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">_lOnError</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">__pErr</span><span class="p">){</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;ERROR (private_http._lOnError): &quot;</span> <span class="o">+</span> <span class="nx">__pErr</span><span class="p">);</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_pCallback</span><span class="p">)</span> <span class="nx">_pCallback</span><span class="p">(</span><span class="nx">__pErr</span><span class="p">);</span> <span class="k">else</span> <span class="nx">_lStream</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">__pErr</span><span class="p">);</span> <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">_lJsonOut</span> <span class="o">=</span> <span class="nx">_pPath</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="sr">/o=json/</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">_lOnResponse</span> <span class="o">=</span>
      <span class="nx">_lJsonOut</span> <span class="o">?</span>
        <span class="kd">function</span><span class="p">(</span><span class="nx">__pResponse</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">__lResponse</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
          <span class="nx">__pResponse</span><span class="p">.</span><span class="nx">setEncoding</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
          <span class="nx">__pResponse</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">___pChunk</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_pCallback</span><span class="p">)</span> <span class="p">{</span> <span class="nx">__lResponse</span> <span class="o">+=</span> <span class="nx">___pChunk</span><span class="p">;</span> <span class="p">}</span> <span class="k">else</span> <span class="nx">_lStream</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nx">___pChunk</span><span class="p">);</span> <span class="p">});</span>
          <span class="nx">__pResponse</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_pCallback</span><span class="p">)</span> <span class="nx">_pCallback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">__lResponse</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">__lResponse</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\s+/g</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">))</span> <span class="o">:</span> <span class="kc">null</span><span class="p">);</span> <span class="k">else</span> <span class="nx">_lStream</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">);</span> <span class="p">});</span>
          <span class="nx">__pResponse</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">_lOnError</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="o">:</span>
        <span class="kd">function</span><span class="p">(</span><span class="nx">__pResponse</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">__lCursor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">__lResponse</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
          <span class="nx">__pResponse</span><span class="p">.</span><span class="nx">setEncoding</span><span class="p">(</span><span class="s1">&#39;binary&#39;</span><span class="p">);</span>
          <span class="nx">__pResponse</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
            <span class="kd">function</span><span class="p">(</span><span class="nx">___pChunk</span><span class="p">)</span>
            <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">_pCallback</span><span class="p">)</span>
              <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">___lChunkLen</span> <span class="o">=</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">(</span><span class="nx">___pChunk</span><span class="p">,</span> <span class="s2">&quot;binary&quot;</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">___lTempBuffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">__lCursor</span> <span class="o">+</span> <span class="nx">___lChunkLen</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">__lResponse</span> <span class="o">!=</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="nx">__lResponse</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                  <span class="p">{</span> <span class="nx">__lResponse</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span><span class="nx">___lTempBuffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">__lResponse</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span> <span class="p">}</span>
                <span class="nx">___lTempBuffer</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">___pChunk</span><span class="p">,</span> <span class="nx">__lCursor</span><span class="p">,</span> <span class="s2">&quot;binary&quot;</span><span class="p">);</span>
                <span class="nx">__lResponse</span> <span class="o">=</span> <span class="nx">___lTempBuffer</span><span class="p">;</span>
                <span class="nx">__lCursor</span> <span class="o">+=</span> <span class="nx">___lChunkLen</span><span class="p">;</span>
              <span class="p">}</span>
              <span class="k">else</span>
                <span class="p">{</span> <span class="nx">_lStream</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="nx">___pChunk</span><span class="p">);</span> <span class="p">}</span> 
            <span class="p">});</span>
          <span class="nx">__pResponse</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_pCallback</span><span class="p">)</span> <span class="p">{</span> <span class="nx">_pCallback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">__lResponse</span> <span class="o">?</span> <span class="nx">__lResponse</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">__lCursor</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span><span class="p">);</span> <span class="p">}</span> <span class="k">else</span> <span class="nx">_lStream</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">);</span> <span class="p">});</span>
          <span class="nx">__pResponse</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">_lOnError</span><span class="p">);</span>
          <span class="nx">__pResponse</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;continue&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">lib_assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s2">&quot;private_http: received a &#39;continue&#39; event (not yet handled).&quot;</span><span class="p">);</span> <span class="p">});</span>
        <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">_lHeaders</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;Host&quot;</span><span class="p">,</span> <span class="nx">lUri</span><span class="p">.</span><span class="nx">hostname</span><span class="p">]];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">_pBody</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">_lHeaders</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="s2">&quot;Content-Length&quot;</span><span class="p">,</span> <span class="nx">_pBody</span><span class="p">.</span><span class="nx">length</span><span class="p">]);</span>
      <span class="nx">_lHeaders</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s2">&quot;application/octet-stream&quot;</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">lUri</span><span class="p">.</span><span class="nx">auth</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">_lHeaders</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="s2">&quot;Authorization&quot;</span><span class="p">,</span> <span class="s2">&quot;Basic &quot;</span> <span class="o">+</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">lUri</span><span class="p">.</span><span class="nx">auth</span><span class="p">,</span> <span class="s2">&quot;ascii&quot;</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s2">&quot;base64&quot;</span><span class="p">)]);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">lKeepAlive</span><span class="p">.</span><span class="nx">on</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">_lHeaders</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="s2">&quot;Connection&quot;</span><span class="p">,</span> <span class="s2">&quot;Keep-Alive&quot;</span><span class="p">]);</span>
      <span class="k">if</span> <span class="p">(</span><span class="kc">undefined</span> <span class="o">==</span> <span class="nx">lKeepAlive</span><span class="p">.</span><span class="nx">client</span><span class="p">)</span>
        <span class="nx">lKeepAlive</span><span class="p">.</span><span class="nx">client</span> <span class="o">=</span> <span class="nx">lUri</span><span class="p">.</span><span class="nx">httpProtocol</span><span class="p">.</span><span class="nx">createClient</span><span class="p">(</span><span class="nx">lUri</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="nx">lUri</span><span class="p">.</span><span class="nx">hostname</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">_lRequest</span> <span class="o">=</span> <span class="nx">lKeepAlive</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">request</span><span class="p">(((</span><span class="nx">_pBody</span> <span class="o">!=</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="s2">&quot;POST&quot;</span> <span class="o">:</span> <span class="s2">&quot;GET&quot;</span><span class="p">),</span> <span class="nx">_pPath</span><span class="p">,</span> <span class="nx">_lHeaders</span><span class="p">);</span>
      <span class="nx">lib_assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">_lRequest</span><span class="p">.</span><span class="nx">shouldKeepAlive</span><span class="p">);</span>
      <span class="nx">_lRequest</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;response&#39;</span><span class="p">,</span> <span class="nx">_lOnResponse</span><span class="p">);</span>
      <span class="nx">_lRequest</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">_lOnError</span><span class="p">);</span>      
      <span class="k">if</span> <span class="p">(</span><span class="nx">_pBody</span><span class="p">)</span> <span class="nx">_lRequest</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">_pBody</span><span class="p">);</span>
      <span class="nx">_lRequest</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">_lRequest</span> <span class="o">=</span> <span class="nx">lUri</span><span class="p">.</span><span class="nx">httpProtocol</span><span class="p">.</span><span class="nx">request</span><span class="p">({</span><span class="nx">host</span><span class="o">:</span><span class="nx">lUri</span><span class="p">.</span><span class="nx">hostname</span><span class="p">,</span> <span class="nx">method</span><span class="o">:</span><span class="p">((</span><span class="nx">_pBody</span> <span class="o">!=</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="s2">&quot;POST&quot;</span> <span class="o">:</span> <span class="s2">&quot;GET&quot;</span><span class="p">),</span> <span class="nx">path</span><span class="o">:</span><span class="nx">_pPath</span><span class="p">,</span> <span class="nx">port</span><span class="o">:</span><span class="nx">lUri</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="nx">headers</span><span class="o">:</span><span class="nx">_lHeaders</span><span class="p">},</span> <span class="nx">_lOnResponse</span><span class="p">);</span>
      <span class="nx">lib_assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="o">!</span><span class="nx">_lRequest</span><span class="p">.</span><span class="nx">shouldKeepAlive</span><span class="p">);</span>
      <span class="nx">_lRequest</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">_lOnError</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">_pBody</span><span class="p">)</span> <span class="nx">_lRequest</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">_pBody</span><span class="p">);</span>
      <span class="nx">_lRequest</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">_lStream</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="c1">// Long http POST, for transactional protobuf (used by TxCtx only).</span>
  <span class="c1">// [Ideally, would only useful/necessary when pOptions does not specify keepalive. See the note below in the constructor.]</span>
  <span class="kd">function</span> <span class="nx">private_longhttp</span><span class="p">(</span><span class="nx">pPath</span><span class="p">,</span> <span class="nx">pCallback</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">//</span>
    <span class="c1">// Note:</span>
    <span class="c1">//   Ideally, for simplicity and consistency, I would not use private_longhttp at all, when running in keep-alive mode.</span>
    <span class="c1">//   However, currently mvstore treats each protobuf message as a topmost transaction, and aborts it</span>
    <span class="c1">//   if it doesn&#39;t commit by itself. For that reason, I&#39;m still forced to go via private_longhttp</span>
    <span class="c1">//   in keep-alive mode. That implies that plain (non-protobuf, non-mvsqlProto) mvsql requests can&#39;t be used</span>
    <span class="c1">//   inside protobuf transactions.</span>
    <span class="c1">//</span>
    <span class="c1">// if (lKeepAlive.on) throw &quot;private_longhttp is not expected to be used in a keep-alive connection&quot;;</span>
    <span class="c1">//</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mPath</span> <span class="o">=</span> <span class="nx">pPath</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mCallback</span> <span class="o">=</span> <span class="nx">pCallback</span><span class="p">;</span>
    <span class="c1">// Note: Strange logic in nodejs&#39;s http.js (the ClientRequest constructor), where if headers is an array it&#39;s handled differently than if not (e.g. chunkedEncoding will be set right away vs not).</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mHeaders</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;Host&quot;</span><span class="p">,</span> <span class="nx">lUri</span><span class="p">.</span><span class="nx">hostname</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s2">&quot;application/octet-stream&quot;</span><span class="p">]];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">lKeepAlive</span><span class="p">.</span><span class="nx">on</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">mHeaders</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="s2">&quot;Connection&quot;</span><span class="p">,</span> <span class="s2">&quot;Keep-Alive&quot;</span><span class="p">]);</span> <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">lUri</span><span class="p">.</span><span class="nx">auth</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">mHeaders</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="s2">&quot;Authorization&quot;</span><span class="p">,</span> <span class="s2">&quot;Basic &quot;</span> <span class="o">+</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">lUri</span><span class="p">.</span><span class="nx">auth</span><span class="p">,</span> <span class="s2">&quot;ascii&quot;</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s2">&quot;base64&quot;</span><span class="p">)]);</span> <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mRequest</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mResponse</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mEnded</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">private_longhttp</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">beginlongpost</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_lOnError</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">__pErr</span><span class="p">){</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;ERROR (private_longhttp._lOnError): &quot;</span> <span class="o">+</span> <span class="nx">__pErr</span><span class="p">);</span> <span class="k">this</span><span class="p">.</span><span class="nx">mCallback</span><span class="p">(</span><span class="nx">__pErr</span><span class="p">);</span> <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">_lThis</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">_lOnResponse</span> <span class="o">=</span>
      <span class="kd">function</span><span class="p">(</span><span class="nx">__pResponse</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="nx">__pResponse</span><span class="p">.</span><span class="nx">setEncoding</span><span class="p">(</span><span class="s1">&#39;binary&#39;</span><span class="p">);</span>
        <span class="nx">__pResponse</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
          <span class="kd">function</span><span class="p">(</span><span class="nx">___pChunk</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">___lChunkLen</span> <span class="o">=</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">(</span><span class="nx">___pChunk</span><span class="p">,</span> <span class="s2">&quot;binary&quot;</span><span class="p">);</span>
            <span class="c1">// console.log(&quot;private_longhttp._lOnResponse: received &quot; + ___lChunkLen + &quot; bytes&quot;);</span>
            <span class="nx">_lThis</span><span class="p">.</span><span class="nx">mResponse</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">___lChunkLen</span><span class="p">);</span>
            <span class="nx">_lThis</span><span class="p">.</span><span class="nx">mResponse</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">___pChunk</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;binary&quot;</span><span class="p">);</span>
            <span class="c1">// dbg_savePBStr(_lThis.mResponse);</span>
            <span class="c1">// console.log(&quot;private_longhttp._lOnResponse: received &quot; + JSON.stringify(lMvStream.parse(_lThis.mResponse)));</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">_lThis</span><span class="p">.</span><span class="nx">mEnded</span><span class="p">)</span>
            <span class="p">{</span>
              <span class="c1">// console.log(&quot;private_longhttp._lOnResponse: ended the request&quot;);</span>
              <span class="nx">_lThis</span><span class="p">.</span><span class="nx">mRequest</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
              <span class="nx">_lThis</span><span class="p">.</span><span class="nx">mRequest</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
              <span class="nx">_lThis</span><span class="p">.</span><span class="nx">mEnded</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
              <span class="nx">lTxCtx</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nx">_lThis</span><span class="p">.</span><span class="nx">mCallback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">(</span><span class="kc">undefined</span> <span class="o">!=</span> <span class="nx">_lThis</span><span class="p">.</span><span class="nx">mResponse</span><span class="p">)</span> <span class="o">?</span> <span class="nx">_lThis</span><span class="p">.</span><span class="nx">mResponse</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">);</span> <span class="nx">_lThis</span><span class="p">.</span><span class="nx">mResponse</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
          <span class="p">});</span>
        <span class="nx">__pResponse</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">_lOnError</span><span class="p">);</span>
        <span class="nx">__pResponse</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">lib_assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s2">&quot;private_longhttp: received an &#39;end&#39; event (not yet handled)&quot;</span><span class="p">);</span> <span class="p">});</span>
        <span class="nx">__pResponse</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="cm">/*lib_assert.fail(&quot;private_longhttp: received a &#39;close&#39; event (not yet handled)&quot;);*/</span> <span class="p">});</span>
        <span class="nx">__pResponse</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;continue&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">lib_assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s2">&quot;private_longhttp: received a &#39;continue&#39; event (not yet handled)&quot;</span><span class="p">);</span> <span class="p">});</span>
      <span class="p">};</span>
    <span class="cm">/*</span>
<span class="cm">    // Note:</span>
<span class="cm">    //   This way of sharing the same client object between private_http and private_longhttp</span>
<span class="cm">    //   doesn&#39;t work well, as a means of combining protobuf and non-protobuf access paths,</span>
<span class="cm">    //   because here in private_longhttp we may hold on to a request for a long time (e.g. higher-level</span>
<span class="cm">    //   transactions), and thus keep the client connection busy... if a private_http call happens in that context,</span>
<span class="cm">    //   it&#39;s doomed to freeze. I see only 3 ways to allow these mixtures:</span>
<span class="cm">    //     1. implement everything exclusively via the protobuf path</span>
<span class="cm">    //     2. have Mark open-up the transaction tracking related with protobuf</span>
<span class="cm">    //        (track the transaction at the level of the session, not the</span>
<span class="cm">    //        incoming protobuf message)</span>
<span class="cm">    //     3. the current cheat: effectively use 2 connections in parallel</span>
<span class="cm">    //        (one for protobuf, and another one for non-protobuf; this means that</span>
<span class="cm">    //        semantically the transactions in pure mvsql happen on a different plane</span>
<span class="cm">    //        than the transactions in protobuf)</span>
<span class="cm">    if (lKeepAlive.on)</span>
<span class="cm">    {</span>
<span class="cm">      if (undefined == lKeepAlive.client)</span>
<span class="cm">        lKeepAlive.client = lUri.httpProtocol.createClient(lUri.port, lUri.hostname);</span>
<span class="cm">      this.mRequest = lKeepAlive.client.request(&quot;POST&quot;, this.mPath, this.mHeaders);</span>
<span class="cm">      lib_assert.ok(this.mRequest.shouldKeepAlive);</span>
<span class="cm">      this.mRequest.on(&#39;response&#39;, _lOnResponse);</span>
<span class="cm">      this.mRequest.on(&#39;error&#39;, _lOnError);      </span>
<span class="cm">      this.mEnded = false;</span>
<span class="cm">    }</span>
<span class="cm">    else</span>
<span class="cm">    */</span>
    <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">mRequest</span> <span class="o">=</span> <span class="nx">lUri</span><span class="p">.</span><span class="nx">httpProtocol</span><span class="p">.</span><span class="nx">request</span><span class="p">({</span><span class="nx">host</span><span class="o">:</span><span class="nx">lUri</span><span class="p">.</span><span class="nx">hostname</span><span class="p">,</span> <span class="nx">method</span><span class="o">:</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="nx">path</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">mPath</span><span class="p">,</span> <span class="nx">port</span><span class="o">:</span><span class="nx">lUri</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="nx">headers</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">mHeaders</span><span class="p">},</span> <span class="nx">_lOnResponse</span><span class="p">);</span>
      <span class="c1">// lib_assert.ok(!this.mRequest.shouldKeepAlive);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">mRequest</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">_lOnError</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">mEnded</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nx">private_longhttp</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">continuelongpost</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pMsg</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// console.log(&quot;private_longhttp.continuelongpost: sent &quot; + pMsg.length + &quot; bytes&quot;);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mResponse</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="c1">//if (!this.mRequest._headerSent) { this.mRequest._send(this.mRequest._header, &quot;ascii&quot;); this.mRequest._headerSent = true; }</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mRequest</span><span class="p">.</span><span class="nx">_send</span><span class="p">(</span><span class="nx">pMsg</span><span class="p">,</span> <span class="s2">&quot;binary&quot;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">private_longhttp</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">endlongpost</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pTxopAlone</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// console.log(&quot;private_longhttp.endlongpost&quot;);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mEnded</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mRequest</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">pTxopAlone</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="c1">// Note:</span>
      <span class="c1">//   This is more or less a hack... TX_COMMIT+flush alone don&#39;t produce a response at the moment...</span>
      <span class="c1">//   Mark says this is unfinished functionality. In python, a similar hack was performed, but</span>
      <span class="c1">//   it was more subtle and I had actually not noticed it.</span>
      <span class="c1">// console.log(&quot;private_longhttp.endlongpost: ended the request&quot;);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">mRequest</span><span class="p">.</span><span class="nx">abort</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">mRequest</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">mEnded</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="nx">lTxCtx</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">mCallback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// Helper for options supported by the mvserver on the url.</span>
  <span class="kd">function</span> <span class="nx">appendUrlOptions</span><span class="p">(</span><span class="nx">_pUrl</span><span class="p">,</span> <span class="nx">_pOptions</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_lUrl</span> <span class="o">=</span> <span class="nx">_pUrl</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="kc">undefined</span> <span class="o">!=</span> <span class="nx">_pOptions</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;offset&quot;</span> <span class="k">in</span> <span class="nx">_pOptions</span><span class="p">)</span> <span class="nx">_lUrl</span> <span class="o">+=</span> <span class="s2">&quot;&amp;offset=&quot;</span> <span class="o">+</span> <span class="nx">_pOptions</span><span class="p">.</span><span class="nx">offset</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;limit&quot;</span> <span class="k">in</span> <span class="nx">_pOptions</span><span class="p">)</span> <span class="nx">_lUrl</span> <span class="o">+=</span> <span class="s2">&quot;&amp;limit=&quot;</span> <span class="o">+</span> <span class="nx">_pOptions</span><span class="p">.</span><span class="nx">limit</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">_lUrl</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Clone helper.</span>
  <span class="kd">function</span> <span class="nx">deepCloneObject</span><span class="p">(</span><span class="nx">_pO</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">_pO</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">_pO</span> <span class="o">==</span> <span class="s2">&quot;number&quot;</span><span class="p">)</span> <span class="k">return</span> <span class="nx">_pO</span><span class="p">;</span>
    <span class="k">switch</span> <span class="p">(</span><span class="nx">_pO</span><span class="p">.</span><span class="nx">constructor</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">default</span><span class="o">:</span> <span class="nx">lib_assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s2">&quot;deepCloneObject: unexpected type &quot;</span> <span class="o">+</span> <span class="nx">_pO</span><span class="p">.</span><span class="nx">constructor</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nb">Number</span><span class="o">:</span> <span class="k">case</span> <span class="nb">Boolean</span><span class="o">:</span> <span class="k">case</span> <span class="nb">String</span><span class="o">:</span> <span class="c1">// These are immutable or copied by value anyway.</span>
        <span class="k">return</span> <span class="nx">_pO</span><span class="p">;</span>
      <span class="k">case</span> <span class="nb">Date</span><span class="o">:</span> <span class="k">case</span> <span class="nb">RegExp</span><span class="o">:</span> <span class="k">case</span> <span class="nb">Function</span><span class="o">:</span> 
        <span class="k">return</span> <span class="k">new</span> <span class="nx">_pO</span><span class="p">.</span><span class="nx">constructor</span><span class="p">(</span><span class="nx">_pO</span><span class="p">);</span>
      <span class="k">case</span> <span class="nb">Object</span><span class="o">:</span> <span class="k">case</span> <span class="nb">Array</span><span class="o">:</span>
      <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">_lR</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">_pO</span><span class="p">.</span><span class="nx">constructor</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">_iP</span> <span class="k">in</span> <span class="nx">_pO</span><span class="p">)</span>
          <span class="nx">_lR</span><span class="p">[</span><span class="nx">_iP</span><span class="p">]</span> <span class="o">=</span> <span class="nx">deepCloneObject</span><span class="p">(</span><span class="nx">_pO</span><span class="p">[</span><span class="nx">_iP</span><span class="p">]);</span>
        <span class="k">return</span> <span class="nx">_lR</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">_pO</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Debugging helpers.</span>
  <span class="kd">function</span> <span class="nx">dbg_stackTrace</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">().</span><span class="nx">stack</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">dbg_savePBStr</span><span class="p">(</span><span class="nx">_pMsgStr</span><span class="p">)</span> <span class="c1">// Similar to mvstore.py.</span>
  <span class="p">{</span>
    <span class="nx">_lF</span> <span class="o">=</span> <span class="nx">lib_fs</span><span class="p">.</span><span class="nx">openSync</span><span class="p">(</span><span class="s2">&quot;/tmp/myproto.bin&quot;</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">);</span>
    <span class="nx">lib_fs</span><span class="p">.</span><span class="nx">writeSync</span><span class="p">(</span><span class="nx">_lF</span><span class="p">,</span> <span class="nx">_pMsgStr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_pMsgStr</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nx">lib_fs</span><span class="p">.</span><span class="nx">close</span><span class="p">(</span><span class="nx">_lF</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Protobuf: transaction context (similar to mvstore.py).</span>
  <span class="kd">function</span> <span class="nx">private_TxCtx</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mLabels</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span> <span class="c1">// Optional labels for this transaction stack (to help debugging etc.); also keeps track of nested transactions.</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mSegments</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span> <span class="c1">// Accumulated serialized segments.</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mUpdates</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span> <span class="c1">// Accumulated pin updates (not yet serialized into a next segment).</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mUpdatesSent</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mPropDict</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">private_PropDict</span><span class="p">();</span> <span class="c1">// Global property dictionary for the whole txctx.</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mCallbacks</span> <span class="o">=</span> <span class="p">[];</span> <span class="c1">// Stack of user-specified callbacks (for http completion).</span>
    <span class="kd">var</span> <span class="nx">_lThis</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">_lCallback</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">_pE</span><span class="p">,</span> <span class="nx">_pR</span><span class="p">)</span> <span class="p">{</span> <span class="nx">_lThis</span><span class="p">.</span><span class="nx">_doCallback</span><span class="p">(</span><span class="nx">_pE</span><span class="p">,</span> <span class="nx">_pR</span><span class="p">);</span> <span class="p">}</span>
    <span class="c1">// if (!lKeepAlive.on) // See the note in private_longhttp...</span>
    <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">mLongHttp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">private_longhttp</span><span class="p">(</span><span class="nx">lUri</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">+</span> <span class="s2">&quot;?i=proto&amp;o=proto&quot;</span><span class="p">,</span> <span class="nx">_lCallback</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">mLongHttp</span><span class="p">.</span><span class="nx">beginlongpost</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mMustFlushOp</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// The current op will require a flush + pushData.</span>
  <span class="p">}</span>
  <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">inExplicitTx</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="kc">undefined</span> <span class="o">!=</span> <span class="nx">lTxCtx</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">isTxCbObj</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pCallbackObj</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="kc">undefined</span> <span class="o">!=</span> <span class="nx">pCallbackObj</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">pCallbackObj</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="s2">&quot;txend&quot;</span> <span class="k">in</span> <span class="nx">pCallbackObj</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">pCallbackObj</span><span class="p">.</span><span class="nx">txend</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;function&quot;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">beginOp</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pResultHandler</span><span class="p">,</span> <span class="nx">pOptions</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// Defines a scope for any operation performed during a transaction.</span>
    <span class="c1">// Returns a function that the (internal) caller must invoke to complete the operation.</span>
    <span class="c1">// That returned function will ultimately invoke pResultHandler</span>
    <span class="c1">// (synchronously or asynchronously, depending on circumstances).</span>
    <span class="c1">// Notes:</span>
    <span class="c1">//   . Here we are at the crossroads of a number of notions:</span>
    <span class="c1">//     1. the atomic operation itself (one step of a transaction),</span>
    <span class="c1">//     2. the notion of implicit transaction,</span>
    <span class="c1">//     3. the fact that operations may require an immediate</span>
    <span class="c1">//        roundtrip to mvstore, to obtain store-generated ids,</span>
    <span class="c1">//     4. the response parsing bound to an operation, if any, and</span>
    <span class="c1">//     5. the need to effect this parsing immediately,</span>
    <span class="c1">//        in the context of a longer transaction (the fate of future</span>
    <span class="c1">//        operations in that same transaction may be dependent on</span>
    <span class="c1">//        the output of earlier operations).</span>
    <span class="c1">//   . pOptions.mustFlush is just a means of centralizing and controlling</span>
    <span class="c1">//     the use of this protobuf feature, in a way consistent with</span>
    <span class="c1">//     the ability to parse the results (with pResultHandler).</span>
    <span class="c1">//   . pResultHandler is responsible to handle the results returned by mvstore</span>
    <span class="c1">//     for this operation (i.e. parse, extract new ids etc.).</span>
    <span class="c1">//   . When pOptions.mustFlush is true, a pResultHandler must be specified (even for operations that</span>
    <span class="c1">//     generate no interesting response), because this handler also serves</span>
    <span class="c1">//     the purpose of asynchronous continuation; otherwise, the only case where pResultHandler</span>
    <span class="c1">//     is optional is within the context of an explicit transaction.</span>
    <span class="c1">//   . Asynchronous continuation may happen as the result of two situations:</span>
    <span class="c1">//     1. running the operation as an implicit transaction, and</span>
    <span class="c1">//     2. running an operation that requires immediate results (with pOptions.mustFlush).</span>
    <span class="c1">//   . Every flush implies a call to _pushData.</span>
    <span class="c1">//   . In the future, we might find ways of clustering together a series of operations</span>
    <span class="c1">//     that do require an output but that don&#39;t require it immediately (for performance);</span>
    <span class="c1">//     however, this seems impossible to predict from within this library, and would</span>
    <span class="c1">//     imply further complexification of the interface.</span>
    <span class="kd">var</span> <span class="nx">_lExplicitTx</span> <span class="o">=</span> <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">inExplicitTx</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="kc">undefined</span> <span class="o">==</span> <span class="nx">pResultHandler</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="kc">undefined</span> <span class="o">!=</span> <span class="nx">pOptions</span> <span class="o">&amp;&amp;</span> <span class="nx">pOptions</span><span class="p">.</span><span class="nx">mustFlush</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nx">_lExplicitTx</span><span class="p">))</span>
      <span class="p">{</span> <span class="nx">lib_assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s2">&quot;private_TxCtx.beginOp: invalid pResultHandler&quot;</span><span class="p">);</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_lExplicitTx</span><span class="p">)</span>
      <span class="p">{</span> <span class="nx">lTxCtx</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">private_TxCtx</span><span class="p">();</span> <span class="p">}</span>
    <span class="nx">lTxCtx</span><span class="p">.</span><span class="nx">_pushTxLabel</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">_lExplicitTx</span><span class="p">);</span>
    <span class="nx">lTxCtx</span><span class="p">.</span><span class="nx">mMustFlushOp</span> <span class="o">=</span> <span class="nx">_lExplicitTx</span> <span class="o">?</span> <span class="p">(</span><span class="kc">undefined</span> <span class="o">==</span> <span class="nx">pOptions</span> <span class="o">?</span> <span class="kc">false</span> <span class="o">:</span> <span class="nx">pOptions</span><span class="p">.</span><span class="nx">mustFlush</span><span class="p">)</span> <span class="o">:</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">lTxCtx</span><span class="p">.</span><span class="nx">_endOp</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">pResultHandler</span><span class="p">);</span> <span class="p">}</span>
  <span class="p">}</span>
  <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">makeHandler_passthrough</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pCallbackObj</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">pCallbackObj</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">isTxCbObj</span><span class="p">(</span><span class="nx">pCallbackObj</span><span class="p">))</span>
        <span class="p">{</span> <span class="nx">lib_assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s2">&quot;private_TxCtx.makeHandler_passthrough: invalid completion callback&quot;</span><span class="p">);</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span> <span class="p">}</span>
      <span class="k">return</span> <span class="nx">pCallbackObj</span><span class="p">.</span><span class="nx">txend</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">_pE</span><span class="p">,</span> <span class="nx">_pR</span><span class="p">)</span> <span class="p">{};</span>
  <span class="p">}</span>
  <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">makeHandler_onReceivePINs</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pCallbackObj</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">pCallbackObj</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">isTxCbObj</span><span class="p">(</span><span class="nx">pCallbackObj</span><span class="p">))</span>
        <span class="p">{</span> <span class="nx">lib_assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s2">&quot;private_TxCtx.makeHandler_onReceivePINs: invalid completion callback&quot;</span><span class="p">);</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span> <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">_lH</span> <span class="o">=</span>
        <span class="kd">function</span><span class="p">(</span><span class="nx">_pE</span><span class="p">,</span> <span class="nx">_pR</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">_pE</span><span class="p">)</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;ERROR (private_TxCtx.makeHandler_onReceivePINs._lH): &quot;</span> <span class="o">+</span> <span class="nx">_pE</span><span class="p">);</span> <span class="nx">pCallbackObj</span><span class="p">.</span><span class="nx">txend</span><span class="p">(</span><span class="nx">_pE</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span>
          <span class="nx">pCallbackObj</span><span class="p">.</span><span class="nx">txend</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">private_receivePB</span><span class="p">.</span><span class="nx">_createPINs</span><span class="p">(</span><span class="nx">_pR</span><span class="p">,</span> <span class="k">new</span> <span class="nx">private_PropDict</span><span class="p">()));</span>
        <span class="p">}</span>
      <span class="k">return</span> <span class="nx">_lH</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">_pE</span><span class="p">,</span> <span class="nx">_pR</span><span class="p">)</span> <span class="p">{};</span>
  <span class="p">}</span>
  <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">makeHandler_onNewEids</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pCallbackObj</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">isTxCbObj</span><span class="p">(</span><span class="nx">pCallbackObj</span><span class="p">))</span>
      <span class="p">{</span> <span class="nx">lib_assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s2">&quot;private_TxCtx.makeHandler_onNewEids: invalid completion callback&quot;</span><span class="p">);</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span> <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">_lH</span> <span class="o">=</span> 
      <span class="kd">function</span><span class="p">(</span><span class="nx">_pE</span><span class="p">,</span> <span class="nx">_pR</span><span class="p">,</span> <span class="nx">_pTxCtx</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">_pE</span><span class="p">)</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;ERROR (private_TxCtx.makeHandler_onNewEids._lH): &quot;</span> <span class="o">+</span> <span class="nx">_pE</span><span class="p">);</span> <span class="nx">pCallbackObj</span><span class="p">.</span><span class="nx">txend</span><span class="p">(</span><span class="nx">_pE</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span>
        <span class="kd">var</span> <span class="nx">__lParser</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">private_PBResponseParser</span><span class="p">(</span><span class="nx">_pR</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">__lPINUpdates</span> <span class="o">=</span> <span class="nx">_pTxCtx</span><span class="p">.</span><span class="nx">_getRelevantUpdates</span><span class="p">();</span>
        <span class="nx">pCallbackObj</span><span class="p">.</span><span class="nx">txend</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">__lParser</span><span class="p">.</span><span class="nx">finalizeUpdates</span><span class="p">(</span><span class="nx">__lPINUpdates</span><span class="p">));</span>
      <span class="p">};</span>
    <span class="k">return</span> <span class="nx">_lH</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">makeHandler_onNewPIDs</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">_pPINDescriptions</span><span class="p">,</span> <span class="nx">pCallbackObj</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">isTxCbObj</span><span class="p">(</span><span class="nx">pCallbackObj</span><span class="p">))</span>
      <span class="p">{</span> <span class="nx">lib_assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s2">&quot;private_TxCtx.makeHandler_onNewPIDs: invalid completion callback&quot;</span><span class="p">);</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span> <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">_lH</span> <span class="o">=</span>
      <span class="kd">function</span><span class="p">(</span><span class="nx">_pE</span><span class="p">,</span> <span class="nx">_pR</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">_pE</span><span class="p">)</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;ERROR (private_TxCtx.makeHandler_onNewPIDs._lH): &quot;</span> <span class="o">+</span> <span class="nx">_pE</span><span class="p">);</span> <span class="nx">pCallbackObj</span><span class="p">.</span><span class="nx">txend</span><span class="p">(</span><span class="nx">_pE</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span>
        <span class="kd">var</span> <span class="nx">__lParser</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">private_PBResponseParser</span><span class="p">(</span><span class="nx">_pR</span><span class="p">);</span>
        <span class="nx">pCallbackObj</span><span class="p">.</span><span class="nx">txend</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">__lParser</span><span class="p">.</span><span class="nx">finalizeCreates</span><span class="p">(</span><span class="nx">_pPINDescriptions</span><span class="p">));</span>
      <span class="p">};</span>
    <span class="k">return</span> <span class="nx">_lH</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">recordPINUpdate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pPINUpdate</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mUpdates</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">pPINUpdate</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">recordAny</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pStreamObj</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// Note: pStreamObj can be a single object or an array.</span>

    <span class="kd">var</span> <span class="nx">_lMustFlushOp</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">mMustFlushOp</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mMustFlushOp</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_serializePendingUpdates</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mMustFlushOp</span> <span class="o">=</span> <span class="nx">_lMustFlushOp</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">pStreamObj</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">_iO</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_iO</span> <span class="o">&lt;</span> <span class="nx">pStreamObj</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_iO</span><span class="o">++</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">_lMsgSer</span> <span class="o">=</span> <span class="nx">lMvStream</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">pStreamObj</span><span class="p">[</span><span class="nx">_iO</span><span class="p">]);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mSegments</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">_lMsgSer</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">_lMsgSer</span> <span class="o">=</span> <span class="nx">lMvStream</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">pStreamObj</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">mSegments</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">_lMsgSer</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mMustFlushOp</span><span class="p">)</span>
      <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">mSegments</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">lMvStream</span><span class="p">.</span><span class="nx">serialize</span><span class="p">({</span><span class="nx">flush</span><span class="o">:</span><span class="p">[</span><span class="mi">0</span><span class="p">]}));</span> <span class="p">}</span>
  <span class="p">}</span>
  <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">startTx</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pTxLabel</span><span class="cm">/*optional*/</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// Push a label for this transaction (for debugging and to track nested transactions).</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_pushTxLabel</span><span class="p">(</span><span class="nx">pTxLabel</span><span class="p">);</span>
    <span class="c1">// Serialize a TX_START protobuf segment.</span>
    <span class="kd">var</span> <span class="nx">_lMsgSer</span> <span class="o">=</span> <span class="nx">lMvStream</span><span class="p">.</span><span class="nx">serialize</span><span class="p">({</span><span class="nx">txop</span><span class="o">:</span><span class="p">[</span><span class="s1">&#39;TX_START&#39;</span><span class="p">]});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mSegments</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">_lMsgSer</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">commitTx</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pCallback</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_endOp</span><span class="p">(</span><span class="s1">&#39;TX_COMMIT&#39;</span><span class="p">,</span> <span class="nx">pCallback</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">rollbackTx</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pCallback</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_endOp</span><span class="p">(</span><span class="s1">&#39;TX_ROLLBACK&#39;</span><span class="p">,</span> <span class="nx">pCallback</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_serializePendingUpdates</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="c1">// Note: This is called &#39;capture&#39; in the python library (it also overlaps _applyPINUpdates).</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">mUpdates</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="c1">// console.log(&quot;private_TxCtx._serializePendingUpdates: serializing &quot; + this.mUpdates.length + &quot; updates&quot;);</span>
    <span class="kd">var</span> <span class="nx">_lMsgSer</span> <span class="o">=</span> <span class="nx">private_sendPB</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mUpdates</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">mPropDict</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">mMustFlushOp</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mSegments</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">_lMsgSer</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mUpdatesSent</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">mUpdatesSent</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mUpdates</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mUpdates</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_pushData</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="c1">// console.log(&quot;private_TxCtx._pushData: sending &quot; + this.mSegments.length + &quot; segments&quot;);</span>
    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">mSegments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
      <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">_doCallback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span>

    <span class="c1">// Note:</span>
    <span class="c1">//   If none of the segments contains a flush request, _pushData can freeze, as there would be no response from the server.</span>
    <span class="c1">//   We could monitor this situation, or even force a flush here. From a debugging point of view, the flush is immediately</span>
    <span class="c1">//   visible with the trace produced a few lines below.</span>
    <span class="c1">// this.mSegments.push(lMvStream.serialize({flush:[0]}));</span>

    <span class="c1">// Concatenate all segments into one final buffer.</span>
    <span class="kd">var</span> <span class="nx">_iS</span><span class="p">,</span> <span class="nx">_lLen</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">_iS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_iS</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">mSegments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_iS</span><span class="o">++</span><span class="p">)</span>
      <span class="nx">_lLen</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">mSegments</span><span class="p">[</span><span class="nx">_iS</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">_lSer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">_lLen</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">_lPos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">_iS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_iS</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">mSegments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_lPos</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">mSegments</span><span class="p">[</span><span class="nx">_iS</span><span class="p">].</span><span class="nx">length</span><span class="p">,</span> <span class="nx">_iS</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="c1">// console.log(&quot;private_TxCtx._pushData: sending &quot; + JSON.stringify(lMvStream.parse(this.mSegments[_iS])));</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">mSegments</span><span class="p">[</span><span class="nx">_iS</span><span class="p">].</span><span class="nx">copy</span><span class="p">(</span><span class="nx">_lSer</span><span class="p">,</span> <span class="nx">_lPos</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Clear all segments.</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mSegments</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span>

    <span class="c1">// Send the buffer.</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_pushData_impl</span><span class="p">(</span><span class="nx">_lSer</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_pushData_impl</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">_pMsgSer</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="kc">undefined</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">mLongHttp</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">_lThis</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="nx">private_http</span><span class="p">(</span><span class="nx">lUri</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">+</span> <span class="s2">&quot;?i=proto&amp;o=proto&quot;</span><span class="p">,</span> <span class="nx">_pMsgSer</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">__pE</span><span class="p">,</span> <span class="nx">__pR</span><span class="p">)</span> <span class="p">{</span> <span class="nx">_lThis</span><span class="p">.</span><span class="nx">_doCallback</span><span class="p">(</span><span class="nx">__pE</span><span class="p">,</span> <span class="nx">__pR</span><span class="p">);</span> <span class="p">});</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mLongHttp</span><span class="p">.</span><span class="nx">continuelongpost</span><span class="p">(</span><span class="nx">_pMsgSer</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_pushTxLabel</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pTxLabel</span><span class="p">,</span> <span class="nx">pExplicit</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mLabels</span><span class="p">.</span><span class="nx">push</span><span class="p">((</span><span class="kc">undefined</span> <span class="o">==</span> <span class="nx">pTxLabel</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="s2">&quot;no-label [&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">pExplicit</span> <span class="o">?</span> <span class="s2">&quot;explicit&quot;</span> <span class="o">:</span> <span class="s2">&quot;implicit&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; tx]&quot;</span><span class="p">)</span> <span class="o">:</span> <span class="nx">pTxLabel</span><span class="p">);</span>
    <span class="c1">// console.log(&quot;private_TxCtx._pushTxLabel: &quot; + this.mLabels[this.mLabels.length - 1]);</span>
  <span class="p">}</span>
  <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_endOp</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pTxop</span><span class="p">,</span> <span class="nx">pCallback</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// console.log(&quot;private_TxCtx._endOp: &quot; + this.mLabels[this.mLabels.length - 1] + &quot; with &quot; + pTxop + &quot; (&quot; + (this.mLabels.length - 1) + &quot;)&quot;);</span>

    <span class="c1">// Remember the callback for this transaction/operation (i.e. this flush).</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mCallbacks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">pCallback</span><span class="p">);</span>
    <span class="c1">// console.log(&quot;private_TxCtx._endOp: pushed callback (&quot; + this.mCallbacks.length + &quot;): &quot; + pCallback);</span>
    
    <span class="c1">// Serialize any pending PIN update.</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_serializePendingUpdates</span><span class="p">();</span>

    <span class="c1">// Serialize pTxop, if any (commit/rollback).</span>
    <span class="k">if</span> <span class="p">(</span><span class="kc">undefined</span> <span class="o">!=</span> <span class="nx">pTxop</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">_lMsgSer</span> <span class="o">=</span> <span class="nx">lMvStream</span><span class="p">.</span><span class="nx">serialize</span><span class="p">({</span><span class="nx">txop</span><span class="o">:</span><span class="p">[</span><span class="nx">pTxop</span><span class="p">],</span> <span class="nx">flush</span><span class="o">:</span><span class="p">[</span><span class="mi">0</span><span class="p">]});</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">mMustFlushOp</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">mSegments</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">_lMsgSer</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// console.log(&quot;private_TxCtx._endOp: &quot; + this.mSegments.length + &quot; segments&quot;);</span>

    <span class="c1">// Transfer the &#39;must flush&#39; state to a local variable, and clear.</span>
    <span class="kd">var</span> <span class="nx">_lMustFlushOp</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">mMustFlushOp</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mMustFlushOp</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

    <span class="c1">// Pop the label attached to this transaction/operation.</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mLabels</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
    
    <span class="c1">// Handle completion of a topmost transaction.</span>
    <span class="c1">// This includes clearing &#39;this&#39; from lTxCtx.</span>
    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">mLabels</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">_lNumSegments</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">mSegments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_pushData</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="kc">undefined</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">mLongHttp</span><span class="p">)</span>
        <span class="p">{</span> <span class="nx">lTxCtx</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="p">}</span>
      <span class="k">else</span> <span class="c1">// Note: Missing this step would cause hang at exit due to pending callbacks.</span>
        <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">mLongHttp</span><span class="p">.</span><span class="nx">endlongpost</span><span class="p">(</span><span class="kc">undefined</span> <span class="o">!=</span> <span class="nx">pTxop</span> <span class="o">&amp;&amp;</span> <span class="mi">1</span> <span class="o">==</span> <span class="nx">_lNumSegments</span><span class="p">);</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Otherwise, handle completion of an operation that must flush.</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_lMustFlushOp</span><span class="p">)</span>
      <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">_pushData</span><span class="p">();</span> <span class="p">}</span>

    <span class="c1">// Otherwise, default to just invoking the callback, if one was specified.</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="kc">undefined</span> <span class="o">==</span> <span class="nx">pTxop</span> <span class="o">&amp;&amp;</span> <span class="nx">pCallback</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">mCallbacks</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
      <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">_doCallback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span> <span class="p">}</span>
  <span class="p">}</span>
  <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_doCallback</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pE</span><span class="p">,</span> <span class="nx">pR</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mCallbacks</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">_lCallback</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">mCallbacks</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span> <span class="c1">// Note: When we invoke the callback it may itself queue up more callbacks, so it&#39;s important to pop it right away.</span>
      <span class="c1">// console.log(&quot;private_TxCtx._doCallback: received e=&quot; + JSON.stringify(pE) + &quot; r=&quot; + JSON.stringify(pR ? lMvStream.parse(pR) : null));</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">pE</span><span class="p">)</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;ERROR (private_TxCtx._doCallback): &quot;</span> <span class="o">+</span> <span class="nx">pE</span><span class="p">);</span> <span class="nx">_lCallback</span><span class="p">(</span><span class="nx">pE</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span> <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span> <span class="nx">_lCallback</span><span class="p">(</span><span class="nx">pE</span><span class="p">,</span> <span class="nx">pR</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span> <span class="p">}</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span> 
    <span class="nx">lib_assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s2">&quot;private_TxCtx._doCallback: uninitialized user callback; received e=&quot;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">pE</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; r=&quot;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">pR</span> <span class="o">?</span> <span class="nx">lMvStream</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">pR</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_getRelevantUpdates</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_lPINUpdates</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">_iP</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_iP</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">mUpdatesSent</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_iP</span><span class="o">++</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mUpdatesSent</span><span class="p">[</span><span class="nx">_iP</span><span class="p">].</span><span class="nx">mExpectNewIDs</span><span class="p">)</span>
        <span class="nx">_lPINUpdates</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mUpdatesSent</span><span class="p">[</span><span class="nx">_iP</span><span class="p">]);</span>
    <span class="k">return</span> <span class="nx">_lPINUpdates</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Protobuf: Collection accessor object, mimicking the Array interface, and representing collections conveniently.</span>
  <span class="c1">// Note: Similar to mvstore.py&#39;s PIN.Collection, except that here it&#39;s a pure interface, instantiated in a transient fashion (upon PIN.get(&#39;prop&#39;))...</span>
  <span class="c1">// Note: _pPINAccessor is a function returning a {mPID:..., mPropVals:..., mExtras:...} object pointing to a in-memory PIN&#39;s internal details.</span>
  <span class="kd">function</span> <span class="nx">Collection</span><span class="p">(</span><span class="nx">_pPINAccessor</span><span class="p">,</span> <span class="nx">_pPropName</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_mPINAccessor</span> <span class="o">=</span> <span class="nx">_pPINAccessor</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">_mPropName</span> <span class="o">=</span> <span class="nx">_pPropName</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">_mThis</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">_mUpdateLength</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">_mThis</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="nx">_mPINAccessor</span><span class="p">().</span><span class="nx">mPropVals</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="k">return</span> <span class="nx">_mThis</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">collprop</span> <span class="o">=</span> <span class="nx">_mPropName</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="nx">_mUpdateLength</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">push</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pNewValue</span><span class="p">,</span> <span class="nx">pCallbackObj</span><span class="cm">/*optional*/</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="c1">// Setup async handling of the pushData to mvstore (required to obtain resulting eid).</span>
      <span class="c1">// Note:</span>
      <span class="c1">//   Logically, we should always flush here, since a new eid will be produced.</span>
      <span class="c1">//   But for flexibility, we interpret the absence of pCallbackObj as a willingness to forfeit the eid update.</span>
      <span class="c1">//   This option is only available in an explicit transaction, because otherwise asynchronous continuation is required anyway...</span>
      <span class="kd">var</span> <span class="nx">_lMustFlush</span> <span class="o">=</span> <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">isTxCbObj</span><span class="p">(</span><span class="nx">pCallbackObj</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_lMustFlush</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">inExplicitTx</span><span class="p">())</span> <span class="p">{</span> <span class="nx">lib_assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s2">&quot;Collection.push: invalid pCallbackObj&quot;</span><span class="p">);</span> <span class="k">return</span> <span class="nx">_mThis</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">_lResultHandler</span> <span class="o">=</span> <span class="nx">_lMustFlush</span> <span class="o">?</span> <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">makeHandler_onNewEids</span><span class="p">(</span><span class="nx">pCallbackObj</span><span class="p">)</span> <span class="o">:</span> <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">makeHandler_passthrough</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">_lOpEnd</span> <span class="o">=</span> <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">beginOp</span><span class="p">(</span><span class="nx">_lResultHandler</span><span class="p">,</span> <span class="p">{</span><span class="nx">mustFlush</span><span class="o">:</span><span class="nx">_lMustFlush</span><span class="p">});</span>
      <span class="k">if</span> <span class="p">(</span><span class="kc">undefined</span> <span class="o">==</span> <span class="nx">_lOpEnd</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">_mThis</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="p">}</span>
      <span class="c1">// First, record a pin update in the current txctx.</span>
      <span class="kd">var</span> <span class="nx">_lUpdPV</span> <span class="o">=</span> <span class="p">{},</span> <span class="nx">_lExtras</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="nx">_lUpdPV</span><span class="p">[</span><span class="nx">_mPropName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">pNewValue</span><span class="p">;</span>
      <span class="nx">_lExtras</span><span class="p">[</span><span class="nx">_mPropName</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nx">eid</span><span class="o">:</span><span class="nx">EID_LAST_ELEMENT</span><span class="cm">/*Review:arguable*/</span><span class="p">,</span> <span class="nx">op</span><span class="o">:</span><span class="s1">&#39;OP_ADD&#39;</span><span class="p">};</span>
      <span class="nx">lTxCtx</span><span class="p">.</span><span class="nx">recordPINUpdate</span><span class="p">(</span><span class="k">new</span> <span class="nx">private_PINUpdate</span><span class="p">(</span><span class="nx">_mPINAccessor</span><span class="p">,</span> <span class="nx">_lUpdPV</span><span class="p">,</span> <span class="nx">_lExtras</span><span class="p">,</span> <span class="kc">true</span><span class="p">));</span>
      <span class="c1">// Second, perform the standard modif on the in-memory array.</span>
      <span class="kd">var</span> <span class="nx">_lRet</span> <span class="o">=</span> <span class="nx">_mPINAccessor</span><span class="p">().</span><span class="nx">mPropVals</span><span class="p">[</span><span class="nx">_mPropName</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">pNewValue</span><span class="p">);</span>
      <span class="nx">_mPINAccessor</span><span class="p">().</span><span class="nx">mExtras</span><span class="p">[</span><span class="nx">_mPropName</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">_lExtras</span><span class="p">[</span><span class="nx">_mPropName</span><span class="p">]);</span>
      <span class="nx">_mUpdateLength</span><span class="p">();</span>
      <span class="c1">// Third, complete the operation + invoke pCallbackObj.txend, and return the expected result.</span>
      <span class="nx">_lOpEnd</span><span class="p">();</span>
      <span class="k">return</span> <span class="nx">_lRet</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">pop</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pCallbackObj</span><span class="cm">/*optional*/</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="c1">// Setup async handling of the pushData to mvstore (required in the case of an implicit transaction).</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">isTxCbObj</span><span class="p">(</span><span class="nx">pCallbackObj</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">inExplicitTx</span><span class="p">())</span> <span class="p">{</span> <span class="nx">lib_assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s2">&quot;Collection.pop: invalid pCallbackObj&quot;</span><span class="p">);</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span> <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">_lOpEnd</span> <span class="o">=</span> <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">beginOp</span><span class="p">(</span><span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">makeHandler_passthrough</span><span class="p">(</span><span class="nx">pCallbackObj</span><span class="p">),</span> <span class="p">{</span><span class="nx">mustFlush</span><span class="o">:</span><span class="kc">false</span><span class="p">});</span>
      <span class="k">if</span> <span class="p">(</span><span class="kc">undefined</span> <span class="o">==</span> <span class="nx">_lOpEnd</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span> <span class="p">}</span>
      <span class="c1">// First, record a pin update in the current txctx.</span>
      <span class="kd">var</span> <span class="nx">_lPropExtras</span> <span class="o">=</span> <span class="nx">_mPINAccessor</span><span class="p">().</span><span class="nx">mExtras</span><span class="p">[</span><span class="nx">_mPropName</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">_lUpdPV</span> <span class="o">=</span> <span class="p">{},</span> <span class="nx">_lExtras</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="nx">_lUpdPV</span><span class="p">[</span><span class="nx">_mPropName</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nx">_lExtras</span><span class="p">[</span><span class="nx">_mPropName</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nx">eid</span><span class="o">:</span><span class="nx">_lPropExtras</span><span class="p">[</span><span class="nx">_lPropExtras</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="nx">eid</span><span class="p">,</span> <span class="nx">op</span><span class="o">:</span><span class="s1">&#39;OP_DELETE&#39;</span><span class="p">};</span>
      <span class="nx">lTxCtx</span><span class="p">.</span><span class="nx">recordPINUpdate</span><span class="p">(</span><span class="k">new</span> <span class="nx">private_PINUpdate</span><span class="p">(</span><span class="nx">_mPINAccessor</span><span class="p">,</span> <span class="nx">_lUpdPV</span><span class="p">,</span> <span class="nx">_lExtras</span><span class="p">,</span> <span class="kc">false</span><span class="p">));</span>
      <span class="c1">// Second, perform the standard modif on the in-memory array.</span>
      <span class="kd">var</span> <span class="nx">_lRet</span> <span class="o">=</span> <span class="nx">_mPINAccessor</span><span class="p">().</span><span class="nx">mPropVals</span><span class="p">[</span><span class="nx">_mPropName</span><span class="p">].</span><span class="nx">pop</span><span class="p">();</span>
      <span class="nx">_lPropExtras</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
      <span class="nx">_mUpdateLength</span><span class="p">();</span>      
      <span class="c1">// Third, complete the operation + invoke pCallbackObj.txend (if necessary: implicit tx), and return the expected result.</span>
      <span class="nx">_lOpEnd</span><span class="p">();</span>
      <span class="k">return</span> <span class="nx">_lRet</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">shift</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pCallbackObj</span><span class="cm">/*optional*/</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="c1">// Setup async handling of the pushData to mvstore (required in the case of an implicit transaction).</span>
      <span class="kd">var</span> <span class="nx">_lDefaultRet</span> <span class="o">=</span> <span class="nx">_mPINAccessor</span><span class="p">().</span><span class="nx">mPropVals</span><span class="p">[</span><span class="nx">_mPropName</span><span class="p">].</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="nx">_mPINAccessor</span><span class="p">().</span><span class="nx">mPropVals</span><span class="p">[</span><span class="nx">_mPropName</span><span class="p">].</span><span class="nx">length</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">isTxCbObj</span><span class="p">(</span><span class="nx">pCallbackObj</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">inExplicitTx</span><span class="p">())</span> <span class="p">{</span> <span class="nx">lib_assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s2">&quot;Collection.shift: invalid pCallbackObj&quot;</span><span class="p">);</span> <span class="k">return</span> <span class="nx">_lDefaultRet</span><span class="p">;</span> <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">_lOpEnd</span> <span class="o">=</span> <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">beginOp</span><span class="p">(</span><span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">makeHandler_passthrough</span><span class="p">(</span><span class="nx">pCallbackObj</span><span class="p">),</span> <span class="p">{</span><span class="nx">mustFlush</span><span class="o">:</span><span class="kc">false</span><span class="p">});</span>
      <span class="k">if</span> <span class="p">(</span><span class="kc">undefined</span> <span class="o">==</span> <span class="nx">_lOpEnd</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">_lDefaultRet</span><span class="p">;</span> <span class="p">}</span>
      <span class="c1">// First, record a pin update in the current txctx.</span>
      <span class="kd">var</span> <span class="nx">_lPropExtras</span> <span class="o">=</span> <span class="nx">_mPINAccessor</span><span class="p">().</span><span class="nx">mExtras</span><span class="p">[</span><span class="nx">_mPropName</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">_lUpdPV</span> <span class="o">=</span> <span class="p">{},</span> <span class="nx">_lExtras</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="nx">_lUpdPV</span><span class="p">[</span><span class="nx">_mPropName</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nx">_lExtras</span><span class="p">[</span><span class="nx">_mPropName</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nx">eid</span><span class="o">:</span><span class="nx">_lPropExtras</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">eid</span><span class="p">,</span> <span class="nx">op</span><span class="o">:</span><span class="s1">&#39;OP_DELETE&#39;</span><span class="p">};</span>
      <span class="nx">lTxCtx</span><span class="p">.</span><span class="nx">recordPINUpdate</span><span class="p">(</span><span class="k">new</span> <span class="nx">private_PINUpdate</span><span class="p">(</span><span class="nx">_mPINAccessor</span><span class="p">,</span> <span class="nx">_lUpdPV</span><span class="p">,</span> <span class="nx">_lExtras</span><span class="p">,</span> <span class="kc">false</span><span class="p">));</span>
      <span class="c1">// Second, perform the standard modif on the in-memory array.</span>
      <span class="kd">var</span> <span class="nx">_lRet</span> <span class="o">=</span> <span class="nx">_mPINAccessor</span><span class="p">().</span><span class="nx">mPropVals</span><span class="p">[</span><span class="nx">_mPropName</span><span class="p">].</span><span class="nx">shift</span><span class="p">();</span>
      <span class="nx">_lPropExtras</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
      <span class="nx">_mUpdateLength</span><span class="p">();</span>
      <span class="c1">// Third, complete the transaction + invoke pCallbackObj.txend (if necessary: implicit tx), and return the expected result.</span>
      <span class="nx">_lOpEnd</span><span class="p">();</span>
      <span class="k">return</span> <span class="nx">_lRet</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">unshift</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="cm">/*misc. optional arguments*/</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="c1">// If a pCallbackObj was specified, it&#39;s expected to be the last argument.</span>
      <span class="kd">var</span> <span class="nx">_lCallbackObj</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">_lArgLen</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">_lLastArg</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">_lArgLen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">isTxCbObj</span><span class="p">(</span><span class="nx">_lLastArg</span><span class="p">))</span> <span class="p">{</span> <span class="nx">_lCallbackObj</span> <span class="o">=</span> <span class="nx">_lLastArg</span><span class="p">;</span> <span class="nx">_lArgLen</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}</span>
      <span class="c1">// Setup async handling of the pushData to mvstore (required to obtain new resulting eids).</span>
      <span class="c1">// Note: See the note in &#39;Collection.push&#39;.</span>
      <span class="kd">var</span> <span class="nx">_lMustFlush</span> <span class="o">=</span> <span class="p">(</span><span class="kc">undefined</span> <span class="o">!=</span> <span class="nx">_lCallbackObj</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_lMustFlush</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">inExplicitTx</span><span class="p">())</span> <span class="p">{</span> <span class="nx">lib_assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s2">&quot;Collection.unshift: invalid pCallbackObj&quot;</span><span class="p">);</span> <span class="k">return</span> <span class="nx">_lThis</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">_lResultHandler</span> <span class="o">=</span> <span class="nx">_lMustFlush</span> <span class="o">?</span> <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">makeHandler_onNewEids</span><span class="p">(</span><span class="nx">_lCallbackObj</span><span class="p">)</span> <span class="o">:</span> <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">makeHandler_passthrough</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">_lOpEnd</span> <span class="o">=</span> <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">beginOp</span><span class="p">(</span><span class="nx">_lResultHandler</span><span class="p">,</span> <span class="p">{</span><span class="nx">mustFlush</span><span class="o">:</span><span class="nx">_lMustFlush</span><span class="p">});</span>
      <span class="k">if</span> <span class="p">(</span><span class="kc">undefined</span> <span class="o">==</span> <span class="nx">_lOpEnd</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">_lThis</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="p">}</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">_lPos</span> <span class="o">=</span> <span class="nx">_lArgLen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">_lPos</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_lPos</span><span class="o">--</span><span class="p">)</span>
      <span class="p">{</span>
         <span class="c1">// First, record a pin update in the current txctx.</span>
         <span class="kd">var</span> <span class="nx">_lUpdPV</span> <span class="o">=</span> <span class="p">{},</span> <span class="nx">_lExtras</span> <span class="o">=</span> <span class="p">{};</span>
         <span class="nx">_lUpdPV</span><span class="p">[</span><span class="nx">_mPropName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">_lPos</span><span class="p">];</span>
         <span class="nx">_lExtras</span><span class="p">[</span><span class="nx">_mPropName</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nx">eid</span><span class="o">:</span><span class="nx">EID_FIRST_ELEMENT</span><span class="p">,</span> <span class="nx">op</span><span class="o">:</span><span class="s1">&#39;OP_ADD_BEFORE&#39;</span><span class="p">};</span>
         <span class="nx">lTxCtx</span><span class="p">.</span><span class="nx">recordPINUpdate</span><span class="p">(</span><span class="k">new</span> <span class="nx">private_PINUpdate</span><span class="p">(</span><span class="nx">_mPINAccessor</span><span class="p">,</span> <span class="nx">_lUpdPV</span><span class="p">,</span> <span class="nx">_lExtras</span><span class="p">,</span> <span class="kc">true</span><span class="p">));</span>
         <span class="c1">// Second, perform the standard modif on the in-memory array.</span>
         <span class="nx">_mPINAccessor</span><span class="p">().</span><span class="nx">mPropVals</span><span class="p">[</span><span class="nx">_mPropName</span><span class="p">].</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">arguments</span><span class="p">[</span><span class="nx">_lPos</span><span class="p">]);</span>
         <span class="nx">_mPINAccessor</span><span class="p">().</span><span class="nx">mExtras</span><span class="p">[</span><span class="nx">_mPropName</span><span class="p">].</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">_lExtras</span><span class="p">[</span><span class="nx">_mPropName</span><span class="p">]);</span>
      <span class="p">}</span>
      <span class="c1">// Third, complete the operation + invoke pCallbackObj.txend, and return the expected result.</span>
      <span class="nx">_lOpEnd</span><span class="p">();</span>
      <span class="k">return</span> <span class="nx">_mUpdateLength</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">sort</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="cm">/*optional pTxCtx and pOrderFunc*/</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="c1">// REVIEW:</span>
      <span class="c1">//   Instead of re-implementing sort here, with a weak algorithm,</span>
      <span class="c1">//   we could instead let the standard array do its sorting,</span>
      <span class="c1">//   and just patch the eid order (like we do in python).</span>
      
      <span class="c1">// Get the current txctx and optional order func.</span>
      <span class="kd">var</span> <span class="nx">_lCallbackObj</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">_lOrderFunc</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">_p1</span><span class="p">,</span> <span class="nx">_p2</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">_p1</span> <span class="o">&lt;</span> <span class="nx">_p2</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="p">(</span><span class="nx">_p1</span> <span class="o">==</span> <span class="nx">_p2</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span> <span class="p">}</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">_iArg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_iArg</span> <span class="o">&lt;</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_iArg</span><span class="o">++</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">isTxCbObj</span><span class="p">(</span><span class="nx">arguments</span><span class="p">[</span><span class="nx">_iArg</span><span class="p">]))</span> <span class="nx">_lCallbackObj</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">_iArg</span><span class="p">];</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">arguments</span><span class="p">[</span><span class="nx">_iArg</span><span class="p">])</span> <span class="o">==</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="nx">_lOrderFunc</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">_iArg</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">((</span><span class="kc">undefined</span> <span class="o">==</span> <span class="nx">_lCallbackObj</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">inExplicitTx</span><span class="p">())</span> <span class="p">{</span> <span class="nx">lib_assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s2">&quot;Collection.sort: invalid pCallbackObj&quot;</span><span class="p">);</span> <span class="k">return</span> <span class="nx">_mThis</span><span class="p">;</span> <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">_lOpEnd</span> <span class="o">=</span> <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">beginOp</span><span class="p">(</span><span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">makeHandler_passthrough</span><span class="p">(</span><span class="nx">_lCallbackObj</span><span class="p">),</span> <span class="p">{</span><span class="nx">mustFlush</span><span class="o">:</span><span class="kc">false</span><span class="p">});</span>
      <span class="k">if</span> <span class="p">(</span><span class="kc">undefined</span> <span class="o">==</span> <span class="nx">_lOpEnd</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">_mThis</span><span class="p">;</span> <span class="p">}</span>
      
      <span class="c1">// Proceed with bubble sort.</span>
      <span class="kd">var</span> <span class="nx">_lPropVals</span> <span class="o">=</span> <span class="nx">_mPINAccessor</span><span class="p">().</span><span class="nx">mPropVals</span><span class="p">[</span><span class="nx">_mPropName</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">_lPropExtras</span> <span class="o">=</span> <span class="nx">_mPINAccessor</span><span class="p">().</span><span class="nx">mExtras</span><span class="p">[</span><span class="nx">_mPropName</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">_lSwap</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">_pArray</span><span class="p">,</span> <span class="nx">_pPos1</span><span class="p">,</span> <span class="nx">_pPos2</span><span class="p">)</span> <span class="p">{</span> <span class="kd">var</span> <span class="nx">__lTmp</span> <span class="o">=</span> <span class="nx">_pArray</span><span class="p">[</span><span class="nx">_pPos1</span><span class="p">];</span> <span class="nx">_pArray</span><span class="p">[</span><span class="nx">_pPos1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_pArray</span><span class="p">[</span><span class="nx">_pPos2</span><span class="p">];</span> <span class="nx">_pArray</span><span class="p">[</span><span class="nx">_pPos2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">__lTmp</span><span class="p">;</span> <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">_lSwapped</span><span class="p">;</span>
      <span class="k">do</span>
      <span class="p">{</span>
        <span class="nx">_lSwapped</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">_lPos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_lPos</span> <span class="o">&lt;</span> <span class="nx">_lPropVals</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">_lPos</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">_lUpdPV</span> <span class="o">=</span> <span class="p">{},</span> <span class="nx">_lExtras</span> <span class="o">=</span> <span class="p">{};</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">_lOrderFunc</span><span class="p">(</span><span class="nx">_lPropVals</span><span class="p">[</span><span class="nx">_lPos</span><span class="p">],</span> <span class="nx">_lPropVals</span><span class="p">[</span><span class="nx">_lPos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
          <span class="p">{</span>
              <span class="c1">// First, record a pin update in the current txctx.</span>
              <span class="nx">_lUpdPV</span><span class="p">[</span><span class="nx">_mPropName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_lPropExtras</span><span class="p">[</span><span class="nx">_lPos</span><span class="p">].</span><span class="nx">eid</span><span class="p">;</span>
              <span class="nx">_lExtras</span><span class="p">[</span><span class="nx">_mPropName</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nx">eid</span><span class="o">:</span><span class="nx">_lPropExtras</span><span class="p">[</span><span class="nx">_lPos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="nx">eid</span><span class="p">,</span> <span class="nx">op</span><span class="o">:</span><span class="s1">&#39;OP_MOVE_BEFORE&#39;</span><span class="p">,</span> <span class="nx">type</span><span class="o">:</span><span class="s1">&#39;VT_UINT&#39;</span><span class="p">};</span>
              <span class="nx">lTxCtx</span><span class="p">.</span><span class="nx">recordPINUpdate</span><span class="p">(</span><span class="k">new</span> <span class="nx">private_PINUpdate</span><span class="p">(</span><span class="nx">_mPINAccessor</span><span class="p">,</span> <span class="nx">_lUpdPV</span><span class="p">,</span> <span class="nx">_lExtras</span><span class="p">,</span> <span class="kc">false</span><span class="p">));</span>
              <span class="c1">// Second, perform the standard modif on the in-memory array.</span>
              <span class="nx">_lSwap</span><span class="p">(</span><span class="nx">_lPropVals</span><span class="p">,</span> <span class="nx">_lPos</span><span class="p">,</span> <span class="nx">_lPos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
              <span class="nx">_lSwap</span><span class="p">(</span><span class="nx">_lPropExtras</span><span class="p">,</span> <span class="nx">_lPos</span><span class="p">,</span> <span class="nx">_lPos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
              <span class="nx">_lSwapped</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nx">_lSwapped</span><span class="p">);</span>
      <span class="c1">// Third, complete the operation + invoke pCallbackObj.txend (if necessary: implicit tx), and return the expected result.</span>
      <span class="nx">_lOpEnd</span><span class="p">();</span>
      <span class="k">return</span> <span class="nx">_mThis</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">reverse</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pCallbackObj</span><span class="cm">/*optional*/</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">isTxCbObj</span><span class="p">(</span><span class="nx">pCallbackObj</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">inExplicitTx</span><span class="p">())</span> <span class="p">{</span> <span class="nx">lib_assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s2">&quot;Collection.reverse: invalid pCallbackObj&quot;</span><span class="p">);</span> <span class="k">return</span> <span class="nx">_mThis</span><span class="p">;</span> <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">_lOpEnd</span> <span class="o">=</span> <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">beginOp</span><span class="p">(</span><span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">makeHandler_passthrough</span><span class="p">(</span><span class="nx">pCallbackObj</span><span class="p">),</span> <span class="p">{</span><span class="nx">mustFlush</span><span class="o">:</span><span class="kc">false</span><span class="p">});</span>
      <span class="k">if</span> <span class="p">(</span><span class="kc">undefined</span> <span class="o">==</span> <span class="nx">_lOpEnd</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">_mThis</span><span class="p">;</span> <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">_lPropVals</span> <span class="o">=</span> <span class="nx">_mPINAccessor</span><span class="p">().</span><span class="nx">mPropVals</span><span class="p">[</span><span class="nx">_mPropName</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">_lPropExtras</span> <span class="o">=</span> <span class="nx">_mPINAccessor</span><span class="p">().</span><span class="nx">mExtras</span><span class="p">[</span><span class="nx">_mPropName</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">_lPropVals</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="nx">_mThis</span><span class="p">;</span>
      <span class="c1">// First, record a series of pin updates in the current txctx.</span>
      <span class="kd">var</span> <span class="nx">_lPivot</span> <span class="o">=</span> <span class="nx">_lPropExtras</span><span class="p">[</span><span class="nx">_lPropVals</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="nx">eid</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">_lPos</span> <span class="o">=</span> <span class="nx">_lPropVals</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span> <span class="nx">_lPos</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_lPos</span><span class="o">--</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">_lUpdPV</span> <span class="o">=</span> <span class="p">{},</span> <span class="nx">_lExtras</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="nx">_lUpdPV</span><span class="p">[</span><span class="nx">_mPropName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_lPivot</span><span class="p">;</span>
        <span class="nx">_lExtras</span><span class="p">[</span><span class="nx">_mPropName</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nx">eid</span><span class="o">:</span><span class="nx">_lPropExtras</span><span class="p">[</span><span class="nx">_lPos</span><span class="p">].</span><span class="nx">eid</span><span class="p">,</span> <span class="nx">op</span><span class="o">:</span><span class="s1">&#39;OP_MOVE&#39;</span><span class="p">,</span> <span class="nx">type</span><span class="o">:</span><span class="s1">&#39;VT_UINT&#39;</span><span class="p">};</span>
        <span class="nx">_lPivot</span> <span class="o">=</span> <span class="nx">_lPropExtras</span><span class="p">[</span><span class="nx">_lPos</span><span class="p">].</span><span class="nx">eid</span><span class="p">;</span>
        <span class="nx">lTxCtx</span><span class="p">.</span><span class="nx">recordPINUpdate</span><span class="p">(</span><span class="k">new</span> <span class="nx">private_PINUpdate</span><span class="p">(</span><span class="nx">_mPINAccessor</span><span class="p">,</span> <span class="nx">_lUpdPV</span><span class="p">,</span> <span class="nx">_lExtras</span><span class="p">,</span> <span class="kc">false</span><span class="p">));</span>
      <span class="p">}</span>
      <span class="c1">// Second, perform the standard modif on the in-memory array.</span>
      <span class="nx">_lPropVals</span><span class="p">.</span><span class="nx">reverse</span><span class="p">();</span>
      <span class="nx">_lPropExtras</span><span class="p">.</span><span class="nx">reverse</span><span class="p">();</span>
      <span class="c1">// Third, complete the transaction + invoke pCallbackObj.txend (if necessary: implicit tx), and return the expected result.</span>
      <span class="nx">_lOpEnd</span><span class="p">();</span>
      <span class="k">return</span> <span class="nx">_mThis</span><span class="p">;</span>
    <span class="p">}</span>    
    <span class="k">this</span><span class="p">.</span><span class="nx">splice</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pStart</span><span class="p">,</span> <span class="nx">pDeleteCount</span><span class="cm">/*optional pValues and pCallbackObj*/</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="c1">// If a pCallbackObj was specified, it&#39;s expected to be the last argument.</span>
      <span class="kd">var</span> <span class="nx">_lCallbackObj</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">_lArgLen</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">_lLastArg</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">_lArgLen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">isTxCbObj</span><span class="p">(</span><span class="nx">_lLastArg</span><span class="p">))</span> <span class="p">{</span> <span class="nx">_lCallbackObj</span> <span class="o">=</span> <span class="nx">_lLastArg</span><span class="p">;</span> <span class="nx">_lArgLen</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}</span>
      <span class="c1">// Setup async handling of the pushData to mvstore (required to obtain new resulting eids).</span>
      <span class="c1">// Note: See the note in &#39;Collection.push&#39;.</span>
      <span class="c1">// Note: We could be more selective here (in cases where no new eid is actually expected).</span>
      <span class="kd">var</span> <span class="nx">_lMustFlush</span> <span class="o">=</span> <span class="p">(</span><span class="kc">undefined</span> <span class="o">!=</span> <span class="nx">_lCallbackObj</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_lMustFlush</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">inExplicitTx</span><span class="p">())</span> <span class="p">{</span> <span class="nx">lib_assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s2">&quot;Collection.splice: invalid pCallbackObj&quot;</span><span class="p">);</span> <span class="k">return</span> <span class="p">[];</span> <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">_lResultHandler</span> <span class="o">=</span> <span class="nx">_lMustFlush</span> <span class="o">?</span> <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">makeHandler_onNewEids</span><span class="p">(</span><span class="nx">_lCallbackObj</span><span class="p">)</span> <span class="o">:</span> <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">makeHandler_passthrough</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">_lOpEnd</span> <span class="o">=</span> <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">beginOp</span><span class="p">(</span><span class="nx">_lResultHandler</span><span class="p">,</span> <span class="p">{</span><span class="nx">mustFlush</span><span class="o">:</span><span class="nx">_lMustFlush</span><span class="p">});</span>
      <span class="k">if</span> <span class="p">(</span><span class="kc">undefined</span> <span class="o">==</span> <span class="nx">_lOpEnd</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">[];</span> <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">_lPropVals</span> <span class="o">=</span> <span class="nx">_mPINAccessor</span><span class="p">().</span><span class="nx">mPropVals</span><span class="p">[</span><span class="nx">_mPropName</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">_lPropExtras</span> <span class="o">=</span> <span class="nx">_mPINAccessor</span><span class="p">().</span><span class="nx">mExtras</span><span class="p">[</span><span class="nx">_mPropName</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">_lRet</span><span class="p">;</span>
      <span class="c1">// 1. Delete the specified number of elements.</span>
      <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">_lPos</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">_lPropVals</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">pStart</span> <span class="o">+</span> <span class="nx">pDeleteCount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="nx">_lPos</span> <span class="o">&gt;=</span> <span class="nx">pStart</span><span class="p">;</span> <span class="nx">_lPos</span><span class="o">--</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="c1">// First, record a pin update in the current txctx.</span>
          <span class="kd">var</span> <span class="nx">_lUpdPV</span> <span class="o">=</span> <span class="p">{},</span> <span class="nx">_lExtras</span> <span class="o">=</span> <span class="p">{};</span>
          <span class="nx">_lUpdPV</span><span class="p">[</span><span class="nx">_mPropName</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="nx">_lExtras</span><span class="p">[</span><span class="nx">_mPropName</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nx">eid</span><span class="o">:</span><span class="nx">_lPropExtras</span><span class="p">[</span><span class="nx">_lPos</span><span class="p">].</span><span class="nx">eid</span><span class="p">,</span> <span class="nx">op</span><span class="o">:</span><span class="s1">&#39;OP_DELETE&#39;</span><span class="p">};</span>
          <span class="nx">lTxCtx</span><span class="p">.</span><span class="nx">recordPINUpdate</span><span class="p">(</span><span class="k">new</span> <span class="nx">private_PINUpdate</span><span class="p">(</span><span class="nx">_mPINAccessor</span><span class="p">,</span> <span class="nx">_lUpdPV</span><span class="p">,</span> <span class="nx">_lExtras</span><span class="p">,</span> <span class="kc">false</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="c1">// Second, perform the standard modif on the in-memory array.</span>
        <span class="nx">_lRet</span> <span class="o">=</span> <span class="nx">_lPropVals</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">pStart</span><span class="p">,</span> <span class="nx">pDeleteCount</span><span class="p">);</span>
        <span class="nx">_lPropExtras</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">pStart</span><span class="p">,</span> <span class="nx">pDeleteCount</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="c1">// 2. Insert the specified new elements.</span>
      <span class="kd">var</span> <span class="nx">_lInsertionPivot</span> <span class="o">=</span> <span class="p">(</span><span class="nx">pStart</span> <span class="o">&lt;</span> <span class="nx">_lPropVals</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">?</span> <span class="nx">_lPropExtras</span><span class="p">[</span><span class="nx">pStart</span><span class="p">].</span><span class="nx">eid</span> <span class="o">:</span> <span class="nx">EID_LAST_ELEMENT</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">_lInsertionOp</span> <span class="o">=</span> <span class="p">(</span><span class="nx">pStart</span> <span class="o">&lt;</span> <span class="nx">_lPropVals</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;OP_ADD_BEFORE&#39;</span> <span class="o">:</span> <span class="s1">&#39;OP_ADD&#39;</span><span class="p">;</span>
      <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">_lArg</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="nx">_lArg</span> <span class="o">&lt;</span> <span class="nx">_lArgLen</span><span class="p">;</span> <span class="nx">_lArg</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="c1">// First, record a pin update in the current txctx.</span>
          <span class="kd">var</span> <span class="nx">_lUpdPV</span> <span class="o">=</span> <span class="p">{},</span> <span class="nx">_lExtras</span> <span class="o">=</span> <span class="p">{};</span>
          <span class="nx">_lUpdPV</span><span class="p">[</span><span class="nx">_mPropName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">_lArg</span><span class="p">];</span>
          <span class="nx">_lExtras</span><span class="p">[</span><span class="nx">_mPropName</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nx">eid</span><span class="o">:</span><span class="nx">_lInsertionPivot</span><span class="p">,</span> <span class="nx">op</span><span class="o">:</span><span class="nx">_lInsertionOp</span><span class="p">};</span>
          <span class="nx">lTxCtx</span><span class="p">.</span><span class="nx">recordPINUpdate</span><span class="p">(</span><span class="k">new</span> <span class="nx">private_PINUpdate</span><span class="p">(</span><span class="nx">_mPINAccessor</span><span class="p">,</span> <span class="nx">_lUpdPV</span><span class="p">,</span> <span class="nx">_lExtras</span><span class="p">,</span> <span class="kc">true</span><span class="p">));</span>
          <span class="c1">// Second, perform the standard modif on the in-memory array.</span>
          <span class="nx">_lPropVals</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">arguments</span><span class="p">[</span><span class="nx">_lArg</span><span class="p">]);</span>
          <span class="nx">_lPropExtras</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">_lExtras</span><span class="p">[</span><span class="nx">_mPropName</span><span class="p">]);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">_mUpdateLength</span><span class="p">();</span>
      <span class="c1">// Third, complete the transaction + invoke pCallbackObj.txend, and return the expected result.</span>
      <span class="nx">_lOpEnd</span><span class="p">();</span>
      <span class="k">return</span> <span class="nx">_lRet</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">slice</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pStart</span><span class="p">,</span> <span class="nx">pEnd</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">_mPINAccessor</span><span class="p">().</span><span class="nx">mPropVals</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">pStart</span><span class="p">,</span> <span class="nx">pEnd</span><span class="p">);</span> <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">toLocaleString</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">_mPINAccessor</span><span class="p">().</span><span class="nx">mPropVals</span><span class="p">.</span><span class="nx">toLocaleString</span><span class="p">();</span> <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">_mPINAccessor</span><span class="p">().</span><span class="nx">mPropVals</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span> <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">join</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">_mPINAccessor</span><span class="p">().</span><span class="nx">mPropVals</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span> <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">concat</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">_mPINAccessor</span><span class="p">().</span><span class="nx">mPropVals</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span> <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// Protobuf: PIN representation.</span>
  <span class="c1">// Provides &#39;set&#39; and &#39;get&#39; methods to the client (plus the Collection overrides), to enforce</span>
  <span class="c1">// the recording of PIN updates upon modification. Stores data privately, in an intermediate form</span>
  <span class="c1">// (somewhere between the natural java representation and mvstore.proto&#39;s form). This is required</span>
  <span class="c1">// in order to give normal access to named properties; the mvstore.proto format also contains many</span>
  <span class="c1">// fields that are circumstantial and that don&#39;t deserve being cached (e.g. property, op, nValues, rtt, ...).</span>
  <span class="c1">// The internal format is very close to mvstore.py&#39;s.</span>
  <span class="c1">// Note: The constructor expects an array of 3 elements: [PID, propvals, extras].</span>
  <span class="kd">function</span> <span class="nx">PIN</span><span class="p">(</span><span class="nx">_pArgs</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_mPID</span> <span class="o">=</span> <span class="nx">_pArgs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">_mPropVals</span> <span class="o">=</span> <span class="nx">_pArgs</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">_mExtras</span> <span class="o">=</span> <span class="nx">_pArgs</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">_mThis</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">_lAccessor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="p">{</span><span class="nx">mPID</span><span class="o">:</span><span class="nx">_mPID</span><span class="p">,</span> <span class="nx">mPropVals</span><span class="o">:</span><span class="nx">_mPropVals</span><span class="p">,</span> <span class="nx">mExtras</span><span class="o">:</span><span class="nx">_mExtras</span><span class="p">,</span> <span class="nx">mPIN</span><span class="o">:</span><span class="nx">_mThis</span><span class="p">};</span> <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">pid</span> <span class="o">=</span> <span class="nx">_mPID</span><span class="p">;</span> <span class="c1">// Mostly just for debugging (to avoid completely empty representation).</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">refresh</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pCallback</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">private_receivePB</span><span class="p">.</span><span class="nx">refreshPIN</span><span class="p">(</span><span class="nx">_lAccessor</span><span class="p">,</span> <span class="nx">pCallback</span><span class="p">);</span> <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">set</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pPropName</span><span class="p">,</span> <span class="nx">pPropValue</span><span class="p">,</span> <span class="nx">pCallbackObj</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="c1">// Setup async handling of the pushData to mvstore (required to obtain new resulting eids).</span>
      <span class="c1">// Note: See the note in &#39;Collection.push&#39;.</span>
      <span class="kd">var</span> <span class="nx">_lMustFlush</span> <span class="o">=</span> <span class="p">(</span><span class="nx">pPropValue</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span> <span class="o">||</span> <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">isTxCbObj</span><span class="p">(</span><span class="nx">pCallbackObj</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_lMustFlush</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">inExplicitTx</span><span class="p">())</span> <span class="p">{</span> <span class="nx">lib_assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s2">&quot;PIN.set: invalid pCallbackObj&quot;</span><span class="p">);</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">_lResultHandler</span> <span class="o">=</span> <span class="nx">_lMustFlush</span> <span class="o">?</span> <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">makeHandler_onNewEids</span><span class="p">(</span><span class="nx">pCallbackObj</span><span class="p">)</span> <span class="o">:</span> <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">makeHandler_passthrough</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">_lOpEnd</span> <span class="o">=</span> <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">beginOp</span><span class="p">(</span><span class="nx">_lResultHandler</span><span class="p">,</span> <span class="p">{</span><span class="nx">mustFlush</span><span class="o">:</span><span class="nx">_lMustFlush</span><span class="p">});</span>
      <span class="k">if</span> <span class="p">(</span><span class="kc">undefined</span> <span class="o">==</span> <span class="nx">_lOpEnd</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

      <span class="c1">// Update the in-memory object.</span>
      <span class="nx">_mPropVals</span><span class="p">[</span><span class="nx">pPropName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">pPropValue</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">pPropValue</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span> <span class="c1">// Replacing the existing value (collection or scalar) with a new collection.</span>
      <span class="p">{</span>
        <span class="nx">_mExtras</span><span class="p">[</span><span class="nx">pPropName</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">_iPV</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_iPV</span> <span class="o">&lt;</span> <span class="nx">pPropValue</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_iPV</span><span class="o">++</span><span class="p">)</span>
          <span class="nx">_mExtras</span><span class="p">[</span><span class="nx">pPropName</span><span class="p">].</span><span class="nx">push</span><span class="p">({</span><span class="nx">eid</span><span class="o">:</span><span class="nx">EID_LAST_ELEMENT</span><span class="p">,</span> <span class="nx">op</span><span class="o">:</span><span class="s1">&#39;OP_ADD&#39;</span><span class="p">});</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_mExtras</span><span class="p">[</span><span class="nx">pPropName</span><span class="p">]</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span> <span class="c1">// Replacing a collection with a scalar.</span>
        <span class="nx">_mExtras</span><span class="p">[</span><span class="nx">pPropName</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span> <span class="c1">// Note: Type and eid will be overwritten anyway, in this case.</span>

      <span class="c1">// Prepare a persistent update.</span>
      <span class="kd">var</span> <span class="nx">_lUpdPV</span> <span class="o">=</span> <span class="p">{},</span> <span class="nx">_lExtras</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="nx">_lUpdPV</span><span class="p">[</span><span class="nx">pPropName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">pPropValue</span><span class="p">;</span>
      <span class="nx">_lExtras</span><span class="p">[</span><span class="nx">pPropName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_mExtras</span><span class="p">[</span><span class="nx">pPropName</span><span class="p">];</span>
      <span class="nx">lTxCtx</span><span class="p">.</span><span class="nx">recordPINUpdate</span><span class="p">(</span><span class="k">new</span> <span class="nx">private_PINUpdate</span><span class="p">(</span><span class="nx">_lAccessor</span><span class="p">,</span> <span class="nx">_lUpdPV</span><span class="p">,</span> <span class="nx">_lExtras</span><span class="p">,</span> <span class="p">(</span><span class="nx">pPropValue</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)));</span>
      
      <span class="c1">// Complete the operation + invoke pCallbackObj.txend (if necessary: implicit tx).</span>
      <span class="nx">_lOpEnd</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">get</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pPropName</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="nx">_mPropVals</span><span class="p">[</span><span class="nx">pPropName</span><span class="p">]</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span> <span class="o">?</span> <span class="k">new</span> <span class="nx">Collection</span><span class="p">(</span><span class="nx">_lAccessor</span><span class="p">,</span> <span class="nx">pPropName</span><span class="p">)</span> <span class="o">:</span> <span class="nx">_mPropVals</span><span class="p">[</span><span class="nx">pPropName</span><span class="p">];</span> <span class="p">}</span>
    <span class="c1">// ---</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">toDict</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">deepCloneObject</span><span class="p">(</span><span class="nx">_mPropVals</span><span class="p">);</span> <span class="p">}</span> <span class="c1">// Note: We clone to prevent creating bad habits; this is meant to be used for debugging/introspection.</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">getExtras</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">deepCloneObject</span><span class="p">(</span><span class="nx">_mExtras</span><span class="p">);</span> <span class="p">}</span> <span class="c1">// Note: This is meant ot be used for debugging/introspection.</span>
  <span class="p">}</span>

  <span class="c1">// Protobuf: for VT_URL.</span>
  <span class="kd">function</span> <span class="nx">Url</span><span class="p">(</span><span class="nx">_pString</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_mString</span> <span class="o">=</span> <span class="nx">_pString</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">isUrl</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">_mString</span><span class="p">;</span> <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// Protobuf: for VT_REF*.</span>
  <span class="kd">function</span> <span class="nx">Ref</span><span class="p">(</span><span class="nx">_pLocalPID</span><span class="p">,</span> <span class="nx">_pIdent</span><span class="p">,</span> <span class="nx">_pProperty</span><span class="p">,</span> <span class="nx">_pEid</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_mLocalPID</span> <span class="o">=</span> <span class="nx">_pLocalPID</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">_mIdent</span> <span class="o">=</span> <span class="nx">_pIdent</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">_mProperty</span> <span class="o">=</span> <span class="nx">_pProperty</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">_mEid</span> <span class="o">=</span> <span class="nx">_pEid</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">isRef</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">get</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="p">{</span><span class="nx">id</span><span class="o">:</span><span class="nx">_mLocalPID</span><span class="p">,</span> <span class="nx">ident</span><span class="o">:</span><span class="nx">_mIdent</span><span class="p">,</span> <span class="nx">property</span><span class="o">:</span><span class="nx">_mProperty</span><span class="p">,</span> <span class="nx">eid</span><span class="o">:</span><span class="nx">_mEid</span><span class="p">};</span> <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">getVT</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="kc">undefined</span> <span class="o">!=</span> <span class="nx">_mEid</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;VT_REFIDELT&#39;</span> <span class="o">:</span> <span class="p">((</span><span class="kc">undefined</span> <span class="o">!=</span> <span class="nx">_mProperty</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;VT_REFIDPROP&#39;</span> <span class="o">:</span> <span class="s1">&#39;VT_REFID&#39;</span><span class="p">);</span> <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="s2">&quot;@&quot;</span> <span class="o">+</span> <span class="nx">_mLocalPID</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="kc">undefined</span> <span class="o">!=</span> <span class="nx">_mIdent</span> <span class="o">&amp;&amp;</span> <span class="mi">0</span> <span class="o">!=</span> <span class="nx">_mIdent</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="s2">&quot;[!&quot;</span> <span class="o">+</span> <span class="nx">_mIdent</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">)</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="kc">undefined</span> <span class="o">!=</span> <span class="nx">_mProperty</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="s2">&quot;.\&quot;&quot;</span> <span class="o">+</span> <span class="nx">_mProperty</span> <span class="o">+</span> <span class="s2">&quot;\&quot;&quot;</span> <span class="o">+</span> <span class="p">((</span><span class="kc">undefined</span> <span class="o">!=</span> <span class="nx">_mEid</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="nx">_mEid</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">)</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">))</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">);</span> <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// Protobuf: PIN-update representation.</span>
  <span class="c1">// Note:</span>
  <span class="c1">//   Internal only (never handed out to the client); follows the PIN convention (propvals, extras), but also keeps</span>
  <span class="c1">//   a privileged back-pointer accessor to the modified in-memory PIN, to be able to update it upon mvstore completion (e.g. eids etc.).</span>
  <span class="kd">function</span> <span class="nx">private_PINUpdate</span><span class="p">(</span><span class="nx">_pPINAccessor</span><span class="p">,</span> <span class="nx">_pUpdatesPropVal</span><span class="p">,</span> <span class="nx">_pUpdatesExtras</span><span class="p">,</span> <span class="nx">_pExpectNewIDs</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mPINAccessor</span> <span class="o">=</span> <span class="nx">_pPINAccessor</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mUpdatesPropVal</span> <span class="o">=</span> <span class="nx">_pUpdatesPropVal</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mUpdatesExtras</span> <span class="o">=</span> <span class="nx">_pUpdatesExtras</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mExpectNewIDs</span> <span class="o">=</span> <span class="nx">_pExpectNewIDs</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">private_PINUpdate</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getPID</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">mPINAccessor</span><span class="p">().</span><span class="nx">mPID</span><span class="p">;</span> <span class="p">}</span>
  <span class="nx">private_PINUpdate</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getPIN</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">mPINAccessor</span><span class="p">().</span><span class="nx">mPIN</span><span class="p">;</span> <span class="p">}</span>

  <span class="c1">// Protobuf: segment, i.e. js instance of a MVStorePB.MVStream segment (to be combined with PINUpdate-s).</span>
  <span class="kd">function</span> <span class="nx">private_PBSegment</span><span class="p">()</span> <span class="p">{}</span>

  <span class="c1">// Protobuf: dictionary of {propname:propid}.</span>
  <span class="kd">function</span> <span class="nx">private_PropDict</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mNextID</span> <span class="o">=</span> <span class="nx">MV_FIRST_PROPID</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mID2Name</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mName2ID</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="p">}</span>
  <span class="nx">private_PropDict</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">newPIN</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pPIN</span><span class="p">)</span> <span class="p">{</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">iV</span> <span class="k">in</span> <span class="nx">pPIN</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">newPropName</span><span class="p">(</span><span class="nx">iV</span><span class="p">);</span> <span class="p">}</span> <span class="p">}</span>
  <span class="nx">private_PropDict</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">newPropName</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pName</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">pName</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">mName2ID</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">mName2ID</span><span class="p">[</span><span class="nx">pName</span><span class="p">];</span> <span class="kd">var</span> <span class="nx">lNewID</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">mNextID</span><span class="o">++</span><span class="p">;</span> <span class="k">this</span><span class="p">.</span><span class="nx">mName2ID</span><span class="p">[</span><span class="nx">pName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">lNewID</span><span class="p">;</span> <span class="k">this</span><span class="p">.</span><span class="nx">mID2Name</span><span class="p">[</span><span class="nx">lNewID</span><span class="p">]</span> <span class="o">=</span> <span class="nx">pName</span><span class="p">;</span> <span class="k">return</span> <span class="nx">lNewID</span><span class="p">;</span> <span class="p">}</span>
  <span class="nx">private_PropDict</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getID</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pName</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">mName2ID</span><span class="p">[</span><span class="nx">pName</span><span class="p">];</span> <span class="p">}</span>
  <span class="nx">private_PropDict</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getPBRepr</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="kd">var</span> <span class="nx">lPBRepr</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span> <span class="k">for</span> <span class="p">(</span><span class="nx">iV</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">mName2ID</span><span class="p">)</span> <span class="nx">lPBRepr</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">str</span><span class="o">:</span><span class="nx">iV</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">mName2ID</span><span class="p">[</span><span class="nx">iV</span><span class="p">]});</span> <span class="k">return</span> <span class="nx">lPBRepr</span><span class="p">;</span> <span class="p">}</span>
  <span class="nx">private_PropDict</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">registerProps</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pPB</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="kc">undefined</span> <span class="o">==</span> <span class="nx">pPB</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">iP</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">iP</span> <span class="o">&lt;</span> <span class="nx">pPB</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">iP</span><span class="o">++</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">registerProp</span><span class="p">(</span><span class="nx">pPB</span><span class="p">[</span><span class="nx">iP</span><span class="p">]);</span> <span class="p">}</span>
  <span class="nx">private_PropDict</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">registerProp</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pPBProp</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">mID2Name</span><span class="p">[</span><span class="nx">pPBProp</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">pPBProp</span><span class="p">.</span><span class="nx">str</span><span class="p">;</span> <span class="k">this</span><span class="p">.</span><span class="nx">mName2ID</span><span class="p">[</span><span class="nx">pPBProp</span><span class="p">.</span><span class="nx">str</span><span class="p">]</span> <span class="o">=</span> <span class="nx">pPBProp</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span> <span class="p">}</span>
  <span class="nx">private_PropDict</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getPropName</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pID</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">mID2Name</span><span class="p">[</span><span class="nx">pID</span><span class="p">];</span> <span class="p">}</span>

  <span class="c1">// Protobuf save: convert either an array of descriptions of new PINs (js object literals), or an array of</span>
  <span class="c1">// private_PINUpdate-s, into their PB representation, serialize the result into a buffer ready to</span>
  <span class="c1">// be sent to mvstore, send, and collect the resulting pids/eids, if any.</span>
  <span class="kd">function</span> <span class="nx">private_sendPB</span><span class="p">(</span><span class="nx">_pPINs</span><span class="p">,</span> <span class="nx">_pCallback</span><span class="p">,</span> <span class="nx">_pDescr</span><span class="cm">/*optional*/</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_lOnPBResult</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">__pE</span><span class="p">,</span> <span class="nx">__pR</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">__pE</span><span class="p">)</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;ERROR (private_sendPB._lOnPBResult): &quot;</span> <span class="o">+</span> <span class="nx">_pDescr</span> <span class="o">+</span> <span class="s2">&quot; failed: &quot;</span> <span class="o">+</span> <span class="nx">__pE</span><span class="p">);</span> <span class="nx">_pCallback</span><span class="p">(</span><span class="nx">__pE</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span> <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">__lParser</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">private_PBResponseParser</span><span class="p">(</span><span class="nx">__pR</span><span class="p">);</span>
      <span class="nx">_pCallback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">(</span><span class="nx">_pPINs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">instanceof</span> <span class="nx">private_PINUpdate</span><span class="p">)</span> <span class="o">?</span> <span class="nx">__lParser</span><span class="p">.</span><span class="nx">finalizeUpdates</span><span class="p">(</span><span class="nx">_pPINs</span><span class="p">)</span> <span class="o">:</span> <span class="nx">__lParser</span><span class="p">.</span><span class="nx">finalizeCreates</span><span class="p">(</span><span class="nx">_pPINs</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">_lPD</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">private_PropDict</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">_lMsgSer</span> <span class="o">=</span> <span class="nx">private_sendPB</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">_pPINs</span><span class="p">,</span> <span class="nx">_lPD</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="c1">// dbg_savePBStr(_lMsgSer);</span>
    <span class="k">return</span> <span class="nx">private_http</span><span class="p">(</span><span class="nx">lUri</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">+</span> <span class="s2">&quot;?i=proto&amp;o=proto&quot;</span><span class="p">,</span> <span class="nx">_lMsgSer</span><span class="p">,</span> <span class="nx">_lOnPBResult</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// Static helper to serialize the descriptions/updates to a buffer in PB format, ready to be sent to mvstore.</span>
  <span class="nx">private_sendPB</span><span class="p">.</span><span class="nx">formatPB</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pPINs</span><span class="p">,</span> <span class="nx">pPropDict</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">pPINs</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">))</span> <span class="k">throw</span> <span class="s2">&quot;private_sendPB.serialize: pPINs must be an Array.&quot;</span><span class="p">;</span>
    <span class="c1">// Note:</span>
    <span class="c1">//   pPINs is an array of PIN descriptions (js object literals) or of private_PINUpdate objects, looking like this:</span>
    <span class="c1">//</span>
    <span class="c1">//     [{&quot;toto&quot;:&quot;whatever&quot;,&quot;tata&quot;:123,&quot;titi&quot;:&quot;2011-08-02T14:17:50.237Z&quot;,&quot;tutu&quot;:[1,2,3,4]}]</span>
    <span class="c1">//</span>
    <span class="c1">//       ... or, if it&#39;s an update, it could look like this  ...</span>
    <span class="c1">//</span>
    <span class="c1">//     [</span>
    <span class="c1">//       {&quot;mUpdatesPropVal&quot;:{&quot;tete&quot;:202020},&quot;mUpdatesExtras&quot;:{}},</span>
    <span class="c1">//       {&quot;mUpdatesPropVal&quot;:{&quot;tonton&quot;:303030},&quot;mUpdatesExtras&quot;:{}},</span>
    <span class="c1">//       {&quot;mUpdatesPropVal&quot;:{&quot;tutu&quot;:5},&quot;mUpdatesExtras&quot;:{&quot;tutu&quot;:{&quot;eid&quot;:4294967294,&quot;op&quot;:&quot;OP_ADD&quot;}}}</span>
    <span class="c1">//     ]</span>
    <span class="c1">// console.log(&quot;private_sendPB.serialize: pPINs=&quot; + JSON.stringify(pPINs));</span>
    <span class="kd">var</span> <span class="nx">_lPins</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">_iO</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_iO</span> <span class="o">&lt;</span> <span class="nx">pPINs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_iO</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">_lPin</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="kd">var</span> <span class="nx">_lPBValues</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">pPINs</span><span class="p">[</span><span class="nx">_iO</span><span class="p">]</span> <span class="k">instanceof</span> <span class="nx">private_PINUpdate</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="nx">_lPBValues</span> <span class="o">=</span> <span class="nx">private_sendPB</span><span class="p">.</span><span class="nx">createPBValues</span><span class="p">(</span><span class="nx">pPropDict</span><span class="p">,</span> <span class="nx">pPINs</span><span class="p">[</span><span class="nx">_iO</span><span class="p">].</span><span class="nx">mUpdatesPropVal</span><span class="p">,</span> <span class="nx">pPINs</span><span class="p">[</span><span class="nx">_iO</span><span class="p">].</span><span class="nx">mUpdatesExtras</span><span class="p">);</span>
        <span class="nx">_lPin</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="p">{</span><span class="nx">id</span><span class="o">:</span><span class="nx">pPINs</span><span class="p">[</span><span class="nx">_iO</span><span class="p">].</span><span class="nx">mPINAccessor</span><span class="p">().</span><span class="nx">mPID</span><span class="p">,</span> <span class="nx">ident</span><span class="o">:</span><span class="mi">0</span><span class="p">};</span>
        <span class="nx">_lPin</span><span class="p">.</span><span class="nx">op</span> <span class="o">=</span> <span class="s1">&#39;OP_UPDATE&#39;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">pPINs</span><span class="p">[</span><span class="nx">_iO</span><span class="p">])</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="nx">_lPBValues</span> <span class="o">=</span> <span class="nx">private_sendPB</span><span class="p">.</span><span class="nx">createPBValues</span><span class="p">(</span><span class="nx">pPropDict</span><span class="p">,</span> <span class="nx">pPINs</span><span class="p">[</span><span class="nx">_iO</span><span class="p">]);</span>
        <span class="nx">_lPin</span><span class="p">.</span><span class="nx">op</span> <span class="o">=</span> <span class="s1">&#39;OP_INSERT&#39;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">throw</span> <span class="s2">&quot;private_sendPB.serialize: pPINs must be an array of PIN descriptions or PIN updates.&quot;</span><span class="p">;</span>
      <span class="nx">_lPin</span><span class="p">.</span><span class="nx">values</span> <span class="o">=</span> <span class="nx">_lPBValues</span><span class="p">;</span> <span class="nx">_lPin</span><span class="p">.</span><span class="nx">nValues</span> <span class="o">=</span> <span class="nx">_lPBValues</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="nx">_lPin</span><span class="p">.</span><span class="nx">rtt</span> <span class="o">=</span> <span class="p">(</span><span class="nx">private_sendPB</span><span class="p">.</span><span class="nx">isInsertingCollectionElements</span><span class="p">(</span><span class="nx">_lPBValues</span><span class="p">)</span> <span class="o">?</span> <span class="nx">RT_PINS</span> <span class="o">:</span> <span class="nx">RT_PIDS</span><span class="p">);</span>
      <span class="nx">_lPins</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">_lPin</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">_lPins</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// Static helper to serialize the descriptions/updates to a buffer in PB format, ready to be sent to mvstore.</span>
  <span class="nx">private_sendPB</span><span class="p">.</span><span class="nx">serialize</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pPINs</span><span class="p">,</span> <span class="nx">pPropDict</span><span class="p">,</span> <span class="nx">pFlush</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_lPins</span> <span class="o">=</span> <span class="nx">private_sendPB</span><span class="p">.</span><span class="nx">formatPB</span><span class="p">(</span><span class="nx">pPINs</span><span class="p">,</span> <span class="nx">pPropDict</span><span class="p">);</span>
    
    <span class="c1">// REVIEW: Anything better than this gymnastic to control order?</span>
    <span class="kd">var</span> <span class="nx">_lMsg1</span> <span class="o">=</span> <span class="p">{</span><span class="nx">properties</span><span class="o">:</span><span class="nx">pPropDict</span><span class="p">.</span><span class="nx">getPBRepr</span><span class="p">()};</span>
    <span class="kd">var</span> <span class="nx">_lMsg2</span> <span class="o">=</span> <span class="p">{</span><span class="nx">pins</span><span class="o">:</span><span class="nx">_lPins</span><span class="p">};</span>
    <span class="kd">var</span> <span class="nx">_lMsg3</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">pFlush</span><span class="p">)</span>
      <span class="nx">_lMsg3</span><span class="p">.</span><span class="nx">flush</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">_lSer1</span> <span class="o">=</span> <span class="nx">lMvStream</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">_lMsg1</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">_lSer2</span> <span class="o">=</span> <span class="nx">lMvStream</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">_lMsg2</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">_lSer3</span> <span class="o">=</span> <span class="nx">lMvStream</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">_lMsg3</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">_lSer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">_lSer1</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="nx">_lSer2</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="nx">_lSer3</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    <span class="nx">_lSer1</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span><span class="nx">_lSer</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="nx">_lSer2</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span><span class="nx">_lSer</span><span class="p">,</span> <span class="nx">_lSer1</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    <span class="nx">_lSer3</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span><span class="nx">_lSer</span><span class="p">,</span> <span class="nx">_lSer1</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="nx">_lSer2</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    <span class="c1">// Note:</span>
    <span class="c1">//   _lSer is a binary protobuf message ready to be sent to mvstore; it may look like this:</span>
    <span class="c1">//   {</span>
    <span class="c1">//     &quot;pins&quot;:[{&quot;op&quot;:&quot;OP_INSERT&quot;,&quot;nValues&quot;:4,&quot;values&quot;:[{&quot;type&quot;:&quot;VT_STRING&quot;,&quot;property&quot;:256,&quot;str&quot;:&quot;whatever&quot;,&quot;op&quot;:&quot;OP_SET&quot;,&quot;eid&quot;:4294967295},{&quot;type&quot;:&quot;VT_DOUBLE&quot;,&quot;property&quot;:257,&quot;d&quot;:123,&quot;op&quot;:&quot;OP_SET&quot;,&quot;eid&quot;:4294967295},{&quot;type&quot;:&quot;VT_DATETIME&quot;,&quot;property&quot;:258,&quot;datetime&quot;:12956768270237000,&quot;op&quot;:&quot;OP_SET&quot;,&quot;eid&quot;:4294967295},{&quot;type&quot;:&quot;VT_ARRAY&quot;,&quot;property&quot;:259,&quot;varray&quot;:{&quot;l&quot;:4,&quot;v&quot;:[{&quot;type&quot;:&quot;VT_DOUBLE&quot;,&quot;property&quot;:259,&quot;d&quot;:1,&quot;op&quot;:&quot;OP_ADD&quot;,&quot;eid&quot;:4294967294},{&quot;type&quot;:&quot;VT_DOUBLE&quot;,&quot;property&quot;:259,&quot;d&quot;:2,&quot;op&quot;:&quot;OP_ADD&quot;,&quot;eid&quot;:4294967294},{&quot;type&quot;:&quot;VT_DOUBLE&quot;,&quot;property&quot;:259,&quot;d&quot;:3,&quot;op&quot;:&quot;OP_ADD&quot;,&quot;eid&quot;:4294967294},{&quot;type&quot;:&quot;VT_DOUBLE&quot;,&quot;property&quot;:259,&quot;d&quot;:4,&quot;op&quot;:&quot;OP_ADD&quot;,&quot;eid&quot;:4294967294}]},&quot;op&quot;:&quot;OP_SET&quot;,&quot;eid&quot;:4294967295}],&quot;rtt&quot;:&quot;RT_PIDS&quot;}],</span>
    <span class="c1">//     &quot;properties&quot;:[{&quot;str&quot;:&quot;toto&quot;,&quot;id&quot;:256},{&quot;str&quot;:&quot;tata&quot;,&quot;id&quot;:257},{&quot;str&quot;:&quot;titi&quot;,&quot;id&quot;:258},{&quot;str&quot;:&quot;tutu&quot;,&quot;id&quot;:259}],</span>
    <span class="c1">//     &quot;flush&quot;:[0]</span>
    <span class="c1">//   }</span>
    <span class="c1">// console.log(&quot;private_sendPB.serialize: returning &quot; + JSON.stringify(lMvStream.parse(_lSer)));</span>
    <span class="k">return</span> <span class="nx">_lSer</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// Static helper to determine whether we need RT_PINS or only RT_PIDS.</span>
  <span class="c1">// Note: Same logic as in mvstore.py.</span>
  <span class="c1">// REVIEW: I don&#39;t think mvstore offers a better option at the moment, but this might be prohibitively expensive in some cases.</span>
  <span class="nx">private_sendPB</span><span class="p">.</span><span class="nx">isInsertingCollectionElements</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pPBValues</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">_iV</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_iV</span> <span class="o">&lt;</span> <span class="nx">pPBValues</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_iV</span><span class="o">++</span><span class="p">)</span>
      <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">pPBValues</span><span class="p">[</span><span class="nx">_iV</span><span class="p">].</span><span class="nx">op</span> <span class="o">==</span> <span class="s1">&#39;OP_ADD&#39;</span> <span class="o">||</span> <span class="nx">pPBValues</span><span class="p">[</span><span class="nx">_iV</span><span class="p">].</span><span class="nx">op</span> <span class="o">==</span> <span class="s1">&#39;OP_ADD_BEFORE&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// Static helper to convert an array of propvals (and optional extras) into their corresponding PB values.</span>
  <span class="nx">private_sendPB</span><span class="p">.</span><span class="nx">createPBValues</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pPropDict</span><span class="p">,</span> <span class="nx">pPropVals</span><span class="p">,</span> <span class="nx">pExtras</span><span class="cm">/*optional*/</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="nx">pPropDict</span><span class="p">.</span><span class="nx">newPIN</span><span class="p">(</span><span class="nx">pPropVals</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">_lPBValues</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">_iProp</span> <span class="k">in</span> <span class="nx">pPropVals</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">_lPBValue</span> <span class="o">=</span> <span class="nx">private_sendPB</span><span class="p">.</span><span class="nx">createPBValue</span><span class="p">(</span><span class="nx">pPropDict</span><span class="p">,</span> <span class="nx">_iProp</span><span class="p">,</span> <span class="nx">pPropVals</span><span class="p">[</span><span class="nx">_iProp</span><span class="p">],</span> <span class="p">(</span><span class="nx">pExtras</span> <span class="o">!=</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="nx">_iProp</span> <span class="k">in</span> <span class="nx">pExtras</span><span class="p">)</span> <span class="o">?</span> <span class="nx">pExtras</span><span class="p">[</span><span class="nx">_iProp</span><span class="p">]</span> <span class="o">:</span> <span class="kc">null</span><span class="p">);</span>
      <span class="nx">_lPBValues</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">_lPBValue</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">_lPBValues</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// Static helper to determine if a VT_* is a numeric type.</span>
  <span class="nx">private_sendPB</span><span class="p">.</span><span class="nx">isNumericType</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pType</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;VT_INT&#39;</span> <span class="o">==</span> <span class="nx">pType</span> <span class="o">||</span> <span class="s1">&#39;VT_UINT&#39;</span> <span class="o">==</span> <span class="nx">pType</span> <span class="o">||</span> <span class="s1">&#39;VT_INT64&#39;</span> <span class="o">==</span> <span class="nx">pType</span> <span class="o">||</span> <span class="s1">&#39;VT_UINT64&#39;</span> <span class="o">==</span> <span class="nx">pType</span> <span class="o">||</span> <span class="s1">&#39;VT_FLOAT&#39;</span> <span class="o">==</span> <span class="nx">pType</span> <span class="o">||</span> <span class="s1">&#39;VT_DOUBLE&#39;</span> <span class="o">==</span> <span class="nx">pType</span> <span class="o">||</span> <span class="s1">&#39;VT_DECIMAL&#39;</span> <span class="o">==</span> <span class="nx">pType</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// Static helper to convert a single propval into its corresponding PB value (MVStorePB.Value).</span>
  <span class="nx">private_sendPB</span><span class="p">.</span><span class="nx">createPBValue</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pPropDict</span><span class="p">,</span> <span class="nx">pKey</span><span class="p">,</span> <span class="nx">pValue</span><span class="p">,</span> <span class="nx">pExtra</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// TODO: Go over python/mvstore.py::_valuePY2PB and make sure everything is coverered...</span>
    <span class="c1">// Note: The caller may override some of the resulting fields (e.g. type, eid), based on its knowledge of &#39;extras&#39;.</span>
    <span class="kd">var</span> <span class="nx">_lPropID</span> <span class="o">=</span> <span class="nx">pPropDict</span><span class="p">.</span><span class="nx">getID</span><span class="p">(</span><span class="nx">pKey</span><span class="p">);</span>
    <span class="c1">// If the value is a collection, proceed.</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">pValue</span> <span class="k">instanceof</span> <span class="nx">Collection</span><span class="p">)</span>
      <span class="p">{</span> <span class="nx">lib_assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s2">&quot;private_sendPB.createPBValue: Unexpected Collection type encountered in createPBValue!&quot;</span><span class="p">);</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">pValue</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="kc">undefined</span> <span class="o">!=</span> <span class="nx">pExtra</span> <span class="o">&amp;&amp;</span> <span class="nx">pExtra</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="nx">pValue</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
        <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;WARNING (private_sendPB.createPBValue): &quot;</span> <span class="o">+</span> <span class="nx">pExtra</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="s2">&quot; extras for &quot;</span> <span class="o">+</span> <span class="nx">pValue</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="s2">&quot; elements in the collection!&quot;</span><span class="p">);</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span> <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">_lValues</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">_iE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_iE</span> <span class="o">&lt;</span> <span class="nx">pValue</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_iE</span><span class="o">++</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">_lV</span> <span class="o">=</span> <span class="nx">private_sendPB</span><span class="p">.</span><span class="nx">createPBValue</span><span class="p">(</span><span class="nx">pPropDict</span><span class="p">,</span> <span class="nx">pKey</span><span class="p">,</span> <span class="nx">pValue</span><span class="p">[</span><span class="nx">_iE</span><span class="p">],</span> <span class="p">(</span><span class="kc">undefined</span> <span class="o">!=</span> <span class="nx">pExtra</span><span class="p">)</span> <span class="o">?</span> <span class="nx">pExtra</span><span class="p">[</span><span class="nx">_iE</span><span class="p">]</span> <span class="o">:</span> <span class="kc">null</span><span class="p">);</span>
        <span class="nx">_lV</span><span class="p">.</span><span class="nx">eid</span> <span class="o">=</span> <span class="nx">EID_LAST_ELEMENT</span><span class="p">;</span> <span class="nx">_lV</span><span class="p">.</span><span class="nx">op</span> <span class="o">=</span> <span class="s1">&#39;OP_ADD&#39;</span><span class="p">;</span>
        <span class="nx">_lValues</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">_lV</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span><span class="s1">&#39;VT_ARRAY&#39;</span><span class="p">,</span> <span class="nx">property</span><span class="o">:</span><span class="nx">_lPropID</span><span class="p">,</span> <span class="nx">varray</span><span class="o">:</span><span class="p">{</span><span class="nx">l</span><span class="o">:</span><span class="nx">_lValues</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">v</span><span class="o">:</span><span class="nx">_lValues</span><span class="p">},</span> <span class="nx">eid</span><span class="o">:</span><span class="nx">EID_COLLECTION</span><span class="p">,</span> <span class="nx">op</span><span class="o">:</span><span class="s1">&#39;OP_SET&#39;</span><span class="p">};</span>
    <span class="p">}</span>
    <span class="c1">// Otherwise, first determine the native value type.</span>
    <span class="kd">var</span> <span class="nx">_lType</span> <span class="o">=</span> <span class="s1">&#39;VT_ANY&#39;</span><span class="p">;</span>
    <span class="k">switch</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">pValue</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="k">case</span> <span class="s2">&quot;boolean&quot;</span><span class="o">:</span> <span class="nx">_lType</span> <span class="o">=</span> <span class="s1">&#39;VT_BOOL&#39;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s2">&quot;number&quot;</span><span class="o">:</span> <span class="nx">_lType</span> <span class="o">=</span> <span class="s1">&#39;VT_DOUBLE&#39;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s2">&quot;string&quot;</span><span class="o">:</span> <span class="nx">_lType</span> <span class="o">=</span> <span class="s1">&#39;VT_STRING&#39;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s2">&quot;function&quot;</span><span class="o">:</span> <span class="nx">lib_assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s2">&quot;private_sendPB.createPBValue: unexpected member of type &#39;function&#39;!&quot;</span><span class="p">);</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">case</span> <span class="s2">&quot;object&quot;</span><span class="o">:</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">pValue</span> <span class="k">instanceof</span> <span class="nb">Date</span><span class="p">)</span> <span class="nx">_lType</span> <span class="o">=</span> <span class="s1">&#39;VT_DATETIME&#39;</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">pValue</span> <span class="k">instanceof</span> <span class="nx">Buffer</span><span class="p">)</span> <span class="nx">_lType</span> <span class="o">=</span> <span class="s1">&#39;VT_BSTR&#39;</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">pValue</span> <span class="k">instanceof</span> <span class="nx">Url</span><span class="p">)</span> <span class="nx">_lType</span> <span class="o">=</span> <span class="s1">&#39;VT_URL&#39;</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">pValue</span> <span class="k">instanceof</span> <span class="nx">Ref</span><span class="p">)</span> <span class="nx">_lType</span> <span class="o">=</span> <span class="nx">pValue</span><span class="p">.</span><span class="nx">getVT</span><span class="p">();</span>
        <span class="k">else</span> <span class="p">{</span> <span class="nx">lib_assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s2">&quot;private_sendPB.createPBValue: unhandled object type for value &quot;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">pValue</span><span class="p">));</span> <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// See if pExtra overrides the native value type, eid or op.</span>
    <span class="c1">// TODO: meta</span>
    <span class="kd">var</span> <span class="nx">_lEid</span> <span class="o">=</span> <span class="nx">EID_COLLECTION</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">_lOp</span> <span class="o">=</span> <span class="s1">&#39;OP_SET&#39;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="kc">undefined</span> <span class="o">!=</span> <span class="nx">pExtra</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;eid&quot;</span> <span class="k">in</span> <span class="nx">pExtra</span><span class="p">)</span>
        <span class="nx">_lEid</span> <span class="o">=</span> <span class="nx">pExtra</span><span class="p">.</span><span class="nx">eid</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;op&quot;</span> <span class="k">in</span> <span class="nx">pExtra</span><span class="p">)</span>
        <span class="nx">_lOp</span> <span class="o">=</span> <span class="nx">pExtra</span><span class="p">.</span><span class="nx">op</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;type&quot;</span> <span class="k">in</span> <span class="nx">pExtra</span> <span class="o">&amp;&amp;</span> <span class="nx">pExtra</span><span class="p">.</span><span class="nx">type</span> <span class="o">!=</span> <span class="nx">_lType</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="nx">_lType</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="k">case</span> <span class="s1">&#39;VT_DOUBLE&#39;</span><span class="o">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">private_sendPB</span><span class="p">.</span><span class="nx">isNumericType</span><span class="p">(</span><span class="nx">pExtra</span><span class="p">.</span><span class="nx">type</span><span class="p">))</span>
              <span class="nx">_lType</span> <span class="o">=</span> <span class="nx">pExtra</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="c1">// TODO: various flavors of VT_STRING etc.</span>
          <span class="k">default</span><span class="o">:</span>
            <span class="nx">lib_assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s2">&quot;private_sendPB.createPBValue: Unexpected VT override in pExtra: &quot;</span> <span class="o">+</span> <span class="nx">_lType</span> <span class="o">+</span> <span class="s2">&quot; overriden with &quot;</span> <span class="o">+</span> <span class="nx">pExtra</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// Produce the resulting value.</span>
    <span class="kd">var</span> <span class="nx">_lResult</span> <span class="o">=</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span><span class="nx">_lType</span><span class="p">,</span> <span class="nx">property</span><span class="o">:</span><span class="nx">_lPropID</span><span class="p">,</span> <span class="nx">eid</span><span class="o">:</span><span class="nx">_lEid</span><span class="p">,</span> <span class="nx">op</span><span class="o">:</span><span class="nx">_lOp</span><span class="p">};</span>
    <span class="k">switch</span> <span class="p">(</span><span class="nx">_lType</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">case</span> <span class="s1">&#39;VT_BOOL&#39;</span><span class="o">:</span> <span class="nx">_lResult</span><span class="p">.</span><span class="nx">b</span> <span class="o">=</span> <span class="nx">pValue</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;VT_INT&#39;</span><span class="o">:</span> <span class="nx">_lResult</span><span class="p">.</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">pValue</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;VT_UINT&#39;</span><span class="o">:</span> <span class="nx">_lResult</span><span class="p">.</span><span class="nx">ui</span> <span class="o">=</span> <span class="nx">pValue</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;VT_INT64&#39;</span><span class="o">:</span> <span class="nx">_lResult</span><span class="p">.</span><span class="nx">i64</span> <span class="o">=</span> <span class="nx">pValue</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;VT_UINT64&#39;</span><span class="o">:</span> <span class="nx">_lResult</span><span class="p">.</span><span class="nx">ui64</span> <span class="o">=</span> <span class="nx">pValue</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;VT_FLOAT&#39;</span><span class="o">:</span> <span class="nx">_lResult</span><span class="p">.</span><span class="nx">f</span> <span class="o">=</span> <span class="nx">pValue</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;VT_DOUBLE&#39;</span><span class="o">:</span> <span class="nx">_lResult</span><span class="p">.</span><span class="nx">d</span> <span class="o">=</span> <span class="nx">pValue</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;VT_DECIMAL&#39;</span><span class="o">:</span> <span class="nx">_lResult</span><span class="p">.</span><span class="nx">d</span> <span class="o">=</span> <span class="nx">pValue</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// ?</span>
      <span class="k">case</span> <span class="s1">&#39;VT_URL&#39;</span><span class="o">:</span> <span class="k">case</span> <span class="s1">&#39;VT_STRING&#39;</span><span class="o">:</span> <span class="nx">_lResult</span><span class="p">.</span><span class="nx">str</span> <span class="o">=</span> <span class="nx">pValue</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;VT_BSTR&#39;</span><span class="o">:</span> <span class="nx">_lResult</span><span class="p">.</span><span class="nx">bstr</span> <span class="o">=</span> <span class="nx">pValue</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;VT_DATETIME&#39;</span><span class="o">:</span> <span class="nx">_lResult</span><span class="p">.</span><span class="nx">datetime</span> <span class="o">=</span> <span class="nx">pValue</span><span class="p">.</span><span class="nx">valueOf</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">+</span> <span class="nx">MV_TIME_OFFSET</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;VT_REFID&#39;</span><span class="o">:</span> <span class="p">{</span><span class="kd">var</span> <span class="nx">_lV</span> <span class="o">=</span> <span class="nx">pValue</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span> <span class="nx">_lResult</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="p">{</span><span class="nx">id</span><span class="o">:</span><span class="nx">_lV</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">ident</span><span class="o">:</span><span class="nx">_lV</span><span class="p">.</span><span class="nx">ident</span><span class="p">};</span> <span class="k">break</span><span class="p">;}</span>
      <span class="k">case</span> <span class="s1">&#39;VT_REFIDPROP&#39;</span><span class="o">:</span> <span class="p">{</span><span class="kd">var</span> <span class="nx">_lV</span> <span class="o">=</span> <span class="nx">pValue</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span> <span class="nx">_lResult</span><span class="p">.</span><span class="nx">ref</span> <span class="o">=</span> <span class="p">{</span><span class="nx">id</span><span class="o">:</span><span class="p">{</span><span class="nx">id</span><span class="o">:</span><span class="nx">_lV</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">ident</span><span class="o">:</span><span class="nx">_lV</span><span class="p">.</span><span class="nx">ident</span><span class="p">},</span> <span class="nx">property</span><span class="o">:</span><span class="nx">pPropDict</span><span class="p">.</span><span class="nx">newPropName</span><span class="p">(</span><span class="nx">_lV</span><span class="p">.</span><span class="nx">property</span><span class="p">)};</span> <span class="k">break</span><span class="p">;}</span>
      <span class="k">case</span> <span class="s1">&#39;VT_REFIDELT&#39;</span><span class="o">:</span> <span class="p">{</span><span class="kd">var</span> <span class="nx">_lV</span> <span class="o">=</span> <span class="nx">pValue</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span> <span class="nx">_lResult</span><span class="p">.</span><span class="nx">ref</span> <span class="o">=</span> <span class="p">{</span><span class="nx">id</span><span class="o">:</span><span class="p">{</span><span class="nx">id</span><span class="o">:</span><span class="nx">_lV</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">ident</span><span class="o">:</span><span class="nx">_lV</span><span class="p">.</span><span class="nx">ident</span><span class="p">},</span> <span class="nx">property</span><span class="o">:</span><span class="nx">pPropDict</span><span class="p">.</span><span class="nx">newPropName</span><span class="p">(</span><span class="nx">_lV</span><span class="p">.</span><span class="nx">property</span><span class="p">),</span> <span class="nx">eid</span><span class="o">:</span><span class="nx">_lV</span><span class="p">.</span><span class="nx">eid</span><span class="p">};</span> <span class="k">break</span><span class="p">;}</span>
      <span class="k">default</span><span class="o">:</span> <span class="nx">lib_assert</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s2">&quot;private_sendPB.createPBValue: Unhandled VT: &quot;</span> <span class="o">+</span> <span class="nx">_lType</span><span class="p">);</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">_lResult</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Protobuf save completion: parse mvstore&#39;s response after inserting/updating PINs, and update the in-memory PINs accordingly.</span>
  <span class="kd">function</span> <span class="nx">private_PBResponseParser</span><span class="p">(</span><span class="nx">_pPBResponse</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mParsed</span> <span class="o">=</span> <span class="nx">lMvStream</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">_pPBResponse</span><span class="p">);</span>
    <span class="c1">// Note:</span>
    <span class="c1">//   this.mParsed is a javascript object resulting from protobuf_for_node&#39;s parsing of the raw protobuf buffer</span>
    <span class="c1">//   returned by mvstore following an insert/update on existing PINs; it may represent only the updated parts of a PIN,</span>
    <span class="c1">//   and could look like this:</span>
    <span class="c1">//   {</span>
    <span class="c1">//     &quot;pins&quot;:[{&quot;id&quot;:{&quot;id&quot;:327681},&quot;mode&quot;:2147483648,&quot;nValues&quot;:1,&quot;values&quot;:[{&quot;type&quot;:&quot;VT_DOUBLE&quot;,&quot;property&quot;:259,&quot;d&quot;:5}]}],</span>
    <span class="c1">//     &quot;properties&quot;:[{&quot;str&quot;:&quot;tutu&quot;,&quot;id&quot;:259}],</span>
    <span class="c1">//     &quot;result&quot;:{&quot;count&quot;:1,&quot;op&quot;:&quot;OP_UPDATE&quot;}</span>
    <span class="c1">//   }</span>
    <span class="c1">// console.log(&quot;private_PBResponseParser: this.mParsed=&quot; + JSON.stringify(this.mParsed));</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mPropDict</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">private_PropDict</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">mPropDict</span><span class="p">.</span><span class="nx">registerProps</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mParsed</span><span class="p">.</span><span class="nx">properties</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">private_PBResponseParser</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">finalizeCreates</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pPINDescriptions</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mParsed</span><span class="p">.</span><span class="nx">pins</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="nx">pPINDescriptions</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;WARNING (private_PBResponseParser.finalizeCreates): &quot;</span> <span class="o">+</span> <span class="nx">pPINDescriptions</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="s2">&quot; PINs were created, but mvstore&#39;s response contained &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">mParsed</span><span class="p">.</span><span class="nx">pins</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="s2">&quot; PINs.&quot;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">_lPIDs</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">var</span> <span class="nx">_lExtras</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_walk</span><span class="p">(</span>
      <span class="kd">function</span><span class="p">(</span><span class="nx">_pPINIndex</span><span class="p">,</span> <span class="nx">_pPID</span><span class="p">)</span> <span class="p">{</span> <span class="nx">_lPIDs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">_pPID</span><span class="p">);</span> <span class="p">},</span>
      <span class="kd">function</span><span class="p">(</span><span class="nx">_pPINIndex</span><span class="p">,</span> <span class="nx">_pExtras</span><span class="p">)</span> <span class="p">{</span> <span class="nx">_lExtras</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">_pExtras</span><span class="p">);</span> <span class="p">});</span>
    <span class="kd">var</span> <span class="nx">lPINs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">_iP</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_iP</span> <span class="o">&lt;</span> <span class="nx">_lPIDs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_iP</span><span class="o">++</span><span class="p">)</span>
      <span class="nx">lPINs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">PIN</span><span class="p">([</span><span class="nx">_lPIDs</span><span class="p">[</span><span class="nx">_iP</span><span class="p">],</span> <span class="nx">pPINDescriptions</span><span class="p">[</span><span class="nx">_iP</span><span class="p">],</span> <span class="nx">_lExtras</span><span class="p">[</span><span class="nx">_iP</span><span class="p">]]));</span>
    <span class="k">return</span> <span class="nx">lPINs</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">private_PBResponseParser</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">finalizeUpdates</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pPINUpdates</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_lPIDs</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="kd">var</span> <span class="nx">_lPINs</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">var</span> <span class="nx">_iP</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">_iP</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_iP</span> <span class="o">&lt;</span> <span class="nx">pPINUpdates</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_iP</span><span class="o">++</span><span class="p">)</span>
      <span class="nx">_lPIDs</span><span class="p">[</span><span class="nx">pPINUpdates</span><span class="p">[</span><span class="nx">_iP</span><span class="p">].</span><span class="nx">getPID</span><span class="p">()]</span> <span class="o">=</span> <span class="nx">pPINUpdates</span><span class="p">[</span><span class="nx">_iP</span><span class="p">].</span><span class="nx">getPIN</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">_iP</span> <span class="k">in</span> <span class="nx">_lPIDs</span><span class="p">)</span>
      <span class="nx">_lPINs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">_lPIDs</span><span class="p">[</span><span class="nx">_iP</span><span class="p">]);</span>
    <span class="c1">//Interesting... when multiple updates are done on the same pin separately... review...</span>
    <span class="c1">//if (this.mParsed.pins.length != Object.keys(_lPIDs).length)</span>
    <span class="c1">//  console.log(&quot;WARNING: &quot; + Object.keys(_lPIDs).length + &quot; PINs were modified, but response contained &quot; + this.mParsed.pins.length + &quot; PINs.&quot;);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_walk</span><span class="p">(</span>
      <span class="kd">function</span><span class="p">(</span><span class="nx">_pPINIndex</span><span class="p">,</span> <span class="nx">_pPID</span><span class="p">)</span>
      <span class="p">{</span> 
        <span class="k">if</span> <span class="p">(</span><span class="nx">_pPINIndex</span> <span class="o">&gt;=</span> <span class="nx">pPINUpdates</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">pPINUpdates</span><span class="p">[</span><span class="nx">_pPINIndex</span><span class="p">].</span><span class="nx">getPID</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">_pPID</span><span class="p">)</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;WARNING (private_PBResponseParser.finalizeUpdates.lambda1): PID mismatch - expected &quot;</span> <span class="o">+</span> <span class="nx">pPINUpdates</span><span class="p">[</span><span class="nx">_pPINIndex</span><span class="p">].</span><span class="nx">getPID</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; but obtained &quot;</span> <span class="o">+</span> <span class="nx">_pPID</span><span class="p">);</span>
      <span class="p">},</span>
      <span class="kd">function</span><span class="p">(</span><span class="nx">_pPINIndex</span><span class="p">,</span> <span class="nx">_pExtras</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">_pPINIndex</span> <span class="o">&gt;=</span> <span class="nx">pPINUpdates</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>        
        <span class="kd">var</span> <span class="nx">__lExtras</span> <span class="o">=</span> <span class="nx">pPINUpdates</span><span class="p">[</span><span class="nx">_pPINIndex</span><span class="p">].</span><span class="nx">mPINAccessor</span><span class="p">().</span><span class="nx">mExtras</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">__iProp</span> <span class="k">in</span> <span class="nx">_pExtras</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">__iProp</span> <span class="k">in</span> <span class="nx">__lExtras</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">__lExtras</span><span class="p">[</span><span class="nx">__iProp</span><span class="p">]</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span>
            <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">__lExtras</span><span class="p">[</span><span class="nx">__iProp</span><span class="p">].</span><span class="nx">length</span> <span class="o">!=</span> <span class="nx">_pExtras</span><span class="p">[</span><span class="nx">__iProp</span><span class="p">].</span><span class="nx">length</span><span class="p">)</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;WARNING (private_PBResponseParser.finalizeUpdates.lambda2): collection length mismatch (&quot;</span> <span class="o">+</span> <span class="nx">__lExtras</span><span class="p">[</span><span class="nx">__iProp</span><span class="p">].</span><span class="nx">length</span> <span class="o">+</span> <span class="s2">&quot; vs &quot;</span> <span class="o">+</span> <span class="nx">_pExtras</span><span class="p">[</span><span class="nx">__iProp</span><span class="p">].</span><span class="nx">length</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span> <span class="p">);</span>
              <span class="k">else</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">__iEl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">__iEl</span> <span class="o">&lt;</span> <span class="nx">_pExtras</span><span class="p">[</span><span class="nx">__iProp</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span> <span class="nx">__iEl</span><span class="o">++</span><span class="p">)</span>
                <span class="p">{</span> <span class="nx">private_PBResponseParser</span><span class="p">.</span><span class="nx">_transferExtras</span><span class="p">(</span><span class="nx">__lExtras</span><span class="p">[</span><span class="nx">__iProp</span><span class="p">][</span><span class="nx">__iEl</span><span class="p">],</span> <span class="nx">_pExtras</span><span class="p">[</span><span class="nx">__iProp</span><span class="p">][</span><span class="nx">__iEl</span><span class="p">]);</span> <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span>
              <span class="p">{</span> <span class="nx">private_PBResponseParser</span><span class="p">.</span><span class="nx">_transferExtras</span><span class="p">(</span><span class="nx">__lExtras</span><span class="p">[</span><span class="nx">__iProp</span><span class="p">],</span> <span class="nx">_pExtras</span><span class="p">[</span><span class="nx">__iProp</span><span class="p">]);</span> <span class="p">}</span>
          <span class="p">}</span>
          <span class="k">else</span>
            <span class="p">{</span> <span class="nx">__lExtras</span><span class="p">[</span><span class="nx">__iProp</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_pExtras</span><span class="p">;</span> <span class="p">}</span>
        <span class="p">}</span> 
      <span class="p">});</span>
    <span class="k">return</span> <span class="nx">_lPINs</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">private_PBResponseParser</span><span class="p">.</span><span class="nx">_transferExtras</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pTo</span><span class="p">,</span> <span class="nx">pFrom</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="nx">pTo</span><span class="p">.</span><span class="nx">eid</span> <span class="o">=</span> <span class="nx">pFrom</span><span class="p">.</span><span class="nx">eid</span><span class="p">;</span>
    <span class="nx">pTo</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">pFrom</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">private_PBResponseParser</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_walk</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pProcessPID</span><span class="p">,</span> <span class="nx">pProcessExtras</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// Walk each parsed pin.</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">_iP</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_iP</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">mParsed</span><span class="p">.</span><span class="nx">pins</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_iP</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="c1">// Process the pid.</span>
      <span class="kd">var</span> <span class="nx">_lParsedPin</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">mParsed</span><span class="p">.</span><span class="nx">pins</span><span class="p">[</span><span class="nx">_iP</span><span class="p">];</span>
      <span class="nx">pProcessPID</span><span class="p">(</span><span class="nx">_iP</span><span class="p">,</span> <span class="nx">_lParsedPin</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

      <span class="c1">// Process the eids.</span>
      <span class="kd">var</span> <span class="nx">_lExtras</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">_iV</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_lParsedPin</span><span class="p">.</span><span class="nx">values</span> <span class="o">!=</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="nx">_iV</span> <span class="o">&lt;</span> <span class="nx">_lParsedPin</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_iV</span><span class="o">++</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">_lParsedValue</span> <span class="o">=</span> <span class="nx">_lParsedPin</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="nx">_iV</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">_lPropName</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">mPropDict</span><span class="p">.</span><span class="nx">getPropName</span><span class="p">(</span><span class="nx">_lParsedValue</span><span class="p">.</span><span class="nx">property</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;VT_ARRAY&#39;</span> <span class="o">==</span> <span class="nx">_lParsedValue</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="nx">_lExtras</span><span class="p">[</span><span class="nx">_lPropName</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">_iE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_iE</span> <span class="o">&lt;</span> <span class="nx">_lParsedValue</span><span class="p">.</span><span class="nx">varray</span><span class="p">.</span><span class="nx">l</span><span class="p">;</span> <span class="nx">_iE</span><span class="o">++</span><span class="p">)</span>
            <span class="nx">_lExtras</span><span class="p">[</span><span class="nx">_lPropName</span><span class="p">].</span><span class="nx">push</span><span class="p">({</span><span class="nx">eid</span><span class="o">:</span><span class="nx">_lParsedValue</span><span class="p">.</span><span class="nx">varray</span><span class="p">.</span><span class="nx">v</span><span class="p">[</span><span class="nx">_iE</span><span class="p">].</span><span class="nx">eid</span><span class="p">,</span> <span class="nx">type</span><span class="o">:</span><span class="nx">_lParsedValue</span><span class="p">.</span><span class="nx">varray</span><span class="p">.</span><span class="nx">v</span><span class="p">[</span><span class="nx">_iE</span><span class="p">].</span><span class="nx">type</span><span class="p">});</span>
        <span class="p">}</span>
        <span class="k">else</span>
          <span class="nx">_lExtras</span><span class="p">[</span><span class="nx">_lPropName</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nx">eid</span><span class="o">:</span><span class="nx">_lParsedValue</span><span class="p">.</span><span class="nx">eid</span><span class="p">,</span> <span class="nx">type</span><span class="o">:</span><span class="nx">_lParsedValue</span><span class="p">.</span><span class="nx">type</span><span class="p">};</span>
      <span class="p">}</span>
      <span class="nx">pProcessExtras</span><span class="p">(</span><span class="nx">_iP</span><span class="p">,</span> <span class="nx">_lExtras</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// Protobuf load: deserialize new PIN objects from their protobuf representation (obtained from mvstore, e.g. via mvsqlProto).</span>
  <span class="kd">function</span> <span class="nx">private_receivePB</span><span class="p">()</span> <span class="p">{}</span>
  <span class="nx">private_receivePB</span><span class="p">.</span><span class="nx">queryPINs</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pMvSql</span><span class="p">,</span> <span class="nx">pCallback</span><span class="p">,</span> <span class="nx">pOptions</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_lPD</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">private_PropDict</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">_lUrl</span> <span class="o">=</span> <span class="nx">appendUrlOptions</span><span class="p">(</span><span class="nx">lUri</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">+</span> <span class="s2">&quot;?q=&quot;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">pMvSql</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&amp;i=mvsql&amp;o=proto&quot;</span><span class="p">,</span> <span class="nx">pOptions</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">private_http</span><span class="p">(</span>
      <span class="nx">_lUrl</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span>
      <span class="kd">function</span><span class="p">(</span><span class="nx">_pE</span><span class="p">,</span> <span class="nx">_pR</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">_pE</span><span class="p">)</span> <span class="p">{</span> <span class="nx">pCallback</span><span class="p">(</span><span class="nx">_pE</span><span class="p">,</span> <span class="nx">_pR</span><span class="p">);</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span>
        <span class="nx">pCallback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">private_receivePB</span><span class="p">.</span><span class="nx">_createPINs</span><span class="p">(</span><span class="nx">_pR</span><span class="p">,</span> <span class="nx">_lPD</span><span class="p">));</span>
      <span class="p">});</span>
  <span class="p">}</span>
  <span class="nx">private_receivePB</span><span class="p">.</span><span class="nx">refreshPIN</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pPINAccessor</span><span class="p">,</span> <span class="nx">pCallback</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_lPD</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">private_PropDict</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">private_http</span><span class="p">(</span>
      <span class="nx">lUri</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">+</span> <span class="s2">&quot;?q=&quot;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM @&quot;</span> <span class="o">+</span> <span class="nx">pPINAccessor</span><span class="p">().</span><span class="nx">mPID</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&amp;i=mvsql&amp;o=proto&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span>
      <span class="kd">function</span><span class="p">(</span><span class="nx">_pE</span><span class="p">,</span> <span class="nx">_pR</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">_pE</span><span class="p">)</span> <span class="p">{</span> <span class="nx">pCallback</span><span class="p">(</span><span class="nx">_pE</span><span class="p">,</span> <span class="nx">_pR</span><span class="p">);</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span>
        <span class="nx">private_receivePB</span><span class="p">.</span><span class="nx">_refreshPINs</span><span class="p">(</span><span class="nx">_pR</span><span class="p">,</span> <span class="nx">_lPD</span><span class="p">,</span> <span class="p">[</span><span class="nx">pPINAccessor</span><span class="p">]);</span>
        <span class="nx">pCallback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">pPINAccessor</span><span class="p">().</span><span class="nx">mPIN</span><span class="p">);</span>
      <span class="p">});</span>
  <span class="p">}</span>
  <span class="nx">private_receivePB</span><span class="p">.</span><span class="nx">_createPINs</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pPB</span><span class="p">,</span> <span class="nx">pPropDict</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_lPINs</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">_lParsed</span> <span class="o">=</span> <span class="nx">lMvStream</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">pPB</span><span class="p">);</span>
    <span class="c1">// Note:</span>
    <span class="c1">//   _lParsed is a javascript object resulting from protobuf_for_node&#39;s parsing of the raw protobuf buffer</span>
    <span class="c1">//   returned by mvstore; it should represent a whole PIN (i.e. all of its properties), and should look like this:</span>
    <span class="c1">//   { </span>
    <span class="c1">//     &quot;owner&quot;:{&quot;str&quot;:&quot;&quot;,&quot;id&quot;:0},</span>
    <span class="c1">//     &quot;pins&quot;:[{&quot;id&quot;:{&quot;id&quot;:327681},&quot;nValues&quot;:4,&quot;values&quot;:[{&quot;type&quot;:&quot;VT_STRING&quot;,&quot;property&quot;:256,&quot;str&quot;:&quot;whatever&quot;},{&quot;type&quot;:&quot;VT_DOUBLE&quot;,&quot;property&quot;:257,&quot;d&quot;:123},{&quot;type&quot;:&quot;VT_DATETIME&quot;,&quot;property&quot;:258,&quot;datetime&quot;:12956767059615000},{&quot;type&quot;:&quot;VT_ARRAY&quot;,&quot;property&quot;:259,&quot;varray&quot;:{&quot;l&quot;:4,&quot;v&quot;:[{&quot;type&quot;:&quot;VT_DOUBLE&quot;,&quot;d&quot;:1,&quot;eid&quot;:0},{&quot;type&quot;:&quot;VT_DOUBLE&quot;,&quot;d&quot;:2,&quot;eid&quot;:1},{&quot;type&quot;:&quot;VT_DOUBLE&quot;,&quot;d&quot;:3,&quot;eid&quot;:2},{&quot;type&quot;:&quot;VT_DOUBLE&quot;,&quot;d&quot;:4,&quot;eid&quot;:3}]}}]}],</span>
    <span class="c1">//     &quot;properties&quot;:[{&quot;str&quot;:&quot;toto&quot;,&quot;id&quot;:256},{&quot;str&quot;:&quot;tata&quot;,&quot;id&quot;:257},{&quot;str&quot;:&quot;titi&quot;,&quot;id&quot;:258},{&quot;str&quot;:&quot;tutu&quot;,&quot;id&quot;:259}],</span>
    <span class="c1">//     &quot;result&quot;:[{&quot;count&quot;:1}]</span>
    <span class="c1">//   }</span>
    <span class="c1">// dbg_savePBStr(pPB);</span>
    <span class="c1">// console.log(&quot;private_receivePB._createPINs: _lParsed=&quot; + JSON.stringify(_lParsed));</span>
    <span class="nx">pPropDict</span><span class="p">.</span><span class="nx">registerProps</span><span class="p">(</span><span class="nx">_lParsed</span><span class="p">.</span><span class="nx">properties</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">_iO</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_iO</span> <span class="o">&lt;</span> <span class="nx">_lParsed</span><span class="p">.</span><span class="nx">pins</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_iO</span><span class="o">++</span><span class="p">)</span>
      <span class="nx">_lPINs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">PIN</span><span class="p">(</span><span class="nx">private_receivePB</span><span class="p">.</span><span class="nx">_extractPIN</span><span class="p">(</span><span class="nx">_lParsed</span><span class="p">.</span><span class="nx">pins</span><span class="p">[</span><span class="nx">_iO</span><span class="p">],</span> <span class="nx">pPropDict</span><span class="p">)));</span>
    <span class="k">return</span> <span class="nx">_lPINs</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">private_receivePB</span><span class="p">.</span><span class="nx">_refreshPINs</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pPB</span><span class="p">,</span> <span class="nx">pPropDict</span><span class="p">,</span> <span class="nx">pPINAccessors</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_lParsed</span> <span class="o">=</span> <span class="nx">lMvStream</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">pPB</span><span class="p">);</span>
    <span class="c1">// Note: See the note on _lParsed in private_receivePB._createPINs.</span>
    <span class="c1">// console.log(&quot;private_receivePB._refreshPINs: _lParsed=&quot; + JSON.stringify(_lParsed));</span>
    <span class="nx">pPropDict</span><span class="p">.</span><span class="nx">registerProps</span><span class="p">(</span><span class="nx">_lParsed</span><span class="p">.</span><span class="nx">properties</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">_lParsed</span><span class="p">.</span><span class="nx">pins</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="nx">pPINAccessors</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;WARNING (private_receivePB._refreshPINs): &quot;</span> <span class="o">+</span> <span class="nx">pPINAccessors</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="s2">&quot; PINs were refreshed, but mvstore&#39;s response contained &quot;</span> <span class="o">+</span> <span class="nx">_lParsed</span><span class="p">.</span><span class="nx">pins</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="s2">&quot; PINs.&quot;</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">_iO</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_iO</span> <span class="o">&lt;</span> <span class="nx">_lParsed</span><span class="p">.</span><span class="nx">pins</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_iO</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">_lPinAttrs</span> <span class="o">=</span> <span class="nx">private_receivePB</span><span class="p">.</span><span class="nx">_extractPIN</span><span class="p">(</span><span class="nx">_lParsed</span><span class="p">.</span><span class="nx">pins</span><span class="p">[</span><span class="nx">_iO</span><span class="p">],</span> <span class="nx">pPropDict</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">_lPINa</span> <span class="o">=</span> <span class="nx">pPINAccessors</span><span class="p">[</span><span class="nx">_iO</span><span class="p">]();</span>
      <span class="kd">var</span> <span class="nx">_iPV</span><span class="p">,</span> <span class="nx">_iE</span><span class="p">;</span>
      <span class="c1">// Clear the old PIN.</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">_iPV</span> <span class="k">in</span> <span class="nx">_lPINa</span><span class="p">.</span><span class="nx">mPropVals</span><span class="p">)</span> <span class="p">{</span> <span class="k">delete</span> <span class="nx">_lPINa</span><span class="p">.</span><span class="nx">mPropVals</span><span class="p">[</span><span class="nx">_iPV</span><span class="p">];</span> <span class="p">}</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">_iE</span> <span class="k">in</span> <span class="nx">_lPINa</span><span class="p">.</span><span class="nx">mExtras</span><span class="p">)</span> <span class="p">{</span> <span class="k">delete</span> <span class="nx">_lPINa</span><span class="p">.</span><span class="nx">mExtras</span><span class="p">[</span><span class="nx">_iE</span><span class="p">];</span> <span class="p">}</span>
      <span class="c1">// Set its new attributes.</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">_iPV</span> <span class="k">in</span> <span class="nx">_lPinAttrs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span> <span class="nx">_lPINa</span><span class="p">.</span><span class="nx">mPropVals</span><span class="p">[</span><span class="nx">_iPV</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_lPinAttrs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="nx">_iPV</span><span class="p">];</span> <span class="p">}</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">_iE</span> <span class="k">in</span> <span class="nx">_lPinAttrs</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span> <span class="nx">_lPINa</span><span class="p">.</span><span class="nx">mExtras</span><span class="p">[</span><span class="nx">_iE</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_lPinAttrs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="nx">_iE</span><span class="p">];</span> <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nx">private_receivePB</span><span class="p">.</span><span class="nx">_extractPIN</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pPBPIN</span><span class="p">,</span> <span class="nx">pPropDict</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// Convert pPBPIN, a js object that complies with the protobuf format (direct fruit of protobuf_for_node deserialization)</span>
    <span class="c1">// into the elements required to create an instance of our PIN class.</span>
    <span class="kd">var</span> <span class="nx">_lPropVals</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="kd">var</span> <span class="nx">_lExtras</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;values&quot;</span> <span class="k">in</span> <span class="nx">pPBPIN</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">_iProp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_iProp</span> <span class="o">&lt;</span> <span class="nx">pPBPIN</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_iProp</span><span class="o">++</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">_lPBValue</span> <span class="o">=</span> <span class="nx">pPBPIN</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="nx">_iProp</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">_lPropName</span> <span class="o">=</span> <span class="nx">pPropDict</span><span class="p">.</span><span class="nx">getPropName</span><span class="p">(</span><span class="nx">_lPBValue</span><span class="p">.</span><span class="nx">property</span><span class="p">);</span>
        <span class="nx">_lPropVals</span><span class="p">[</span><span class="nx">_lPropName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">private_receivePB</span><span class="p">.</span><span class="nx">_extractValue</span><span class="p">(</span><span class="nx">_lPBValue</span><span class="p">,</span> <span class="nx">pPropDict</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;VT_ARRAY&#39;</span> <span class="o">==</span> <span class="nx">_lPBValue</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="nx">_lExtras</span><span class="p">[</span><span class="nx">_lPropName</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">_iE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">_iE</span> <span class="o">&lt;</span> <span class="nx">_lPBValue</span><span class="p">.</span><span class="nx">varray</span><span class="p">.</span><span class="nx">l</span><span class="p">;</span> <span class="nx">_iE</span><span class="o">++</span><span class="p">)</span>
            <span class="p">{</span> <span class="nx">_lExtras</span><span class="p">[</span><span class="nx">_lPropName</span><span class="p">].</span><span class="nx">push</span><span class="p">({</span><span class="nx">eid</span><span class="o">:</span><span class="nx">_lPBValue</span><span class="p">.</span><span class="nx">varray</span><span class="p">.</span><span class="nx">v</span><span class="p">[</span><span class="nx">_iE</span><span class="p">].</span><span class="nx">eid</span><span class="p">,</span> <span class="nx">type</span><span class="o">:</span><span class="nx">_lPBValue</span><span class="p">.</span><span class="nx">varray</span><span class="p">.</span><span class="nx">v</span><span class="p">[</span><span class="nx">_iE</span><span class="p">].</span><span class="nx">type</span><span class="p">});</span> <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> 
          <span class="p">{</span> <span class="nx">_lExtras</span><span class="p">[</span><span class="nx">_lPropName</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nx">eid</span><span class="o">:</span><span class="nx">_lPBValue</span><span class="p">.</span><span class="nx">eid</span><span class="p">,</span> <span class="nx">type</span><span class="o">:</span><span class="nx">_lPBValue</span><span class="p">.</span><span class="nx">type</span><span class="p">};</span> <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">[</span><span class="nx">pPBPIN</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">_lPropVals</span><span class="p">,</span> <span class="nx">_lExtras</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="nx">private_receivePB</span><span class="p">.</span><span class="nx">_extractValue</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">pPBValue</span><span class="p">,</span> <span class="nx">pPropDict</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// TODO: Go over python/mvstore.py::_valuePB2PY and make sure everything is coverered...</span>
    <span class="k">switch</span> <span class="p">(</span><span class="nx">pPBValue</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">case</span> <span class="s1">&#39;VT_BOOL&#39;</span><span class="o">:</span> <span class="k">return</span> <span class="nx">pPBValue</span><span class="p">.</span><span class="nx">b</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;VT_DOUBLE&#39;</span><span class="o">:</span> <span class="k">return</span> <span class="nx">pPBValue</span><span class="p">.</span><span class="nx">d</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;VT_STRING&#39;</span><span class="o">:</span> <span class="k">return</span> <span class="nx">pPBValue</span><span class="p">.</span><span class="nx">str</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;VT_URL&#39;</span><span class="o">:</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">Url</span><span class="p">(</span><span class="nx">pPBValue</span><span class="p">.</span><span class="nx">str</span><span class="p">);</span>
      <span class="k">case</span> <span class="s1">&#39;VT_BSTR&#39;</span><span class="o">:</span> <span class="k">return</span> <span class="nx">pPBValue</span><span class="p">.</span><span class="nx">bstr</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;VT_INT&#39;</span><span class="o">:</span> <span class="k">return</span> <span class="nx">pPBValue</span><span class="p">.</span><span class="nx">i</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;VT_UINT&#39;</span><span class="o">:</span> <span class="k">return</span> <span class="nx">pPBValue</span><span class="p">.</span><span class="nx">ui</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;VT_INT64&#39;</span><span class="o">:</span> <span class="k">return</span> <span class="nx">pPBValue</span><span class="p">.</span><span class="nx">i64</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;VT_UINT64&#39;</span><span class="o">:</span> <span class="k">return</span> <span class="nx">pPBValue</span><span class="p">.</span><span class="nx">ui64</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;VT_FLOAT&#39;</span><span class="o">:</span> <span class="k">return</span> <span class="nx">pPBValue</span><span class="p">.</span><span class="nx">f</span><span class="p">;</span>
      <span class="k">case</span> <span class="s1">&#39;VT_INTERVAL&#39;</span><span class="o">:</span> <span class="k">return</span> <span class="nx">pPBValue</span><span class="p">.</span><span class="nx">interval</span><span class="p">;</span> <span class="c1">// xxx</span>
      <span class="k">case</span> <span class="s1">&#39;VT_ARRAY&#39;</span><span class="o">:</span>
      <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">_lValues</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">()</span>
        <span class="nx">pPBValue</span><span class="p">.</span><span class="nx">varray</span><span class="p">.</span><span class="nx">v</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">_pEl</span><span class="p">)</span> <span class="p">{</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">push</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">_lValues</span><span class="p">,</span> <span class="nx">private_receivePB</span><span class="p">.</span><span class="nx">_extractValue</span><span class="p">(</span><span class="nx">_pEl</span><span class="p">));</span> <span class="p">});</span>
        <span class="k">return</span> <span class="nx">_lValues</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="s1">&#39;VT_DATETIME&#39;</span><span class="o">:</span> <span class="k">return</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">((</span><span class="nx">pPBValue</span><span class="p">.</span><span class="nx">datetime</span> <span class="o">-</span> <span class="nx">MV_TIME_OFFSET</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
      <span class="k">case</span> <span class="s1">&#39;VT_REFID&#39;</span><span class="o">:</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">Ref</span><span class="p">(</span><span class="nx">pPBValue</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">pPBValue</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">ident</span><span class="p">);</span>
      <span class="k">case</span> <span class="s1">&#39;VT_REFIDPROP&#39;</span><span class="o">:</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">Ref</span><span class="p">(</span><span class="nx">pPBValue</span><span class="p">.</span><span class="nx">ref</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">pPBValue</span><span class="p">.</span><span class="nx">ref</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">ident</span><span class="p">,</span> <span class="nx">pPropDict</span><span class="p">.</span><span class="nx">getPropName</span><span class="p">(</span><span class="nx">pPBValue</span><span class="p">.</span><span class="nx">ref</span><span class="p">.</span><span class="nx">property</span><span class="p">));</span>
      <span class="k">case</span> <span class="s1">&#39;VT_REFIDELT&#39;</span><span class="o">:</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">Ref</span><span class="p">(</span><span class="nx">pPBValue</span><span class="p">.</span><span class="nx">ref</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">pPBValue</span><span class="p">.</span><span class="nx">ref</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">ident</span><span class="p">,</span> <span class="nx">pPropDict</span><span class="p">.</span><span class="nx">getPropName</span><span class="p">(</span><span class="nx">pPBValue</span><span class="p">.</span><span class="nx">ref</span><span class="p">.</span><span class="nx">property</span><span class="p">),</span> <span class="nx">pPBValue</span><span class="p">.</span><span class="nx">ref</span><span class="p">.</span><span class="nx">eid</span><span class="p">);</span>
      <span class="k">default</span><span class="o">:</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * Public interface.</span>
<span class="cm">   */</span>

  <span class="c1">// Main, self-sufficient mvsql interface (json output).</span>
  <span class="c1">// TODO: Maybe integrate a more automatic means of handling pagination (i.e. always paginate).</span>
  <span class="kd">function</span> <span class="nx">mvsql</span><span class="p">(</span><span class="nx">_pMvSql</span><span class="p">,</span> <span class="nx">_pCallback</span><span class="p">,</span> <span class="nx">_pOptions</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">inExplicitTx</span><span class="p">())</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;WARNING (mvsql): mvsql calls can&#39;t participate to protobuf transactions at the moment; use mvsqlProto instead.&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">private_http</span><span class="p">(</span><span class="nx">appendUrlOptions</span><span class="p">(</span><span class="nx">lUri</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">+</span> <span class="s2">&quot;?q=&quot;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">_pMvSql</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&amp;i=mvsql&amp;o=json&quot;</span><span class="p">,</span> <span class="nx">_pOptions</span><span class="p">),</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">_pCallback</span><span class="p">);</span> 
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">mvsqlCount</span><span class="p">(</span><span class="nx">_pMvSql</span><span class="p">,</span> <span class="nx">_pCallback</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">inExplicitTx</span><span class="p">())</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;WARNING (mvsqlCount): mvsqlCount calls can&#39;t participate to protobuf transactions at the moment; use mvsqlProto instead.&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">private_http</span><span class="p">(</span><span class="nx">lUri</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">+</span> <span class="s2">&quot;?q=&quot;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">_pMvSql</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&amp;i=mvsql&amp;o=json&amp;type=count&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">_pCallback</span><span class="p">);</span> 
  <span class="p">}</span>

  <span class="c1">// Auxiliary protobuf enhancers.</span>
  <span class="c1">// Notes:</span>
  <span class="c1">//   Motivations for these enhancers include the following:</span>
  <span class="c1">//   1. we have no json-in presently;</span>
  <span class="c1">//   2. js objects are natural carriers for PINs (e.g. query results);</span>
  <span class="c1">//   3. as shown by the python lib, this can reduce considerably the need for ORM translations.</span>
  <span class="c1">//   Perf remains to be analyzed in detail (protobuf_for_node, object copies etc.).</span>
  <span class="c1">//   I like the notion of separate &#39;PIN&#39; objects (*not* meant to be the base-class of</span>
  <span class="c1">//   application&#39;s object structure), just like in C++ and python (it&#39;s unambiguous what needs to be saved etc.).</span>
  <span class="kd">function</span> <span class="nx">mvsqlProto</span><span class="p">(</span><span class="nx">_pMvSql</span><span class="p">,</span> <span class="nx">_pCallback</span><span class="p">,</span> <span class="nx">_pOptions</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// Same as the &#39;mvsql&#39; public service, except that here we go through protobuf, and we return PIN objects (see js class definition above)</span>
    <span class="c1">// back to _pCallback (instead of json). Could be preferred for perf reasons, or to avoid loss of information,</span>
    <span class="c1">// or to work with PIN objects in an end-to-end manner, or to work within the context of a protobuf transaction.</span>

    <span class="c1">// Implicit transaction: don&#39;t bother with txctx or long http request.</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">inExplicitTx</span><span class="p">())</span>
      <span class="k">return</span> <span class="nx">private_receivePB</span><span class="p">.</span><span class="nx">queryPINs</span><span class="p">(</span><span class="nx">_pMvSql</span><span class="p">,</span> <span class="nx">_pCallback</span><span class="p">,</span> <span class="nx">_pOptions</span><span class="p">);</span>

    <span class="c1">// Within the context of an already running explicit transaction...</span>
    <span class="kd">var</span> <span class="nx">_lOpEnd</span> <span class="o">=</span> <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">beginOp</span><span class="p">(</span><span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">makeHandler_onReceivePINs</span><span class="p">({</span><span class="nx">txend</span><span class="o">:</span><span class="nx">_pCallback</span><span class="p">}),</span> <span class="p">{</span><span class="nx">mustFlush</span><span class="o">:</span><span class="kc">true</span><span class="p">});</span>
    <span class="k">if</span> <span class="p">(</span><span class="kc">undefined</span> <span class="o">!=</span> <span class="nx">_lOpEnd</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">lTxCtx</span><span class="p">.</span><span class="nx">recordAny</span><span class="p">({</span><span class="nx">stmt</span><span class="o">:</span><span class="p">[{</span><span class="nx">sq</span><span class="o">:</span><span class="nx">_pMvSql</span><span class="p">,</span> <span class="nx">cid</span><span class="o">:</span><span class="nx">lNextCid</span><span class="o">++</span><span class="p">,</span> <span class="nx">rtt</span><span class="o">:</span><span class="s1">&#39;RT_PINS&#39;</span><span class="p">,</span> <span class="nx">offset</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span> <span class="nx">limit</span><span class="o">:</span><span class="mi">9999</span><span class="cm">/*REVIEW*/</span><span class="p">}]});</span>
      <span class="nx">_lOpEnd</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">createPINs</span><span class="p">(</span><span class="nx">_pPINDescriptions</span><span class="p">,</span> <span class="nx">_pCallback</span><span class="p">)</span> 
  <span class="p">{</span>
    <span class="c1">// _pPINDescriptions is expected to be an array of js object literals describing new PINs, e.g.</span>
    <span class="c1">// {prop1:value1, prop2:value2, prop3:[el1, el2, el3], etc.}; _pCallback is invoked with</span>
    <span class="c1">// the resulting array of PIN objects (see js class definition above).</span>
    <span class="c1">// Note: Unlike in python, _pPINDescriptions initially has no &#39;extras&#39; specified (this is a pure PIN creation).</span>

    <span class="c1">// Implicit transaction: don&#39;t bother with txctx or long http request.</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">inExplicitTx</span><span class="p">())</span>
      <span class="k">return</span> <span class="nx">private_sendPB</span><span class="p">(</span><span class="nx">_pPINDescriptions</span><span class="p">,</span> <span class="nx">_pCallback</span><span class="p">,</span> <span class="s2">&quot;createPINs&quot;</span><span class="p">);</span>

    <span class="c1">// Within the context of an already running explicit transaction...</span>
    <span class="kd">var</span> <span class="nx">_lOpEnd</span> <span class="o">=</span> <span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">beginOp</span><span class="p">(</span><span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">makeHandler_onNewPIDs</span><span class="p">(</span><span class="nx">_pPINDescriptions</span><span class="p">,</span> <span class="p">{</span><span class="nx">txend</span><span class="o">:</span><span class="nx">_pCallback</span><span class="p">}),</span> <span class="p">{</span><span class="nx">mustFlush</span><span class="o">:</span><span class="kc">true</span><span class="p">});</span>
    <span class="k">if</span> <span class="p">(</span><span class="kc">undefined</span> <span class="o">!=</span> <span class="nx">_lOpEnd</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">_lPD</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">private_PropDict</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">_lPins</span> <span class="o">=</span> <span class="nx">private_sendPB</span><span class="p">.</span><span class="nx">formatPB</span><span class="p">(</span><span class="nx">_pPINDescriptions</span><span class="p">,</span> <span class="nx">_lPD</span><span class="p">);</span>
      <span class="nx">lTxCtx</span><span class="p">.</span><span class="nx">recordAny</span><span class="p">([{</span><span class="nx">properties</span><span class="o">:</span><span class="nx">_lPD</span><span class="p">.</span><span class="nx">getPBRepr</span><span class="p">()},</span> <span class="p">{</span><span class="nx">pins</span><span class="o">:</span><span class="nx">_lPins</span><span class="p">}]);</span>
      <span class="nx">_lOpEnd</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">startTx</span><span class="p">(</span><span class="nx">_pTxLabel</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// Note: private_TxCtx takes care of unsetting itself from lTxCtx upon completion of an outermost transaction.</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">inExplicitTx</span><span class="p">())</span>
      <span class="nx">lTxCtx</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">private_TxCtx</span><span class="p">();</span>
    <span class="nx">lTxCtx</span><span class="p">.</span><span class="nx">startTx</span><span class="p">(</span><span class="nx">_pTxLabel</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">commitTx</span><span class="p">(</span><span class="nx">_pCallback</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">inExplicitTx</span><span class="p">())</span>
      <span class="k">throw</span> <span class="s2">&quot;commitTx: called outside of a transaction&quot;</span><span class="p">;</span>
    <span class="nx">lTxCtx</span><span class="p">.</span><span class="nx">commitTx</span><span class="p">(</span><span class="nx">_pCallback</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">rollbackTx</span><span class="p">(</span><span class="nx">_pCallback</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">private_TxCtx</span><span class="p">.</span><span class="nx">inExplicitTx</span><span class="p">())</span>
      <span class="k">throw</span> <span class="s2">&quot;rollbackTx: called outside of a transaction&quot;</span><span class="p">;</span>
    <span class="nx">lTxCtx</span><span class="p">.</span><span class="nx">rollbackTx</span><span class="p">(</span><span class="nx">_pCallback</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// ---</span>
  <span class="kd">function</span> <span class="nx">terminate</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">lKeepAlive</span><span class="p">.</span><span class="nx">on</span> <span class="o">&amp;&amp;</span> <span class="kc">undefined</span> <span class="o">!=</span> <span class="nx">lKeepAlive</span><span class="p">.</span><span class="nx">client</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="nx">lKeepAlive</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
      <span class="nx">lKeepAlive</span><span class="p">.</span><span class="nx">client</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">//---</span>
  <span class="kd">var</span> <span class="nx">lConnection</span> <span class="o">=</span>
  <span class="p">{</span>
    <span class="nx">keptAlive</span><span class="o">:</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="nx">lKeepAlive</span><span class="p">.</span><span class="nx">on</span><span class="p">;},</span>
    <span class="nx">mvsql</span><span class="o">:</span> <span class="nx">mvsql</span><span class="p">,</span> <span class="nx">mvsqlCount</span><span class="o">:</span> <span class="nx">mvsqlCount</span><span class="p">,</span>
    <span class="nx">mvsqlProto</span><span class="o">:</span><span class="nx">mvsqlProto</span><span class="p">,</span> <span class="nx">createPINs</span><span class="o">:</span><span class="nx">createPINs</span><span class="p">,</span>
    <span class="nx">startTx</span><span class="o">:</span><span class="nx">startTx</span><span class="p">,</span> <span class="nx">commitTx</span><span class="o">:</span><span class="nx">commitTx</span><span class="p">,</span> <span class="nx">rollbackTx</span><span class="o">:</span><span class="nx">rollbackTx</span><span class="p">,</span>
    <span class="nx">makeUrl</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">_pString</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="k">new</span> <span class="nx">Url</span><span class="p">(</span><span class="nx">_pString</span><span class="p">);},</span>
    <span class="nx">makeRef</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">_pLocalPID</span><span class="p">,</span> <span class="nx">_pIdent</span><span class="p">,</span> <span class="nx">_pProperty</span><span class="p">,</span> <span class="nx">_pEid</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="k">new</span> <span class="nx">Ref</span><span class="p">(</span><span class="nx">_pLocalPID</span><span class="p">,</span> <span class="nx">_pIdent</span><span class="p">,</span> <span class="nx">_pProperty</span><span class="p">,</span> <span class="nx">_pEid</span><span class="p">);},</span> 
    <span class="nx">terminate</span><span class="o">:</span><span class="nx">terminate</span><span class="p">,</span>
  <span class="p">};</span>
  <span class="k">return</span> <span class="nx">lConnection</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// TODO: add a guard to the public interface, to warn against attempting to do concurrent things in a connection</span>
<span class="c1">// TODO: in keepalive mode, should better integrate pure mvsql transactions with startTx-commitTx (Ming&#39;s argument).</span>
</pre></div>
<!-- end highlighted code -->

</div>
