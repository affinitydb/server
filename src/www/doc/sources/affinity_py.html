<head>
  <link href='../css/afydoc.css' rel='stylesheet' type='text/css' />
  <link href='../css/source.css' rel='stylesheet' type='text/css' />
</head>
<div id="affinity_py">
<h1>affinity.py</h1>

<!-- begin highlighted code -->
<div class="highlight"><pre><span class="c">#!/usr/bin/env python2.6</span>
<span class="c"># Copyright (c) 2004-2013 GoPivotal, Inc. All Rights Reserved.</span>
<span class="c">#</span>
<span class="c">#    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c">#    you may not use this file except in compliance with the License.</span>
<span class="c">#    You may obtain a copy of the License at</span>
<span class="c">#</span>
<span class="c">#        http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c">#</span>
<span class="c"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,  WITHOUT</span>
<span class="c"># WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the</span>
<span class="c"># License for the specific language governing permissions and limitations</span>
<span class="c"># under the License.</span>
<span class="c"># -----</span>
<span class="sd">&quot;&quot;&quot;This module defines the key components of Affinity&#39;s low-level client library in python:</span>
<span class="sd">AffinityConnection and PIN (including PIN.PID and PIN.Collection).</span>
<span class="sd">The library talks to the store via pathSQL and protobuf exclusively.</span>
<span class="sd">When the affinityinproc module is in the path, and AffinityConnection.DEFAULT_INPROC is True,</span>
<span class="sd">the library talks to an in-proc store. Otherwise, it uses HTTP to reach the Affinity server.</span>
<span class="sd">Please read the documentation of each component for more details.&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">with_statement</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">MutableSequence</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">httplib</span> <span class="c"># python2</span>
<span class="k">except</span><span class="p">:</span>    
    <span class="kn">import</span> <span class="nn">http</span> <span class="kn">as</span> <span class="nn">httplib</span> <span class="c"># python3</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">affinity_pb2</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">affinityinproc</span> <span class="c"># Optional (for inproc execution of Affinity; see the &#39;ext&#39; subdirectory).</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">urllib2</span>
<span class="kn">import</span> <span class="nn">urllib</span>

<span class="c"># For AfyHTTPResponse.</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">cStringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">StringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>

<span class="c"># Workaround (these enum values can&#39;t be provided by affinity.proto).</span>
<span class="n">EID_COLLECTION</span> <span class="o">=</span> <span class="mi">4294967295</span>
<span class="n">EID_LAST_ELEMENT</span> <span class="o">=</span> <span class="mi">4294967294</span>
<span class="n">EID_FIRST_ELEMENT</span> <span class="o">=</span> <span class="mi">4294967293</span>

<span class="c"># Names for special properties.</span>
<span class="n">SP_PROPERTY_NAMES</span> <span class="o">=</span> \
<span class="p">{</span> \
    <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">SP_PINID</span><span class="p">:</span><span class="s">&quot;afy:pinID&quot;</span><span class="p">,</span> \
    <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">SP_DOCUMENT</span><span class="p">:</span><span class="s">&quot;afy:document&quot;</span><span class="p">,</span> \
    <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">SP_PARENT</span><span class="p">:</span><span class="s">&quot;afy:parent&quot;</span><span class="p">,</span> \
    <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">SP_VALUE</span><span class="p">:</span><span class="s">&quot;afy:value&quot;</span><span class="p">,</span> \
    <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">SP_CREATED</span><span class="p">:</span><span class="s">&quot;afy:created&quot;</span><span class="p">,</span> \
    <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">SP_CREATEDBY</span><span class="p">:</span><span class="s">&quot;afy:createdBy&quot;</span><span class="p">,</span> \
    <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">SP_UPDATED</span><span class="p">:</span><span class="s">&quot;afy:updated&quot;</span><span class="p">,</span> \
    <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">SP_UPDATEDBY</span><span class="p">:</span><span class="s">&quot;afy:updatedBy&quot;</span><span class="p">,</span> \
    <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">SP_ACL</span><span class="p">:</span><span class="s">&quot;afy:ACL&quot;</span><span class="p">,</span> \
    <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">SP_STAMP</span><span class="p">:</span><span class="s">&quot;afy:stamp&quot;</span><span class="p">,</span> \
    <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">SP_OBJID</span><span class="p">:</span><span class="s">&quot;afy:objectID&quot;</span><span class="p">,</span> \
    <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">SP_PREDICATE</span><span class="p">:</span><span class="s">&quot;afy:predicate&quot;</span><span class="p">,</span> \
    <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">SP_COUNT</span><span class="p">:</span><span class="s">&quot;afy:count&quot;</span><span class="p">,</span> \
    <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">SP_SUBCLASSES</span><span class="p">:</span><span class="s">&quot;afy:subclasses&quot;</span><span class="p">,</span> \
    <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">SP_SUPERCLASSES</span><span class="p">:</span><span class="s">&quot;afy:superclasses&quot;</span><span class="p">,</span> \
    <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">SP_INDEX_INFO</span><span class="p">:</span><span class="s">&quot;afy:indexInfo&quot;</span><span class="p">,</span> \
    <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">SP_PROPERTIES</span><span class="p">:</span><span class="s">&quot;afy:properties&quot;</span><span class="p">,</span> \
    <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">SP_ONENTER</span><span class="p">:</span><span class="s">&quot;afy:onEnter&quot;</span><span class="p">,</span> \
    <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">SP_ONUPDATE</span><span class="p">:</span><span class="s">&quot;afy:onUpdate&quot;</span><span class="p">,</span> \
    <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">SP_ONLEAVE</span><span class="p">:</span><span class="s">&quot;afy:onLeave&quot;</span>
    <span class="c"># TODO: catch-up with latest stuff...</span>
<span class="p">}</span>    

<span class="c"># Internal logging.</span>
<span class="k">def</span> <span class="nf">configureAfyLogging</span><span class="p">():</span>
    <span class="s">&quot;Configure the logging behavior of this module.&quot;</span>
    <span class="n">lFormat</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%(asctime)s</span><span class="s">|</span><span class="si">%(levelname)s</span><span class="s">|</span><span class="si">%(filename)s</span><span class="s">|</span><span class="si">%(funcName)s</span><span class="s">(): </span><span class="si">%(message)s</span><span class="s"> [tid=</span><span class="si">%(thread)d</span><span class="s">]&#39;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s">&#39;affinity.pylog&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">WARN</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">lFormat</span><span class="p">)</span>
    <span class="n">lConsole</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
    <span class="n">lConsole</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARN</span><span class="p">)</span>
    <span class="n">lConsole</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="n">lFormat</span><span class="p">))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">lConsole</span><span class="p">)</span>
<span class="n">configureAfyLogging</span><span class="p">()</span> <span class="c"># Review: May remove this by default (arguably belongs to the app).</span>

<span class="c"># Misc. Helpers.</span>
<span class="k">def</span> <span class="nf">displayPBStr</span><span class="p">(</span><span class="n">pPBStr</span><span class="p">,</span> <span class="n">pTitle</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="s">&quot;[internal] Invoke the command-line &#39;protoc --decode&#39; to produce a readable form of the pPBStr serialized protobuf string.&quot;</span>
    <span class="n">lP</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s">&quot;protoc&quot;</span><span class="p">,</span> <span class="s">&quot;--decode=AffinityPB.AfyStream&quot;</span><span class="p">,</span> <span class="s">&quot;--proto_path=../kernel/src/&quot;</span><span class="p">,</span> <span class="s">&quot;../kernel/src/affinity.proto&quot;</span><span class="p">],</span> <span class="n">shell</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="c">#lP = subprocess.Popen([&quot;protoc&quot;, &quot;--decode_raw&quot;], shell=False, stdout=subprocess.PIPE, stdin=subprocess.PIPE)</span>
    <span class="n">lOut</span> <span class="o">=</span> <span class="n">lP</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">pPBStr</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c">#lOut = filter(lambda c: c==&quot; &quot; or c not in string.whitespace, lOut) # Keep spaces but not crlf, tabs etc.</span>
    <span class="k">if</span> <span class="n">pTitle</span><span class="p">:</span>
        <span class="k">print</span> <span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pTitle</span><span class="p">,</span> <span class="n">lOut</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="p">(</span><span class="n">lOut</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">savePBStr</span><span class="p">(</span><span class="n">pPBStr</span><span class="p">,</span> <span class="n">pOutputFileName</span><span class="p">):</span>
    <span class="s">&quot;[internal] Save the pPBStr serialized protobuf string to a binary file pOutputFileName.&quot;</span>
    <span class="n">lF</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">pOutputFileName</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span>
    <span class="n">lF</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pPBStr</span><span class="p">)</span>
    <span class="n">lF</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">parsePBStr</span><span class="p">(</span><span class="n">pPBStr</span><span class="p">):</span>
    <span class="s">&quot;[internal] Parse the raw pPBStr and returned the resulting protobuf structure.&quot;</span>
    <span class="n">lPBStream</span> <span class="o">=</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">AfyStream</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">lPBStream</span><span class="o">.</span><span class="n">ParseFromString</span><span class="p">(</span><span class="n">pPBStr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lPBStream</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">print</span> <span class="p">(</span><span class="s">&quot;***&quot;</span><span class="p">)</span>
        <span class="k">print</span> <span class="p">(</span><span class="s">&quot;*** EXCEPTION CAUGHT in ParseFromString:</span><span class="se">\n</span><span class="s">***   </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">ex</span><span class="p">)</span>
        <span class="k">print</span> <span class="p">(</span><span class="s">&quot;***   waiting for 5 seconds...&quot;</span><span class="p">);</span> <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span> <span class="n">savePBStr</span><span class="p">(</span><span class="n">pPBStr</span><span class="p">,</span> <span class="s">&quot;/tmp/affinity_pb_issue.raw&quot;</span><span class="p">)</span>
        <span class="k">print</span> <span class="p">(</span><span class="s">&quot;***&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>
<span class="k">def</span> <span class="nf">isInteger</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="s">&quot;Return True if p is an integer value.&quot;</span>
    <span class="k">return</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&#39;__mod__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">p</span> <span class="o">%</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">getOpt</span><span class="p">(</span><span class="n">pOptions</span><span class="p">,</span> <span class="n">pWhich</span><span class="p">,</span> <span class="n">pDefault</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">None</span> <span class="o">!=</span> <span class="n">pOptions</span> <span class="ow">and</span> <span class="bp">None</span> <span class="o">!=</span> <span class="n">pWhich</span> <span class="ow">and</span> <span class="n">pOptions</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">pWhich</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pOptions</span><span class="p">[</span><span class="n">pWhich</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">pDefault</span>

<span class="c"># Exceptions.</span>
<span class="k">class</span> <span class="nc">InvalidParameter</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="s">&quot;Invalid or unexpected parameter.&quot;</span>

<span class="c"># AfyHTTPResponse: HTTPResponse override.</span>
<span class="c"># Note: httplib.HTTPResponse is an old-style class...</span>
<span class="k">class</span> <span class="nc">AfyHTTPResponse</span><span class="p">(</span><span class="n">httplib</span><span class="o">.</span><span class="n">HTTPResponse</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;HTTPResponse override, to enable streaming (i.e. reading response segments, corresponding to</span>
<span class="sd">    flushed segments in the input stream).&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lR</span> <span class="o">=</span> <span class="n">httplib</span><span class="o">.</span><span class="n">HTTPResponse</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">will_close</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">lR</span>
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amt</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fp</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunked</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">httplib</span><span class="o">.</span><span class="n">HTTPResponse</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">amt</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># Note (maxw): From socket.py, _fileobject.read()...</span>
            <span class="c"># Note (maxw): The main difference is that amt==None is not interpreted to mean &#39;read all&#39;, just &#39;read some&#39;...</span>
            <span class="n">rbufsize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">_rbufsize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">default_bufsize</span><span class="p">)</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">_rbuf</span>
            <span class="n">buf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">amt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">_rbuf</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">_sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">rbufsize</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                    <span class="n">buf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">buf</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">httplib</span><span class="o">.</span><span class="n">HTTPResponse</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amt</span><span class="p">)</span>

<span class="c"># Core Objects: store access/connection.</span>
<span class="k">class</span> <span class="nc">AffinityConnection</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Access layer for Affinity (aka db connection). For convenience, it allows</span>
<span class="sd">    to talk to an inproc store or to the server, interchangeably. The global DEFAULT_CONNECTION instance</span>
<span class="sd">    is used by default; otherwise, a &#39;with&#39; statement can be used to push a different connection</span>
<span class="sd">    on the stack. Not designed to be used concurrently (use one connection per thread).&quot;&quot;&quot;</span>
    <span class="n">DEFAULT_INPROC</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">DEFAULT_CONNECTION</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">isInproc</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;affinityinproc&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">AffinityConnection</span><span class="o">.</span><span class="n">DEFAULT_INPROC</span>
    <span class="c"># ---</span>
    <span class="n">TLS</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">local</span><span class="p">()</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">getCurrentDbConnection</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">AffinityConnection</span><span class="o">.</span><span class="n">TLS</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&quot;mDbConnectionStack&quot;</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;initializing tls&quot;</span><span class="p">)</span>
            <span class="n">AffinityConnection</span><span class="o">.</span><span class="n">TLS</span><span class="o">.</span><span class="n">mDbConnectionStack</span> <span class="o">=</span> <span class="p">[</span><span class="n">AffinityConnection</span><span class="o">.</span><span class="n">DEFAULT_CONNECTION</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">AffinityConnection</span><span class="o">.</span><span class="n">TLS</span><span class="o">.</span><span class="n">mDbConnectionStack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">pushDbConnection</span><span class="p">(</span><span class="n">pDbConnection</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">AffinityConnection</span><span class="o">.</span><span class="n">TLS</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&quot;mDbConnectionStack&quot;</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;initializing tls&quot;</span><span class="p">)</span>
            <span class="n">AffinityConnection</span><span class="o">.</span><span class="n">TLS</span><span class="o">.</span><span class="n">mDbConnectionStack</span> <span class="o">=</span> <span class="p">[</span><span class="n">AffinityConnection</span><span class="o">.</span><span class="n">DEFAULT_CONNECTION</span><span class="p">]</span>
        <span class="n">lOld</span> <span class="o">=</span> <span class="n">AffinityConnection</span><span class="o">.</span><span class="n">TLS</span><span class="o">.</span><span class="n">mDbConnectionStack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;pushing db connection </span><span class="si">%s</span><span class="s"> (old=</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pDbConnection</span><span class="p">,</span> <span class="n">lOld</span><span class="p">))</span>
        <span class="n">AffinityConnection</span><span class="o">.</span><span class="n">TLS</span><span class="o">.</span><span class="n">mDbConnectionStack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pDbConnection</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lOld</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">popDbConnection</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">AffinityConnection</span><span class="o">.</span><span class="n">TLS</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&quot;mDbConnectionStack&quot;</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;no connection to pop!&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;popping db connection </span><span class="si">%s</span><span class="s"> (new=</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">AffinityConnection</span><span class="o">.</span><span class="n">TLS</span><span class="o">.</span><span class="n">mDbConnectionStack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">AffinityConnection</span><span class="o">.</span><span class="n">TLS</span><span class="o">.</span><span class="n">mDbConnectionStack</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">AffinityConnection</span><span class="o">.</span><span class="n">TLS</span><span class="o">.</span><span class="n">mDbConnectionStack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">AffinityConnection</span><span class="o">.</span><span class="n">pushDbConnection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etyp</span><span class="p">,</span> <span class="n">einst</span><span class="p">,</span> <span class="n">etb</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">AffinityConnection</span><span class="o">.</span><span class="n">popDbConnection</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;imbalance detected in the db connection stack!&quot;</span><span class="p">)</span>
    <span class="c"># ---</span>
    <span class="k">class</span> <span class="nc">Inproc</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;[internal] Internal implementation, for Affinity running in-process (in python).&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pKeepAlive</span><span class="p">):</span> <span class="k">return</span> <span class="mi">0</span> <span class="o">==</span> <span class="n">affinityinproc</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="mi">0</span> <span class="o">==</span> <span class="n">affinityinproc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">startSession</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="n">affinityinproc</span><span class="o">.</span><span class="n">startSession</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">terminateSession</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pSession</span><span class="p">):</span> <span class="k">return</span> <span class="n">affinityinproc</span><span class="o">.</span><span class="n">terminateSession</span><span class="p">(</span><span class="n">pSession</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">attachSession</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pSession</span><span class="p">):</span> <span class="k">return</span> <span class="n">affinityinproc</span><span class="o">.</span><span class="n">attachSession</span><span class="p">(</span><span class="n">pSession</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">detachSession</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pSession</span><span class="p">):</span> <span class="k">return</span> <span class="n">affinityinproc</span><span class="o">.</span><span class="n">detachSession</span><span class="p">(</span><span class="n">pSession</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pMsg</span><span class="p">,</span> <span class="n">pSession</span><span class="p">):</span> <span class="k">return</span> <span class="n">affinityinproc</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">pSession</span><span class="p">,</span> <span class="n">pMsg</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">beginlongpost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pSession</span><span class="p">):</span> <span class="k">return</span> <span class="n">affinityinproc</span><span class="o">.</span><span class="n">beginlongpost</span><span class="p">(</span><span class="n">pSession</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">continuelongpost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pLPToken</span><span class="p">,</span> <span class="n">pMsg</span><span class="p">,</span> <span class="n">pExpectOutput</span><span class="p">,</span> <span class="n">pSession</span><span class="p">):</span> <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">pMsg</span><span class="p">);</span> <span class="k">return</span> <span class="n">affinityinproc</span><span class="o">.</span><span class="n">continuelongpost</span><span class="p">(</span><span class="n">pSession</span><span class="p">,</span> <span class="n">pLPToken</span><span class="p">,</span> <span class="n">pMsg</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">endlongpost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pLPToken</span><span class="p">,</span> <span class="n">pSession</span><span class="p">):</span> <span class="k">return</span> <span class="n">affinityinproc</span><span class="o">.</span><span class="n">endlongpost</span><span class="p">(</span><span class="n">pSession</span><span class="p">,</span> <span class="n">pLPToken</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pQstr</span><span class="p">,</span> <span class="n">pOptions</span><span class="p">,</span> <span class="n">pSession</span><span class="p">):</span> <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">pQstr</span><span class="p">);</span> <span class="k">return</span> <span class="n">affinityinproc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pSession</span><span class="p">,</span> <span class="n">pQstr</span><span class="p">,</span> <span class="n">pOptions</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pQstr</span><span class="p">,</span> <span class="n">pOptions</span><span class="p">,</span> <span class="n">pSession</span><span class="p">):</span> <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">pQstr</span><span class="p">);</span> <span class="k">return</span> <span class="n">affinityinproc</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">pSession</span><span class="p">,</span> <span class="n">pQstr</span><span class="p">,</span> <span class="n">pOptions</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">trueSessions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">True</span>
    <span class="c"># ---</span>
    <span class="k">class</span> <span class="nc">AfyServer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;[internal] Internal implementation, for Affinity running as a server (reached via http).&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pConnection</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mConnection</span> <span class="o">=</span> <span class="n">pConnection</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mConnectionHTTP</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pKeepAlive</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pKeepAlive</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mConnectionHTTP</span> <span class="o">=</span> <span class="n">httplib</span><span class="o">.</span><span class="n">HTTPConnection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">())</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mConnectionHTTP</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mConnectionHTTP</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mConnectionHTTP</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">def</span> <span class="nf">startSession</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">True</span>
        <span class="k">def</span> <span class="nf">terminateSession</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pSession</span><span class="p">):</span> <span class="k">return</span> <span class="bp">True</span>
        <span class="k">def</span> <span class="nf">attachSession</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pSession</span><span class="p">):</span> <span class="k">return</span> <span class="bp">True</span>
        <span class="k">def</span> <span class="nf">detachSession</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pSession</span><span class="p">):</span> <span class="k">return</span> <span class="bp">True</span>
        <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pMsg</span><span class="p">,</span> <span class="n">pSession</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;sent </span><span class="si">%d</span><span class="s"> bytes&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">pMsg</span><span class="p">))</span>
            <span class="n">lRes</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mConnectionHTTP</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mConnectionHTTP</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s">&quot;POST&quot;</span><span class="p">,</span> <span class="s">&quot;/db/?i=proto&amp;o=proto&quot;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">pMsg</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;Authorization&quot;</span><span class="p">:</span><span class="s">&quot;Basic </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="p">(),</span> <span class="s">&quot;Content-Type&quot;</span><span class="p">:</span><span class="s">&quot;application/octet-stream&quot;</span><span class="p">})</span>
                <span class="n">lRes</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mConnectionHTTP</span><span class="o">.</span><span class="n">getresponse</span><span class="p">()</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lRes</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">urllib2</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="s">&quot;http://</span><span class="si">%s</span><span class="s">/db/?i=proto&amp;o=proto&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">(),</span> <span class="n">data</span><span class="o">=</span><span class="n">pMsg</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;Authorization&quot;</span><span class="p">:</span><span class="s">&quot;Basic </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="p">(),</span> <span class="s">&quot;Content-Type&quot;</span><span class="p">:</span><span class="s">&quot;application/octet-stream&quot;</span><span class="p">}))</span><span class="o">.</span><span class="n">read</span><span class="p">())</span> <span class="c"># print binascii.hexlify(pMsg);</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;received </span><span class="si">%d</span><span class="s"> bytes&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">lRes</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">lRes</span>
        <span class="k">def</span> <span class="nf">beginlongpost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pSession</span><span class="p">):</span>
            <span class="c"># Note: Currently, an Affinity transaction cannot live across more than one http request...</span>
            <span class="n">lLongC</span> <span class="o">=</span> <span class="n">httplib</span><span class="o">.</span><span class="n">HTTPConnection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">())</span>
            <span class="n">lLongC</span><span class="o">.</span><span class="n">response_class</span> <span class="o">=</span> <span class="n">AfyHTTPResponse</span>
            <span class="n">lLongC</span><span class="o">.</span><span class="n">putrequest</span><span class="p">(</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="s">&#39;/db/?i=proto&amp;o=proto&#39;</span><span class="p">)</span>
            <span class="n">lLongC</span><span class="o">.</span><span class="n">putheader</span><span class="p">(</span><span class="s">&quot;Authorization&quot;</span><span class="p">,</span> <span class="s">&quot;Basic </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="p">())</span>
            <span class="n">lLongC</span><span class="o">.</span><span class="n">putheader</span><span class="p">(</span><span class="s">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s">&quot;application/octet-stream&quot;</span><span class="p">)</span>
            <span class="n">lLongC</span><span class="o">.</span><span class="n">endheaders</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mResponse</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;token=</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">lLongC</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">lLongC</span>
        <span class="k">def</span> <span class="nf">continuelongpost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pLPToken</span><span class="p">,</span> <span class="n">pMsg</span><span class="p">,</span> <span class="n">pExpectOutput</span><span class="p">,</span> <span class="n">pSession</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;sent </span><span class="si">%d</span><span class="s"> bytes, token=</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pMsg</span><span class="p">),</span> <span class="n">pLPToken</span><span class="p">))</span>
            <span class="n">pLPToken</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">pMsg</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mResponse</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mResponse</span> <span class="o">=</span> <span class="n">pLPToken</span><span class="o">.</span><span class="n">getresponse</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">pExpectOutput</span><span class="p">:</span>
                <span class="n">lRes</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mResponse</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;received </span><span class="si">%d</span><span class="s"> bytes, token=</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lRes</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">pLPToken</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lRes</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;expected&amp;received 0 byte, token=</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">pLPToken</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">lRes</span>
        <span class="k">def</span> <span class="nf">endlongpost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pLPToken</span><span class="p">,</span> <span class="n">pSession</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;token=</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">pLPToken</span><span class="p">)</span>
            <span class="n">pLPToken</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mResponse</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pQstr</span><span class="p">,</span> <span class="n">pOptions</span><span class="p">,</span> <span class="n">pSession</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">pQstr</span><span class="p">)</span>
            <span class="n">lRet</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">lCountOnly</span> <span class="o">=</span> <span class="n">getOpt</span><span class="p">(</span><span class="n">pOptions</span><span class="p">,</span> <span class="s">&quot;count&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="n">lPath</span> <span class="o">=</span> <span class="s">&quot;/db/?q=</span><span class="si">%s</span><span class="s">&amp;i=pathsql</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">pQstr</span><span class="p">),</span> <span class="p">(</span><span class="s">&quot;&amp;o=proto&quot;</span><span class="p">,</span> <span class="s">&quot;&amp;type=count&quot;</span><span class="p">)[</span><span class="n">lCountOnly</span><span class="p">])</span>
            <span class="n">lPath</span> <span class="o">=</span> <span class="n">AffinityConnection</span><span class="o">.</span><span class="n">AfyServer</span><span class="o">.</span><span class="n">_appendUrlOptions</span><span class="p">(</span><span class="n">lPath</span><span class="p">,</span> <span class="n">pOptions</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mConnectionHTTP</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mConnectionHTTP</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="n">lPath</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;Authorization&quot;</span><span class="p">:</span><span class="s">&quot;Basic </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="p">()})</span>
                <span class="n">lRet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mConnectionHTTP</span><span class="o">.</span><span class="n">getresponse</span><span class="p">()</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lRet</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">urllib2</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="s">&quot;http://</span><span class="si">%s%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">(),</span> <span class="n">lPath</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;Authorization&quot;</span><span class="p">:</span><span class="s">&quot;Basic </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="p">()}))</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">lCountOnly</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">lRet</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">lRet</span>
        <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pQstr</span><span class="p">,</span> <span class="n">pOptions</span><span class="p">,</span> <span class="n">pSession</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">pQstr</span><span class="p">)</span>
            <span class="n">lCountOnly</span> <span class="o">=</span> <span class="n">getOpt</span><span class="p">(</span><span class="n">pOptions</span><span class="p">,</span> <span class="s">&quot;count&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="n">lPath</span> <span class="o">=</span> <span class="s">&quot;/db/?q=</span><span class="si">%s</span><span class="s">&amp;i=pathsql&amp;o=json</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">pQstr</span><span class="p">),</span> <span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&amp;type=count&quot;</span><span class="p">)[</span><span class="n">lCountOnly</span><span class="p">])</span>
            <span class="n">lPath</span> <span class="o">=</span> <span class="n">AffinityConnection</span><span class="o">.</span><span class="n">AfyServer</span><span class="o">.</span><span class="n">_appendUrlOptions</span><span class="p">(</span><span class="n">lPath</span><span class="p">,</span> <span class="n">pOptions</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">urllib2</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="s">&quot;http://</span><span class="si">%s%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">(),</span> <span class="n">lPath</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;Authorization&quot;</span><span class="p">:</span><span class="s">&quot;Basic </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="p">()}))</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">trueSessions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">False</span>
        <span class="k">def</span> <span class="nf">host</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mConnection</span><span class="o">.</span><span class="n">host</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">auth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mConnection</span><span class="o">.</span><span class="n">basicauth</span><span class="p">()</span>
        <span class="nd">@staticmethod</span>
        <span class="k">def</span> <span class="nf">_appendUrlOptions</span><span class="p">(</span><span class="n">pUrl</span><span class="p">,</span> <span class="n">pOptions</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">None</span> <span class="o">==</span> <span class="n">pOptions</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">pUrl</span>
            <span class="k">if</span> <span class="n">pOptions</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&quot;offset&quot;</span><span class="p">):</span>
                <span class="n">pUrl</span> <span class="o">=</span> <span class="n">pUrl</span> <span class="o">+</span> <span class="s">&quot;&amp;offset=</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">pOptions</span><span class="p">[</span><span class="s">&quot;offset&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pOptions</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&quot;limit&quot;</span><span class="p">):</span>
                <span class="n">pUrl</span> <span class="o">=</span> <span class="n">pUrl</span> <span class="o">+</span> <span class="s">&quot;&amp;limit=</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">pOptions</span><span class="p">[</span><span class="s">&quot;limit&quot;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">pUrl</span>
    <span class="c"># ---</span>
    <span class="k">class</span> <span class="nc">PBTransactionCtx</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;[internal] Transaction context for protobuf. Allows to run long transactions and fetch intermediate results</span>
<span class="sd">        (without any dependency on a keep-alive connection). Facilitates the concatenation of protobuf logical AfyStream segments,</span>
<span class="sd">        to produce the final outgoing stream.&quot;&quot;&quot;</span>
        <span class="n">MODE_IGNORE_OUTPUT</span> <span class="o">=</span> <span class="mh">0x0001</span>
        <span class="n">MODE_IMMEDIATE_UPDATES</span> <span class="o">=</span> <span class="mh">0x0002</span>
        <span class="n">NEXT_CID</span> <span class="o">=</span> <span class="mi">1</span> <span class="c"># Review: thread-safety</span>
        <span class="c"># ---</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pConnection</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pMode</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mConnection</span> <span class="o">=</span> <span class="n">pConnection</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mConnection</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mConnection</span> <span class="o">=</span> <span class="n">AffinityConnection</span><span class="o">.</span><span class="n">getCurrentDbConnection</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mPBStream</span> <span class="o">=</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">AfyStream</span><span class="p">()</span> <span class="c"># The current stream segment.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mSegments</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># The accumulated stream segments.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mSegmentsExpectOutput</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># Maybe just a workaround until commit produces bits in the response stream...</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mMode</span> <span class="o">=</span> <span class="n">pMode</span> <span class="c"># The combination of modes in which we operate currently.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mRC</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># The return code from Affinity.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mPBOutput</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># The parsed (AfyStream) protobuf output.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mPropDict</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># Accumulated dictionary of {propname, propid}.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mLPToken</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># For long-running transactions (protobuf).</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mTxCnt</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># Holds a count of nested transactions.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mPINUpdates</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># Accumulates PIN updates during a transaction.</span>
        <span class="c"># ---</span>
        <span class="c"># Control of the PB stream.</span>
        <span class="k">def</span> <span class="nf">isOutputIgnored</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">mMode</span> <span class="o">&amp;</span> <span class="n">AffinityConnection</span><span class="o">.</span><span class="n">PBTransactionCtx</span><span class="o">.</span><span class="n">MODE_IGNORE_OUTPUT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">performImmediateUpdates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">mMode</span> <span class="o">&amp;</span> <span class="n">AffinityConnection</span><span class="o">.</span><span class="n">PBTransactionCtx</span><span class="o">.</span><span class="n">MODE_IMMEDIATE_UPDATES</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">capture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mPBStream</span><span class="o">.</span><span class="n">pins</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c"># Review: The final condition will be different, but for the moment I&#39;m not sure I can do better.</span>
                <span class="k">for</span> <span class="n">iP</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mPBStream</span><span class="o">.</span><span class="n">pins</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">AfyStream</span><span class="o">.</span><span class="n">OP_INSERT</span> <span class="o">==</span> <span class="n">iP</span><span class="o">.</span><span class="n">op</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">mSegmentsExpectOutput</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="k">break</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mSegments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mPBStream</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mPBStream</span><span class="o">.</span><span class="n">stmt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mSegmentsExpectOutput</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mSegments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mPBStream</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mPBStream</span><span class="o">.</span><span class="n">txop</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mPBStream</span><span class="o">.</span><span class="n">flush</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mPBStream</span><span class="o">.</span><span class="n">properties</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mSegments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mPBStream</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;An empty mPBStream was captured... and ignored.&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> segments, </span><span class="si">%s</span><span class="s"> bytes</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mSegments</span><span class="p">),</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">iS</span><span class="p">)</span> <span class="k">for</span> <span class="n">iS</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mSegments</span><span class="p">]),</span> <span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;, FLUSH&quot;</span><span class="p">)[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mPBStream</span><span class="o">.</span><span class="n">flush</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mPBStream</span> <span class="o">=</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">AfyStream</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pExplicit</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pExplicit</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mPBStream</span><span class="o">.</span><span class="n">flush</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">capture</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_applyPINUpdates</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pushData</span><span class="p">()</span>            
        <span class="k">def</span> <span class="nf">getPBStream</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mPBStream</span>
        <span class="c"># ---</span>
        <span class="c"># Transaction control.</span>
        <span class="c"># TODO: Offer the commit/rollback ALL option.</span>
        <span class="k">def</span> <span class="nf">startTx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mLPToken</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mLPToken</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mConnection</span><span class="o">.</span><span class="n">_beginlongpost</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mPBStream</span><span class="o">.</span><span class="n">txop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">affinity_pb2</span><span class="o">.</span><span class="n">AfyStream</span><span class="o">.</span><span class="n">TX_START</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">capture</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mTxCnt</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">def</span> <span class="nf">commitTx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mPBStream</span><span class="o">.</span><span class="n">txop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">affinity_pb2</span><span class="o">.</span><span class="n">AfyStream</span><span class="o">.</span><span class="n">TX_COMMIT</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">capture</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mTxCnt</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">mTxCnt</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_terminate</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">rollbackTx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mPBStream</span><span class="o">.</span><span class="n">txop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">affinity_pb2</span><span class="o">.</span><span class="n">AfyStream</span><span class="o">.</span><span class="n">TX_ROLLBACK</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">capture</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mTxCnt</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">mTxCnt</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_terminate</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">_terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mTxCnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;terminated a txctx prematurely&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_applyPINUpdates</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pushData</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mLPToken</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mConnection</span><span class="o">.</span><span class="n">_endlongpost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mLPToken</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mLPToken</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mPropDict</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># REVIEW: In a near future we&#39;ll try to be more efficient than this.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mConnection</span><span class="o">.</span><span class="n">mTxCtx</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c"># ---</span>
        <span class="c"># Query via protobuf (various flavors).</span>
        <span class="k">def</span> <span class="nf">_queryPB1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pQstr</span><span class="p">,</span> <span class="n">pOptions</span><span class="p">,</span> <span class="n">pRtt</span><span class="o">=</span><span class="n">affinity_pb2</span><span class="o">.</span><span class="n">RT_PINS</span><span class="p">):</span>
            <span class="s">&quot;This version really participates to the current protobuf stream and its current transaction (i.e. protobuf in&amp;out).&quot;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;pathSQL in protobuf: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">pQstr</span><span class="p">)</span>
            <span class="n">lStmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPBStream</span><span class="p">()</span><span class="o">.</span><span class="n">stmt</span><span class="o">.</span><span class="n">add</span><span class="p">()</span>
            <span class="n">lStmt</span><span class="o">.</span><span class="n">sq</span> <span class="o">=</span> <span class="n">pQstr</span>
            <span class="n">lStmt</span><span class="o">.</span><span class="n">cid</span> <span class="o">=</span> <span class="n">AffinityConnection</span><span class="o">.</span><span class="n">PBTransactionCtx</span><span class="o">.</span><span class="n">NEXT_CID</span><span class="p">;</span> <span class="n">AffinityConnection</span><span class="o">.</span><span class="n">PBTransactionCtx</span><span class="o">.</span><span class="n">NEXT_CID</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">lStmt</span><span class="o">.</span><span class="n">rtt</span> <span class="o">=</span> <span class="n">pRtt</span>
            <span class="n">lStmt</span><span class="o">.</span><span class="n">limit</span> <span class="o">=</span> <span class="n">getOpt</span><span class="p">(</span><span class="n">pOptions</span><span class="p">,</span> <span class="s">&quot;limit&quot;</span><span class="p">,</span> <span class="mi">999999</span><span class="p">)</span>
            <span class="n">lStmt</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">getOpt</span><span class="p">(</span><span class="n">pOptions</span><span class="p">,</span> <span class="s">&quot;offset&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mPBOutput</span>
        <span class="nd">@staticmethod</span>
        <span class="k">def</span> <span class="nf">_queryPBOut</span><span class="p">(</span><span class="n">pQstr</span><span class="p">,</span> <span class="n">pOptions</span><span class="p">):</span>
            <span class="s">&quot;This version borrows the current connection to request directly from the server a protobuf response (i.e. pathSQL in &amp; protobuf out; for debugging etc.).&quot;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;pathSQL (in protobuf): </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">pQstr</span><span class="p">)</span>
            <span class="n">lRaw</span> <span class="o">=</span> <span class="n">AffinityConnection</span><span class="o">.</span><span class="n">getCurrentDbConnection</span><span class="p">()</span><span class="o">.</span><span class="n">q</span><span class="p">(</span><span class="n">pQstr</span><span class="p">,</span> <span class="n">pOptions</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lRaw</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="c">#displayPBStr(lRaw, pTitle=&quot;response obtained from Affinity for _queryPB&quot;)</span>
            <span class="k">return</span> <span class="n">parsePBStr</span><span class="p">(</span><span class="n">lRaw</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">_queryPB2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pQstr</span><span class="p">,</span> <span class="n">pOptions</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">AffinityConnection</span><span class="o">.</span><span class="n">PBTransactionCtx</span><span class="o">.</span><span class="n">_queryPBOut</span><span class="p">(</span><span class="n">pQstr</span><span class="p">,</span> <span class="n">pOptions</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">queryPB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pQstr</span><span class="p">,</span> <span class="n">pOptions</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queryPB2</span><span class="p">(</span><span class="n">pQstr</span><span class="p">,</span> <span class="n">pOptions</span><span class="p">)</span> <span class="c"># TODO: switch to _queryPB1 when it&#39;s glitchless... (right now it&#39;s still buggier somehow).</span>
        <span class="c"># ---</span>
        <span class="c"># Accumulation of PIN updates.</span>
        <span class="k">def</span> <span class="nf">recordPINUpdate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pPINUpdate</span><span class="p">):</span> <span class="c"># TODO: also record the original pin, to pad its ids</span>
            <span class="s">&quot;Record a PIN update (allows to defer dialogue with Affinity in some cases, and reduce chattiness).&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">performImmediateUpdates</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">Exception</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mPINUpdates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pPINUpdate</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">_applyPINUpdates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="s">&quot;Apply all accumulated PIN updates.&quot;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> updates&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mPINUpdates</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mPINUpdates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">PIN</span><span class="o">.</span><span class="n">_savePINsi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mPINUpdates</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mPINUpdates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c"># ---</span>
        <span class="c"># Accumulation of protobuf segments.</span>
        <span class="k">def</span> <span class="nf">_pushData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="s">&quot;Push all accumulated serialized protobuf segments to Affinity; parse and store the output.&quot;</span>
            <span class="n">lSegmentsExpectOutput</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mSegmentsExpectOutput</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> segments&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mSegments</span><span class="p">))</span>
            <span class="n">lMessage</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mSegments</span><span class="p">)</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">mTxCnt</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mPropDict</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># REVIEW: In a near future we&#39;ll try to be more efficient than this.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mSegments</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mSegmentsExpectOutput</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mRC</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mPBOutput</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">lMessage</span><span class="p">):</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;no message to send&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="c">#displayPBStr(lMessage, pTitle=&quot;message sent to Affinity&quot;)</span>
            <span class="c">#savePBStr(lMessage, &quot;./sent01.pbdata&quot;)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mLPToken</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mRC</span><span class="p">,</span> <span class="n">lRawOutput</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mConnection</span><span class="o">.</span><span class="n">_continuelongpost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mLPToken</span><span class="p">,</span> <span class="n">lMessage</span><span class="p">,</span> <span class="n">lSegmentsExpectOutput</span><span class="p">)</span>
                <span class="c">#displayPBStr(lRawOutput, pTitle=&quot;response obtained from Affinity (longpost)&quot;)</span>
                <span class="k">if</span> <span class="n">lSegmentsExpectOutput</span> <span class="ow">and</span> <span class="n">lRawOutput</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;result: RC=</span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s"> bytes)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mRC</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lRawOutput</span><span class="p">)))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mPBOutput</span> <span class="o">=</span> <span class="n">parsePBStr</span><span class="p">(</span><span class="n">lRawOutput</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;result: RC=</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">mRC</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mRC</span><span class="p">,</span> <span class="n">lRawOutput</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mConnection</span><span class="o">.</span><span class="n">_post</span><span class="p">(</span><span class="n">lMessage</span><span class="p">)</span>
                <span class="c">#displayPBStr(lRawOutput, pTitle=&quot;response obtained from Affinity&quot;)</span>
                <span class="k">if</span> <span class="n">lSegmentsExpectOutput</span> <span class="ow">and</span> <span class="n">lRawOutput</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;result: RC=</span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s"> bytes)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mRC</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lRawOutput</span><span class="p">)))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mPBOutput</span> <span class="o">=</span> <span class="n">parsePBStr</span><span class="p">(</span><span class="n">lRawOutput</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;result: RC=</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">mRC</span><span class="p">)</span>
    <span class="c"># ---</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pHost</span><span class="o">=</span><span class="s">&quot;localhost&quot;</span><span class="p">,</span> <span class="n">pPort</span><span class="o">=</span><span class="mi">4560</span><span class="p">,</span> <span class="n">pOwner</span><span class="o">=</span><span class="s">&quot;generic&quot;</span><span class="p">,</span> <span class="n">pPassword</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mHost</span> <span class="o">=</span> <span class="n">pHost</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mPort</span> <span class="o">=</span> <span class="n">pPort</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mOwner</span> <span class="o">=</span> <span class="n">pOwner</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mPassword</span> <span class="o">=</span> <span class="n">pPassword</span>
        <span class="k">if</span> <span class="n">AffinityConnection</span><span class="o">.</span><span class="n">isInproc</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mImpl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Inproc</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mImpl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AfyServer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mSessionStack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mTxCtx</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pKeepAlive</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mImpl</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">pKeepAlive</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startSession</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">terminateSession</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mImpl</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">host</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mHost</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mPort</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">basicauth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mOwner</span><span class="p">,</span> <span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mPassword</span><span class="p">)[</span><span class="bp">None</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mPassword</span><span class="p">]))</span>
    <span class="k">def</span> <span class="nf">q</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pQstr</span><span class="p">,</span> <span class="n">pOptions</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pSession</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span> <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;pathSQL: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">pQstr</span><span class="p">);</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mImpl</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pQstr</span><span class="p">,</span> <span class="n">pOptions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_s</span><span class="p">(</span><span class="n">pSession</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">qCount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pQstr</span><span class="p">,</span> <span class="n">pSession</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span> <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;pathSQL (count): </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">pQstr</span><span class="p">);</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mImpl</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pQstr</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;count&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">},</span> <span class="bp">self</span><span class="o">.</span><span class="n">_s</span><span class="p">(</span><span class="n">pSession</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">qProto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pQstr</span><span class="p">,</span> <span class="n">pOptions</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_txCtx</span><span class="p">()</span><span class="o">.</span><span class="n">queryPB</span><span class="p">(</span><span class="n">pQstr</span><span class="p">,</span> <span class="n">pOptions</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pQstr</span><span class="p">,</span> <span class="n">pOptions</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pSession</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mImpl</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">pQstr</span><span class="p">,</span> <span class="n">pOptions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_s</span><span class="p">(</span><span class="n">pSession</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">startTx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_txCtx</span><span class="p">()</span><span class="o">.</span><span class="n">startTx</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">commitTx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_txCtx</span><span class="p">()</span><span class="o">.</span><span class="n">commitTx</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">rollbackTx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_txCtx</span><span class="p">()</span><span class="o">.</span><span class="n">rollbackTx</span><span class="p">()</span>
    <span class="c"># --- WARNING: This section may become deprecated...</span>
    <span class="k">def</span> <span class="nf">trueSessions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mImpl</span><span class="o">.</span><span class="n">trueSessions</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">startSession</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">mSessionStack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mImpl</span><span class="o">.</span><span class="n">startSession</span><span class="p">());</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mSessionStack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">terminateSession</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pSession</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mImpl</span><span class="o">.</span><span class="n">terminateSession</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_s</span><span class="p">(</span><span class="n">pSession</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">attachSession</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pSession</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">lRet</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">lSession</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_s</span><span class="p">(</span><span class="n">pSession</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mSessionStack</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">mSessionStack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">lSession</span><span class="p">:</span>
            <span class="n">lRet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mImpl</span><span class="o">.</span><span class="n">attachSession</span><span class="p">(</span><span class="n">lSession</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mSessionStack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lSession</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lRet</span>
    <span class="k">def</span> <span class="nf">detachSession</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pSession</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">lRet</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">lSession</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_s</span><span class="p">(</span><span class="n">pSession</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mSessionStack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="o">!=</span> <span class="n">lSession</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;pSession didn&#39;t match the stack!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mSessionStack</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">mSessionStack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">lSession</span><span class="p">:</span>
            <span class="n">lRet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mImpl</span><span class="o">.</span><span class="n">detachSession</span><span class="p">(</span><span class="n">lSession</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mSessionStack</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mImpl</span><span class="o">.</span><span class="n">attachSession</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mSessionStack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">lRet</span>
    <span class="c"># ---</span>
    <span class="k">def</span> <span class="nf">_post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pMsg</span><span class="p">,</span> <span class="n">pSession</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span> <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;sending protobuf message&quot;</span><span class="p">);</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mImpl</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">pMsg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_s</span><span class="p">(</span><span class="n">pSession</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">_beginlongpost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pSession</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mImpl</span><span class="o">.</span><span class="n">beginlongpost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_s</span><span class="p">(</span><span class="n">pSession</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">_continuelongpost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pLPToken</span><span class="p">,</span> <span class="n">pMsg</span><span class="p">,</span> <span class="n">pExpectOutput</span><span class="p">,</span> <span class="n">pSession</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span> <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;sending protobuf message&quot;</span><span class="p">);</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mImpl</span><span class="o">.</span><span class="n">continuelongpost</span><span class="p">(</span><span class="n">pLPToken</span><span class="p">,</span> <span class="n">pMsg</span><span class="p">,</span> <span class="n">pExpectOutput</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_s</span><span class="p">(</span><span class="n">pSession</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">_endlongpost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pLPToken</span><span class="p">,</span> <span class="n">pSession</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">mImpl</span><span class="o">.</span><span class="n">endlongpost</span><span class="p">(</span><span class="n">pLPToken</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_s</span><span class="p">(</span><span class="n">pSession</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">_s</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pSession</span><span class="p">):</span> <span class="k">return</span> <span class="p">(</span><span class="n">pSession</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mSessionStack</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mSessionStack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="n">pSession</span> <span class="o">==</span> <span class="bp">None</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">_txCtx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">None</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">mTxCtx</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mTxCtx</span> <span class="o">=</span> <span class="n">AffinityConnection</span><span class="o">.</span><span class="n">PBTransactionCtx</span><span class="p">(</span><span class="n">pConnection</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mTxCtx</span>
<span class="n">AffinityConnection</span><span class="o">.</span><span class="n">DEFAULT_CONNECTION</span> <span class="o">=</span> <span class="n">AffinityConnection</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">AFFINITY</span><span class="p">():</span> <span class="k">return</span> <span class="n">AffinityConnection</span><span class="o">.</span><span class="n">getCurrentDbConnection</span><span class="p">()</span>
    
<span class="c"># Core Objects: response stream reading context.</span>
<span class="c"># Note: In a majority of cases the developer needs not be aware of this (PIN.loadPINs hides it).</span>
<span class="k">class</span> <span class="nc">PBReadCtx</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;In-memory representation of the global contextual information returned by Affinity in a response stream.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pPBStream</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mPBStream</span> <span class="o">=</span> <span class="n">pPBStream</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mPropID2Name</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mPropName2ID</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mIdentMap</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pPBStream</span><span class="o">.</span><span class="n">HasField</span><span class="p">(</span><span class="s">&#39;owner&#39;</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mOwner</span> <span class="o">=</span> <span class="n">pPBStream</span><span class="o">.</span><span class="n">owner</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pPBStream</span><span class="o">.</span><span class="n">HasField</span><span class="p">(</span><span class="s">&#39;storeID&#39;</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mStoreID</span> <span class="o">=</span> <span class="n">pPBStream</span><span class="o">.</span><span class="n">storeID</span>
        <span class="n">lProps</span> <span class="o">=</span> <span class="n">pPBStream</span><span class="o">.</span><span class="n">properties</span>
        <span class="k">for</span> <span class="n">iP</span> <span class="ow">in</span> <span class="n">pPBStream</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mPropID2Name</span><span class="p">[</span><span class="n">iP</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">iP</span><span class="o">.</span><span class="n">str</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mPropName2ID</span><span class="p">[</span><span class="n">iP</span><span class="o">.</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">iP</span><span class="o">.</span><span class="n">id</span>
        <span class="k">for</span> <span class="n">iP</span> <span class="ow">in</span> <span class="n">SP_PROPERTY_NAMES</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mPropID2Name</span><span class="p">[</span><span class="n">iP</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">iP</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mPropName2ID</span><span class="p">[</span><span class="n">iP</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">iP</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">lIdents</span> <span class="o">=</span> <span class="n">pPBStream</span><span class="o">.</span><span class="n">identities</span>
        <span class="k">for</span> <span class="n">iI</span> <span class="ow">in</span> <span class="n">pPBStream</span><span class="o">.</span><span class="n">identities</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mIdentMap</span><span class="p">[</span><span class="n">iI</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">iI</span><span class="o">.</span><span class="n">str</span>
    <span class="k">def</span> <span class="nf">getPBStream</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mPBStream</span>
    <span class="k">def</span> <span class="nf">getPropName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pPropID</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mPropID2Name</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pPropID</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">getPropID</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pPropName</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mPropName2ID</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pPropName</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">getIdentityName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pIdentityID</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mIdentMap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pIdentityID</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">getOwner</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mOwner</span>
    <span class="k">def</span> <span class="nf">getStoreID</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mStoreID</span>

<span class="c"># Core Objects: PIN.</span>
<span class="k">class</span> <span class="nc">PIN</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convenient in-memory representation of the PIN, or of modifications to a PIN, primarily as a python dictionary of {property name, scalar value or list of values}.</span>
<span class="sd">    Also holds another dictionary in the background (mExtras), to contain all the per-value info that is required for specific operations.</span>
<span class="sd">    Preserves the standard dictionary interface, and allows to substitute any value with a (value, PIN.Extra) tuple.</span>
<span class="sd">    The &#39;extras&#39; are never visible through normal access, but can be obtained (or modified) upon explicit request.</span>
<span class="sd">    The PIN is implemented as a dictionary with keys and values, instead of as a python object with properties.</span>
<span class="sd">    One justification is simplicity: even if we supported properties, we&#39;d still need to support dictionaries</span>
<span class="sd">    as well. Another reason is to convey the fact that this is a low-level access library, not an object-oriented database</span>
<span class="sd">    (or object mapping) layer: the client is invited to _use_ PIN objects to control its DB access, not to</span>
<span class="sd">    _conform_ with a class hierarchy or metaclasses or interfaces (we don&#39;t interfere with the client&#39;s</span>
<span class="sd">    application design).&quot;&quot;&quot;</span>
    <span class="c"># Note: For simplicity, mExtras always contains lists, even for scalar values.</span>
    <span class="c"># TODO: If needed, may offer a function to return the full representation with all extras.</span>
    <span class="c">#--------</span>
    <span class="c"># PUBLIC: Constants.</span>
    <span class="c">#--------</span>
    <span class="c"># Special Keys.</span>
    <span class="n">SK_PID</span> <span class="o">=</span> <span class="s">&quot;__PID__&quot;</span>
    <span class="n">SK_UPDATE</span> <span class="o">=</span> <span class="s">&quot;__UPD__&quot;</span>
    <span class="c"># Affinity time offset (1600 vs 1970).</span>
    <span class="n">TIME_OFFSET</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1970</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1601</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">days</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000000</span>
    <span class="c">#--------</span>
    <span class="c"># PUBLIC: Collection.</span>
    <span class="c">#--------</span>
    <span class="k">class</span> <span class="nc">Collection</span><span class="p">(</span><span class="n">MutableSequence</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;In-memory representation of collections, overriding the natural &#39;list&#39; representation to track</span>
<span class="sd">        changes through native/std python methods for lists, and make them persistent. Not self-sufficient</span>
<span class="sd">        (i.e. dependent on the owning PIN object).&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pPIN</span><span class="p">,</span> <span class="n">pProperty</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pPIN</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">pProperty</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pProperty</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="n">InvalidParameter</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mPIN</span> <span class="o">=</span> <span class="n">pPIN</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mProperty</span> <span class="o">=</span> <span class="n">pProperty</span>
             <span class="c"># Note: It is assumed that we never need to command persistent updates, or manage the &#39;extras&#39;, at initialization.</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mList</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mList</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">__cmp__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pOther</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pOther</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="k">return</span> <span class="nb">cmp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mList</span><span class="p">,</span> <span class="n">pOther</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pOther</span><span class="p">,</span> <span class="n">PIN</span><span class="o">.</span><span class="n">Collection</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">cmp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mList</span><span class="p">,</span> <span class="n">pOther</span><span class="o">.</span><span class="n">mList</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">InvalidParameter</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mList</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mList</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mPIN</span><span class="o">.</span><span class="n">mPID</span><span class="p">:</span>
                <span class="c"># Grab the eid, and remove the corresponding &#39;extra&#39;.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mPIN</span><span class="o">.</span><span class="n">mExtras</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mProperty</span><span class="p">):</span>
                    <span class="n">lExtras</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mPIN</span><span class="o">.</span><span class="n">mExtras</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mProperty</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">isInteger</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">lExtras</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;i out of range: </span><span class="si">%d</span><span class="s"> (</span><span class="si">%d</span><span class="s"> elements)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lExtras</span><span class="p">)))</span>
                        <span class="n">lEid</span> <span class="o">=</span> <span class="n">lExtras</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mEid</span>
                        <span class="k">del</span> <span class="n">lExtras</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="c"># Record a persistent update.</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">mPIN</span><span class="o">.</span><span class="n">_handlePINUpdate</span><span class="p">(</span><span class="n">PIN</span><span class="p">({</span><span class="n">PIN</span><span class="o">.</span><span class="n">SK_PID</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">mPIN</span><span class="o">.</span><span class="n">mPID</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mProperty</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span> <span class="n">PIN</span><span class="o">.</span><span class="n">Extra</span><span class="p">(</span><span class="n">pOp</span><span class="o">=</span><span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">OP_DELETE</span><span class="p">,</span> <span class="n">pEid</span><span class="o">=</span><span class="n">lEid</span><span class="p">))}))</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
                        <span class="c"># TODO: range checks</span>
                        <span class="n">lEids</span> <span class="o">=</span> <span class="p">[</span><span class="n">iE</span><span class="o">.</span><span class="n">mEid</span> <span class="k">for</span> <span class="n">iE</span> <span class="ow">in</span> <span class="n">lExtras</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                        <span class="k">del</span> <span class="n">lExtras</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="c"># Record a persistent update.</span>
                        <span class="k">for</span> <span class="n">iEid</span> <span class="ow">in</span> <span class="n">lEids</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">mPIN</span><span class="o">.</span><span class="n">_handlePINUpdate</span><span class="p">(</span><span class="n">PIN</span><span class="p">({</span><span class="n">PIN</span><span class="o">.</span><span class="n">SK_PID</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">mPIN</span><span class="o">.</span><span class="n">mPID</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mProperty</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span> <span class="n">PIN</span><span class="o">.</span><span class="n">Extra</span><span class="p">(</span><span class="n">pOp</span><span class="o">=</span><span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">OP_DELETE</span><span class="p">,</span> <span class="n">pEid</span><span class="o">=</span><span class="n">iEid</span><span class="p">))}))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">InvalidParameter</span><span class="p">(</span><span class="s">&quot;unexpected type for i: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="c"># Modify the list itself.</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">mList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="c"># Record a persistent update.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mPIN</span><span class="o">.</span><span class="n">mPID</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mPIN</span><span class="o">.</span><span class="n">mExtras</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mProperty</span><span class="p">):</span>
                <span class="n">lExtras</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mPIN</span><span class="o">.</span><span class="n">mExtras</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mProperty</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">isInteger</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">lExtras</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;i out of range: </span><span class="si">%d</span><span class="s"> (</span><span class="si">%d</span><span class="s"> elements)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lExtras</span><span class="p">)))</span>
                    <span class="n">lEid</span> <span class="o">=</span> <span class="n">lExtras</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mEid</span>                  
                    <span class="bp">self</span><span class="o">.</span><span class="n">mPIN</span><span class="o">.</span><span class="n">_handlePINUpdate</span><span class="p">(</span><span class="n">PIN</span><span class="p">({</span><span class="n">PIN</span><span class="o">.</span><span class="n">SK_PID</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">mPIN</span><span class="o">.</span><span class="n">mPID</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mProperty</span><span class="p">:(</span><span class="n">v</span><span class="p">,</span> <span class="n">PIN</span><span class="o">.</span><span class="n">Extra</span><span class="p">(</span><span class="n">pEid</span><span class="o">=</span><span class="n">lEid</span><span class="p">))}))</span>
                <span class="c"># TODO: i can probably be a list</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">InvalidParameter</span><span class="p">(</span><span class="s">&quot;unexpected type for i: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="c"># Modify the list itself.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mPIN</span><span class="o">.</span><span class="n">mPID</span><span class="p">:</span>
                <span class="c"># Grab the eid, and insert the corresponding &#39;extra&#39;.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mPIN</span><span class="o">.</span><span class="n">mExtras</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mProperty</span><span class="p">):</span>
                    <span class="n">lExtras</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mPIN</span><span class="o">.</span><span class="n">mExtras</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mProperty</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">isInteger</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">lExtras</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;i out of range: </span><span class="si">%d</span><span class="s"> (</span><span class="si">%d</span><span class="s"> elements)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lExtras</span><span class="p">)))</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span> <span class="c"># Review: accept a PIN.Extra here?</span>
                            <span class="k">raise</span> <span class="ne">Exception</span>
                        <span class="n">lEid</span> <span class="o">=</span> <span class="n">EID_LAST_ELEMENT</span><span class="p">;</span> <span class="n">lOp</span> <span class="o">=</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">OP_ADD</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lExtras</span><span class="p">):</span>
                            <span class="n">lEid</span> <span class="o">=</span> <span class="n">lExtras</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mEid</span><span class="p">;</span> <span class="n">lOp</span> <span class="o">=</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">OP_ADD_BEFORE</span>
                        <span class="n">lExtras</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">PIN</span><span class="o">.</span><span class="n">Extra</span><span class="p">())</span> <span class="c"># Review: Can do better?</span>
                        <span class="c"># Record a persistent update.</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">mPIN</span><span class="o">.</span><span class="n">_handlePINUpdate</span><span class="p">(</span><span class="n">PIN</span><span class="p">({</span><span class="n">PIN</span><span class="o">.</span><span class="n">SK_PID</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">mPIN</span><span class="o">.</span><span class="n">mPID</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mProperty</span><span class="p">:(</span><span class="n">v</span><span class="p">,</span> <span class="n">PIN</span><span class="o">.</span><span class="n">Extra</span><span class="p">(</span><span class="n">pOp</span><span class="o">=</span><span class="n">lOp</span><span class="p">,</span> <span class="n">pEid</span><span class="o">=</span><span class="n">lEid</span><span class="p">))}))</span>
                    <span class="c"># TODO: i can probably be a list</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">InvalidParameter</span><span class="p">(</span><span class="s">&quot;unexpected type for i: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="c"># Modify the list itself.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mList</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">sort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">cmp</span><span class="o">=</span><span class="nb">cmp</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
            <span class="c"># TODO: review... slightly incorrect... see ruby version for corrections...</span>
            <span class="c"># More for fun than anything; demonstrates ease of use.</span>
            <span class="c"># Collect the list of values to sort.</span>
            <span class="n">lToSort</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">mList</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">mPIN</span><span class="o">.</span><span class="n">getExtra</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mProperty</span><span class="p">,</span> <span class="n">pEpos</span><span class="o">=</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">mEid</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mList</span><span class="p">))]</span>
            <span class="c"># Sort them in memory.</span>
            <span class="n">lToSort</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="nb">cmp</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">key</span><span class="p">,</span> <span class="n">reverse</span><span class="p">)</span>
            <span class="c"># Apply that ordering to the persistent state (in the context of the current transaction).</span>
            <span class="n">lExtras</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mPIN</span><span class="o">.</span><span class="n">mExtras</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mProperty</span><span class="p">]</span>
            <span class="n">lPrevEid</span> <span class="o">=</span> <span class="n">EID_FIRST_ELEMENT</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">iTuple</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lToSort</span><span class="p">)),</span> <span class="n">lToSort</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">lExtras</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mEid</span> <span class="o">==</span> <span class="n">iTuple</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="c"># This element is already at the right place - don&#39;t touch it.</span>
                    <span class="n">lPrevEid</span> <span class="o">=</span> <span class="n">iTuple</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">iTuple</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span>
                <span class="c"># Move the element in memory, first.</span>
                <span class="n">lV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mList</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">iTuple</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mList</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">lV</span><span class="p">)</span>
                <span class="n">lE</span> <span class="o">=</span> <span class="n">lExtras</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">iTuple</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">lExtras</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">lE</span><span class="p">)</span>
                <span class="c"># Record a persistent update.</span>
                <span class="n">lOp</span> <span class="o">=</span> <span class="p">(</span><span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">OP_MOVE_BEFORE</span><span class="p">,</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">OP_MOVE</span><span class="p">)[</span><span class="n">lPrevEid</span> <span class="o">!=</span> <span class="n">EID_FIRST_ELEMENT</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mPIN</span><span class="o">.</span><span class="n">_handlePINUpdate</span><span class="p">(</span><span class="n">PIN</span><span class="p">({</span><span class="n">PIN</span><span class="o">.</span><span class="n">SK_PID</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">mPIN</span><span class="o">.</span><span class="n">mPID</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mProperty</span><span class="p">:(</span><span class="n">lPrevEid</span><span class="p">,</span> <span class="n">PIN</span><span class="o">.</span><span class="n">Extra</span><span class="p">(</span><span class="n">pType</span><span class="o">=</span><span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_UINT</span><span class="p">,</span> <span class="n">pOp</span><span class="o">=</span><span class="n">lOp</span><span class="p">,</span> <span class="n">pEid</span><span class="o">=</span><span class="n">iTuple</span><span class="p">[</span><span class="mi">1</span><span class="p">]))}))</span>
                <span class="n">lPrevEid</span> <span class="o">=</span> <span class="n">iTuple</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mList</span><span class="p">)</span>
    <span class="c">#--------</span>
    <span class="c"># PUBLIC: Extra class.</span>
    <span class="c">#--------</span>
    <span class="k">class</span> <span class="nc">Extra</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Semi-hidden representation of all the Affinity adornments on a plain value (e.g. eid, meta, type, op, etc.).</span>
<span class="sd">        This allows to present the PIN as a simple dictionary where keys are property names, and values are native python values.</span>
<span class="sd">        Everything else is hidden as &#39;extras&#39;, and used mostly transparently when needed.&quot;&quot;&quot;</span>
        <span class="n">OP_NAMES</span> <span class="o">=</span> \
            <span class="p">(</span><span class="s">&quot;OP_SET&quot;</span><span class="p">,</span> <span class="s">&quot;OP_ADD&quot;</span><span class="p">,</span> <span class="s">&quot;OP_ADD_BEFORE&quot;</span><span class="p">,</span> <span class="s">&quot;OP_MOVE&quot;</span><span class="p">,</span> <span class="s">&quot;OP_MOVE_BEFORE&quot;</span><span class="p">,</span> <span class="s">&quot;OP_DELETE&quot;</span><span class="p">,</span> <span class="s">&quot;OP_EDIT&quot;</span><span class="p">,</span> <span class="s">&quot;OP_RENAME&quot;</span><span class="p">,</span> \
             <span class="s">&quot;OP_PLUS&quot;</span><span class="p">,</span> <span class="s">&quot;OP_MINUS&quot;</span><span class="p">,</span> <span class="s">&quot;OP_MUL&quot;</span><span class="p">,</span> <span class="s">&quot;OP_DIV&quot;</span><span class="p">,</span> <span class="s">&quot;OP_MOD&quot;</span><span class="p">,</span> <span class="s">&quot;OP_NEG&quot;</span><span class="p">,</span> <span class="s">&quot;OP_NOT&quot;</span><span class="p">,</span> <span class="s">&quot;OP_AND&quot;</span><span class="p">,</span> <span class="s">&quot;OP_OR&quot;</span><span class="p">,</span> <span class="s">&quot;OP_XOR&quot;</span><span class="p">,</span> \
             <span class="s">&quot;OP_LSHIFT&quot;</span><span class="p">,</span> <span class="s">&quot;OP_RSHIFT&quot;</span><span class="p">,</span> <span class="s">&quot;OP_MIN&quot;</span><span class="p">,</span> <span class="s">&quot;OP_MAX&quot;</span><span class="p">,</span> <span class="s">&quot;OP_ABS&quot;</span><span class="p">,</span> <span class="s">&quot;OP_LN&quot;</span><span class="p">,</span> <span class="s">&quot;OP_EXP&quot;</span><span class="p">,</span> <span class="s">&quot;OP_POW&quot;</span><span class="p">,</span> <span class="s">&quot;OP_SQRT&quot;</span><span class="p">,</span> \
             <span class="s">&quot;OP_FLOOR&quot;</span><span class="p">,</span> <span class="s">&quot;OP_CEIL&quot;</span><span class="p">,</span> <span class="s">&quot;OP_CONCAT&quot;</span><span class="p">,</span> <span class="s">&quot;OP_LOWER&quot;</span><span class="p">,</span> <span class="s">&quot;OP_UPPER&quot;</span><span class="p">,</span> <span class="s">&quot;OP_TONUM&quot;</span><span class="p">,</span> \
             <span class="s">&quot;OP_TOINUM&quot;</span><span class="p">,</span> <span class="s">&quot;OP_CAST&quot;</span><span class="p">)</span> <span class="c"># Review: could this be done with introspection?</span>
        <span class="n">VT_NAMES</span> <span class="o">=</span> \
            <span class="p">(</span><span class="s">&quot;VT_ANY&quot;</span><span class="p">,</span> \
             <span class="s">&quot;VT_INT&quot;</span><span class="p">,</span> <span class="s">&quot;VT_UINT&quot;</span><span class="p">,</span> <span class="s">&quot;VT_INT64&quot;</span><span class="p">,</span> <span class="s">&quot;VT_UINT64&quot;</span><span class="p">,</span> \
             <span class="s">&quot;VT_FLOAT&quot;</span><span class="p">,</span> <span class="s">&quot;VT_DOUBLE&quot;</span><span class="p">,</span> <span class="s">&quot;VT_BOOL&quot;</span><span class="p">,</span> \
             <span class="s">&quot;VT_DATETIME&quot;</span><span class="p">,</span> <span class="s">&quot;VT_INTERVAL&quot;</span><span class="p">,</span> \
             <span class="s">&quot;VT_URIID&quot;</span><span class="p">,</span> <span class="s">&quot;VT_IDENTITY&quot;</span><span class="p">,</span> <span class="s">&quot;VT_ENUM&quot;</span><span class="p">,</span> \
             <span class="s">&quot;VT_STRING&quot;</span><span class="p">,</span> <span class="s">&quot;VT_BSTR&quot;</span><span class="p">,</span> <span class="s">&quot;VT_URL&quot;</span><span class="p">,</span> \
             <span class="s">&quot;[undefined-16]&quot;</span><span class="p">,</span> <span class="s">&quot;VT_REFID&quot;</span><span class="p">,</span> <span class="s">&quot;[undefined-18]&quot;</span><span class="p">,</span> <span class="s">&quot;VT_REFIDPROP&quot;</span><span class="p">,</span> <span class="s">&quot;[undefined-20]&quot;</span><span class="p">,</span> <span class="s">&quot;VT_REFIDELT&quot;</span><span class="p">,</span> \
             <span class="s">&quot;VT_EXPR&quot;</span><span class="p">,</span> <span class="s">&quot;VT_QUERY&quot;</span><span class="p">,</span> \
             <span class="s">&quot;VT_ARRAY&quot;</span><span class="p">,</span> <span class="s">&quot;[undefined-25]&quot;</span><span class="p">,</span> <span class="s">&quot;VT_STRUCT&quot;</span><span class="p">,</span> <span class="s">&quot;VT_MAP&quot;</span><span class="p">,</span> <span class="s">&quot;VT_RANGE&quot;</span><span class="p">,</span> <span class="s">&quot;[undefined-29]&quot;</span><span class="p">,</span> <span class="s">&quot;VT_CURRENT&quot;</span><span class="p">)</span> <span class="c"># Review: can this be done with introspection?</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pPropID</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pType</span><span class="o">=</span><span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_ANY</span><span class="p">,</span> <span class="n">pOp</span><span class="o">=</span><span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">OP_SET</span><span class="p">,</span> <span class="n">pEid</span><span class="o">=</span><span class="n">EID_COLLECTION</span><span class="p">,</span> <span class="n">pMeta</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mPropID</span> <span class="o">=</span> <span class="n">pPropID</span> <span class="c"># Conceptually redundant with the key, but kept for efficiency, since Affinity doesn&#39;t require a StringMap for existing propids.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mType</span> <span class="o">=</span> <span class="n">pType</span> <span class="c"># There are cases where a single native python value type covers multiple Affinity VT types... so we keep the actual specific type for future updates.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mOp</span> <span class="o">=</span> <span class="n">pOp</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mEid</span> <span class="o">=</span> <span class="n">pEid</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mMeta</span> <span class="o">=</span> <span class="n">pMeta</span>
        <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">:</span><span class="si">%x</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">PIN</span><span class="o">.</span><span class="n">Extra</span><span class="o">.</span><span class="n">OP_NAMES</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mOp</span><span class="p">],</span> <span class="n">PIN</span><span class="o">.</span><span class="n">Extra</span><span class="o">.</span><span class="n">VT_NAMES</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mType</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">mEid</span><span class="p">)</span>
        <span class="nd">@classmethod</span>
        <span class="k">def</span> <span class="nf">createFromPB</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">pPBValue</span><span class="p">):</span>
            <span class="s">&quot;Create a &#39;Extra&#39; instance for the specified affinity_pb2.Value.&quot;</span>
            <span class="k">return</span> <span class="n">PIN</span><span class="o">.</span><span class="n">Extra</span><span class="p">(</span><span class="n">pPropID</span><span class="o">=</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">property</span><span class="p">,</span> <span class="n">pType</span><span class="o">=</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">pOp</span><span class="o">=</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">op</span><span class="p">,</span> <span class="n">pEid</span><span class="o">=</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="n">pMeta</span><span class="o">=</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">meta</span><span class="p">)</span>
    <span class="c">#--------</span>
    <span class="c"># PUBLIC: PID &amp; Ref classes.</span>
    <span class="c">#--------</span>
    <span class="k">class</span> <span class="nc">PID</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;PID native (non-PB) representation.&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pLocalPID</span><span class="p">,</span> <span class="n">pIdent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">isInteger</span><span class="p">(</span><span class="n">pLocalPID</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">isInteger</span><span class="p">(</span><span class="n">pIdent</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">InvalidParameter</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mLocalPID</span> <span class="o">=</span> <span class="n">pLocalPID</span> <span class="c"># 64-bit unsigned integer.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mIdent</span> <span class="o">=</span> <span class="n">pIdent</span> <span class="c"># 32-bit unsigned integer.</span>
        <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pOther</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">None</span> <span class="o">==</span> <span class="n">pOther</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="n">lOther</span> <span class="o">=</span> <span class="n">pOther</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lOther</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__repr__</span><span class="p">()</span> <span class="o">==</span> <span class="n">lOther</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lOther</span><span class="p">,</span> <span class="n">PIN</span><span class="p">):</span>
                <span class="n">lOther</span> <span class="o">=</span> <span class="n">lOther</span><span class="o">.</span><span class="n">mPID</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mLocalPID</span> <span class="o">!=</span> <span class="n">lOther</span><span class="o">.</span><span class="n">mLocalPID</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mIdent</span> <span class="o">!=</span> <span class="n">lOther</span><span class="o">.</span><span class="n">mIdent</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;@</span><span class="si">%x</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">mLocalPID</span>
        <span class="nd">@classmethod</span>
        <span class="k">def</span> <span class="nf">fromPB</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">pPBPID</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">PIN</span><span class="o">.</span><span class="n">PID</span><span class="p">(</span><span class="n">pPBPID</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">pPBPID</span><span class="o">.</span><span class="n">ident</span><span class="p">)</span>
    <span class="k">class</span> <span class="nc">Ref</span><span class="p">(</span><span class="n">PID</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;PIN reference native (non-PB) representation.&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pLocalPID</span><span class="p">,</span> <span class="n">pIdent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pProperty</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pEid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">PIN</span><span class="o">.</span><span class="n">Ref</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">pLocalPID</span><span class="p">,</span> <span class="n">pIdent</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mProperty</span> <span class="o">=</span> <span class="n">pProperty</span> <span class="c"># Property name, or None.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mEid</span> <span class="o">=</span> <span class="n">pEid</span> <span class="c"># 32-bit unsigned integer, or None.</span>
        <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pOther</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">None</span> <span class="o">==</span> <span class="n">pOther</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="n">lOther</span> <span class="o">=</span> <span class="n">pOther</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lOther</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__repr__</span><span class="p">()</span> <span class="o">==</span> <span class="n">lOther</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lOther</span><span class="p">,</span> <span class="n">PIN</span><span class="p">):</span>
                <span class="n">lOther</span> <span class="o">=</span> <span class="n">lOther</span><span class="o">.</span><span class="n">mPID</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mLocalPID</span> <span class="o">!=</span> <span class="n">lOther</span><span class="o">.</span><span class="n">mLocalPID</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mIdent</span> <span class="o">!=</span> <span class="n">lOther</span><span class="o">.</span><span class="n">mIdent</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mProperty</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">lOther</span><span class="p">,</span> <span class="s">&#39;mProperty&#39;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="bp">False</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mProperty</span> <span class="o">!=</span> <span class="n">lOther</span><span class="o">.</span><span class="n">mProperty</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mEid</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">lOther</span><span class="p">,</span> <span class="s">&#39;mEid&#39;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="bp">False</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mEid</span> <span class="o">!=</span> <span class="n">lOther</span><span class="o">.</span><span class="n">mEid</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">False</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mEid</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&quot;@</span><span class="si">%x</span><span class="s">.</span><span class="si">%s</span><span class="s">[</span><span class="si">%d</span><span class="s">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mLocalPID</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mProperty</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mEid</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mProperty</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&quot;@</span><span class="si">%x</span><span class="s">.</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mLocalPID</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mProperty</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">PIN</span><span class="o">.</span><span class="n">Ref</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__repr__</span><span class="p">()</span>
        <span class="nd">@classmethod</span>
        <span class="k">def</span> <span class="nf">fromPID</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">pPID</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">PIN</span><span class="o">.</span><span class="n">Ref</span><span class="p">(</span><span class="n">pPID</span><span class="o">.</span><span class="n">mLocalPID</span><span class="p">,</span> <span class="n">pPID</span><span class="o">.</span><span class="n">mIdent</span><span class="p">)</span>
    <span class="c">#--------</span>
    <span class="c"># PUBLIC: Url class.</span>
    <span class="c">#--------</span>
    <span class="k">class</span> <span class="nc">Url</span><span class="p">(</span><span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;To distinguish a URI from a plain string.&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">str</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="k">pass</span>
    <span class="c">#--------</span>
    <span class="c"># PUBLIC: PIN update descriptor.</span>
    <span class="c">#--------</span>
    <span class="k">class</span> <span class="nc">PINUpdate</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Special marker on PIN objects, to identify that they represent updates, not the full PIN.</span>
<span class="sd">        Also allows to track other in-memory instances, and update them according to the changes effected by this update.</span>
<span class="sd">        Currently, we only support a single &#39;other&#39; PIN, and only for eid inserts.&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pOtherPINs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mOtherPINs</span> <span class="o">=</span> <span class="n">pOtherPINs</span>
    <span class="c">#--------</span>
    <span class="c"># PUBLIC: Core overrides for dict base class.</span>
    <span class="c">#--------</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="s">&quot;Constructor. Extracts the &#39;PID&#39; argument, if specified, and redirects initialization of properties to the &#39;update&#39; method.&quot;</span>
        <span class="k">def</span> <span class="nf">_assignPID</span><span class="p">(</span><span class="n">_pPID</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_pPID</span><span class="p">,</span> <span class="n">PIN</span><span class="o">.</span><span class="n">PID</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">InvalidParameter</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mPID</span> <span class="o">=</span> <span class="n">_pPID</span>
        <span class="k">def</span> <span class="nf">_getSpecialValue</span><span class="p">(</span><span class="n">_pSpecialKey</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">_pSpecialKey</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">_pSpecialKey</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">_pSpecialKey</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">_pSpecialKey</span><span class="p">]</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mExtras</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># Same layout as the main dict, but the values are instances of Extra.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mPID</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c"># Assign the PID after we update, to distinguish initialization from actual updates (in __setitem__),</span>
        <span class="c"># and avoid an infinite recursion of save-create-save-create...</span>
        <span class="c"># Review: to further reduce risk of collision with real properties, could use special (e.g. numeric/custom class) keys...</span>
        <span class="n">lPID</span> <span class="o">=</span> <span class="n">_getSpecialValue</span><span class="p">(</span><span class="n">PIN</span><span class="o">.</span><span class="n">SK_PID</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lPID</span><span class="p">:</span>
            <span class="n">_assignPID</span><span class="p">(</span><span class="n">lPID</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mIsUpdate</span> <span class="o">=</span> <span class="n">_getSpecialValue</span><span class="p">(</span><span class="n">PIN</span><span class="o">.</span><span class="n">SK_UPDATE</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mIsUpdate</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mIsUpdate</span><span class="p">,</span> <span class="n">PIN</span><span class="o">.</span><span class="n">PINUpdate</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">InvalidParameter</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pKey</span><span class="p">,</span> <span class="n">pValue</span><span class="p">):</span>
        <span class="s">&quot;Override of the dict implementation, to extract the optional &#39;Extra&#39; specification and store it separately.&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pValue</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">MutableSequence</span><span class="p">)):</span>          
            <span class="k">if</span> <span class="mi">2</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">pValue</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pValue</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">PIN</span><span class="o">.</span><span class="n">Extra</span><span class="p">):</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">PIN</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="n">pKey</span><span class="p">,</span> <span class="n">pValue</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mExtras</span><span class="p">[</span><span class="n">pKey</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">pValue</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">elif</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pValue</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pValue</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">MutableSequence</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pValue</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">PIN</span><span class="o">.</span><span class="n">Extra</span><span class="p">):</span>
                    <span class="nb">super</span><span class="p">(</span><span class="n">PIN</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="n">pKey</span><span class="p">,</span> <span class="n">PIN</span><span class="o">.</span><span class="n">Collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pKey</span><span class="p">,</span> <span class="p">[</span><span class="n">iV</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">iV</span> <span class="ow">in</span> <span class="n">pValue</span><span class="p">]))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mExtras</span><span class="p">[</span><span class="n">pKey</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">iV</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">iV</span> <span class="ow">in</span> <span class="n">pValue</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">InvalidParameter</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">super</span><span class="p">(</span><span class="n">PIN</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="n">pKey</span><span class="p">,</span> <span class="n">PIN</span><span class="o">.</span><span class="n">Collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pKey</span><span class="p">,</span> <span class="n">pValue</span><span class="p">))</span>
                <span class="n">lExtras</span> <span class="o">=</span> <span class="p">[</span><span class="n">PIN</span><span class="o">.</span><span class="n">Extra</span><span class="p">()]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pValue</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">lExtras</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PIN</span><span class="o">.</span><span class="n">Extra</span><span class="p">(</span><span class="n">pOp</span><span class="o">=</span><span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">OP_ADD</span><span class="p">,</span> <span class="n">pEid</span><span class="o">=</span><span class="n">EID_LAST_ELEMENT</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mExtras</span><span class="p">[</span><span class="n">pKey</span><span class="p">]</span> <span class="o">=</span> <span class="n">lExtras</span> <span class="c"># Simplifies things by guarantying that there are &#39;extras&#39; everywhere... but may want to refine this.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">PIN</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="n">pKey</span><span class="p">,</span> <span class="n">pValue</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mExtras</span><span class="p">[</span><span class="n">pKey</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">PIN</span><span class="o">.</span><span class="n">Extra</span><span class="p">()]</span> <span class="c"># Simplifies things by guarantying that there are &#39;extras&#39; everywhere... but may want to refine this.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mPID</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handlePINUpdate</span><span class="p">(</span><span class="n">PIN</span><span class="p">({</span><span class="n">PIN</span><span class="o">.</span><span class="n">SK_PID</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">mPID</span><span class="p">,</span> <span class="n">pKey</span><span class="p">:</span><span class="n">pValue</span><span class="p">}))</span>
    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pKey</span><span class="p">):</span>
        <span class="s">&quot;Override of the dict implementation, to cleanup the corresponding &#39;Extra&#39; items.&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PIN</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__delitem__</span><span class="p">(</span><span class="n">pKey</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mExtras</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">pKey</span><span class="p">):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">mExtras</span><span class="p">[</span><span class="n">pKey</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mPID</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handlePINUpdate</span><span class="p">(</span><span class="n">PIN</span><span class="p">({</span><span class="n">PIN</span><span class="o">.</span><span class="n">SK_PID</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">mPID</span><span class="p">,</span> <span class="n">pKey</span><span class="p">:(</span><span class="mi">0</span><span class="p">,</span> <span class="n">PIN</span><span class="o">.</span><span class="n">Extra</span><span class="p">(</span><span class="n">pOp</span><span class="o">=</span><span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">OP_DELETE</span><span class="p">))}))</span>
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="s">&quot;Override of the dict implementation, to extract the optional &#39;Extra&#39; specifications and store them separately.&quot;</span>
        <span class="k">def</span> <span class="nf">_assign</span><span class="p">(</span><span class="n">_pDict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">_lKey</span> <span class="ow">in</span> <span class="n">_pDict</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">_lKey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">PIN</span><span class="o">.</span><span class="n">SK_PID</span><span class="p">,</span> <span class="n">PIN</span><span class="o">.</span><span class="n">SK_UPDATE</span><span class="p">):</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">_lKey</span><span class="p">]</span> <span class="o">=</span> <span class="n">_pDict</span><span class="p">[</span><span class="n">_lKey</span><span class="p">]</span>
        <span class="c"># &#39;update&#39; accepts a positional argument that must be a dictionary.</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;PIN::update expected at most 1 positional argument, got </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;PIN::update expected at the positional argument to be a dict, not a </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">lOther</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">_assign</span><span class="p">(</span><span class="n">lOther</span><span class="p">)</span>
        <span class="c"># &#39;update&#39; also accepts keyword arguments, where the argument name is used as a key, and the value of the argument as the corresponding value.</span>
        <span class="n">_assign</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lRepr</span> <span class="o">=</span> <span class="s">&quot;PIN &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mPID</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; {</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="n">lRepr</span> <span class="o">+=</span> <span class="s">&quot;  data: &quot;</span> <span class="o">+</span> <span class="nb">super</span><span class="p">(</span><span class="n">PIN</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__repr__</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="n">lRepr</span> <span class="o">+=</span> <span class="s">&quot;  extras: &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mExtras</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="n">lRepr</span> <span class="o">+=</span> <span class="s">&quot;}&quot;</span>
        <span class="k">return</span> <span class="n">lRepr</span>
    <span class="c">#--------</span>
    <span class="c"># PUBLIC: Direct access to &#39;Extras&#39;.</span>
    <span class="c">#--------</span>
    <span class="k">def</span> <span class="nf">getExtra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pProperty</span><span class="p">,</span> <span class="n">pEid</span><span class="o">=</span><span class="n">EID_COLLECTION</span><span class="p">,</span> <span class="n">pEpos</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="s">&quot;Return the &#39;Extra&#39; structure associated with the value specified by pProperty and either pEid or pEpos.&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mExtras</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">pProperty</span><span class="p">):</span>
            <span class="n">lExtras</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mExtras</span><span class="p">[</span><span class="n">pProperty</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pEpos</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">pEpos</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lExtras</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">lExtras</span><span class="p">[</span><span class="n">pEpos</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">pEid</span> <span class="o">!=</span> <span class="n">EID_COLLECTION</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">iV</span> <span class="ow">in</span> <span class="n">lExtras</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">iV</span><span class="o">.</span><span class="n">mEid</span> <span class="o">==</span> <span class="n">pEid</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">iV</span>
            <span class="k">elif</span> <span class="mi">1</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">lExtras</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">lExtras</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InvalidParameter</span><span class="p">(</span><span class="s">&quot;Invalid pEid or pEpos&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">InvalidParameter</span><span class="p">(</span><span class="s">&quot;Invalid property: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">pProperty</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">setExtra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pProperty</span><span class="p">,</span> <span class="n">pExtra</span><span class="p">,</span> <span class="n">pEid</span><span class="o">=</span><span class="n">EID_COLLECTION</span><span class="p">,</span> <span class="n">pEpos</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="s">&quot;Replace the &#39;Extra&#39; structure associated with the value specified by pProperty and either pEid or pEpos, with pExtra.&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mExtras</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">pProperty</span><span class="p">):</span>
            <span class="n">lExtras</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mExtras</span><span class="p">[</span><span class="n">pProperty</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pEpos</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">pEpos</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lExtras</span><span class="p">):</span>
                <span class="n">lExtras</span><span class="p">[</span><span class="n">pEpos</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">pExtra</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="n">pEid</span> <span class="o">!=</span> <span class="n">EID_COLLECTION</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">iV</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lExtras</span><span class="p">)),</span> <span class="n">lExtras</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">iV</span><span class="o">.</span><span class="n">mEid</span> <span class="o">==</span> <span class="n">pEid</span><span class="p">:</span>
                        <span class="n">lExtras</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">pExtra</span><span class="p">)</span>
                        <span class="k">return</span>
            <span class="k">elif</span> <span class="mi">1</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">lExtras</span><span class="p">):</span>
                <span class="n">lExtras</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">pExtra</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">InvalidParameter</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">markAsUpdate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pUpdate</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pUpdate</span><span class="p">,</span> <span class="n">PIN</span><span class="o">.</span><span class="n">PINUpdate</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">InvalidParameter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mIsUpdate</span> <span class="o">=</span> <span class="n">pUpdate</span>
    <span class="c">#--------</span>
    <span class="c"># PUBLIC: PIN saving (to Affinity). Note: At this level of the API, a PIN can represent a whole Affinity PIN, or just a set of updates to be applied on an actual Affinity PIN.</span>
    <span class="c">#--------</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_savePINsi</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">pPINs</span><span class="p">,</span> <span class="n">pTxCtx</span><span class="p">):</span>
        <span class="s">&quot;[internal] Core  implementation of savePINs.&quot;</span>
        <span class="k">def</span> <span class="nf">_insertsCollectionElements</span><span class="p">(</span><span class="n">_pPBPin</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">_iV</span> <span class="ow">in</span> <span class="n">_pPBPin</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">_iV</span><span class="o">.</span><span class="n">op</span> <span class="ow">in</span> <span class="p">(</span><span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">OP_ADD</span><span class="p">,</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">OP_ADD_BEFORE</span><span class="p">):</span>
                    <span class="k">return</span> <span class="bp">True</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">pPINs</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">None</span> <span class="o">==</span> <span class="n">pTxCtx</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidParameter</span><span class="p">()</span>
        <span class="c"># Prepare the StringMap of properties.</span>
        <span class="n">lPropDictLen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pTxCtx</span><span class="o">.</span><span class="n">mPropDict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">iPin</span> <span class="ow">in</span> <span class="n">pPINs</span><span class="p">:</span>
            <span class="n">iPin</span><span class="o">.</span><span class="n">_preparePBPropIDs</span><span class="p">(</span><span class="n">pTxCtx</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pTxCtx</span><span class="o">.</span><span class="n">mPropDict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&gt;</span> <span class="n">lPropDictLen</span><span class="p">:</span>
            <span class="n">pTxCtx</span><span class="o">.</span><span class="n">capture</span><span class="p">()</span>
        <span class="c"># Serialize the PINs.</span>
        <span class="k">for</span> <span class="n">iPin</span> <span class="ow">in</span> <span class="n">pPINs</span><span class="p">:</span>
            <span class="n">lPBPin</span> <span class="o">=</span> <span class="n">pTxCtx</span><span class="o">.</span><span class="n">getPBStream</span><span class="p">()</span><span class="o">.</span><span class="n">pins</span><span class="o">.</span><span class="n">add</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">iPin</span><span class="o">.</span><span class="n">mPID</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">lPBPin</span><span class="o">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">AfyStream</span><span class="o">.</span><span class="n">OP_UPDATE</span>
                <span class="n">lPBPin</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">iPin</span><span class="o">.</span><span class="n">mPID</span><span class="o">.</span><span class="n">mLocalPID</span>
                <span class="n">lPBPin</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">ident</span> <span class="o">=</span> <span class="n">iPin</span><span class="o">.</span><span class="n">mPID</span><span class="o">.</span><span class="n">mIdent</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lPBPin</span><span class="o">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">AfyStream</span><span class="o">.</span><span class="n">OP_INSERT</span>
            <span class="n">iPin</span><span class="o">.</span><span class="n">_preparePBValues</span><span class="p">(</span><span class="n">pTxCtx</span><span class="p">,</span> <span class="n">lPBPin</span><span class="p">)</span>
            <span class="n">lPBPin</span><span class="o">.</span><span class="n">rtt</span> <span class="o">=</span> <span class="p">(</span><span class="n">affinity_pb2</span><span class="o">.</span><span class="n">RT_PIDS</span><span class="p">,</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">RT_PINS</span><span class="p">)[</span><span class="n">_insertsCollectionElements</span><span class="p">(</span><span class="n">lPBPin</span><span class="p">)]</span>
            <span class="c">#print (&quot;requested rtt=%s&quot; % lPBPin.rtt)</span>
            <span class="n">lPBPin</span><span class="o">.</span><span class="n">nValues</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lPBPin</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pPINs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pTxCtx</span><span class="o">.</span><span class="n">capture</span><span class="p">()</span>        
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">savePINs</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">pPINs</span><span class="p">,</span> <span class="n">pTxCtx</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s">&quot;Save pPINs to the store.&quot;</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">pPINs</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="c"># Serialize, and request an immediate response (synchronous reception of resulting PIDs, eids etc.).</span>
        <span class="n">lTxCtx</span> <span class="o">=</span> <span class="n">pTxCtx</span> <span class="ow">or</span> <span class="n">AFFINITY</span><span class="p">()</span><span class="o">.</span><span class="n">_txCtx</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">_savePINsi</span><span class="p">(</span><span class="n">pPINs</span><span class="p">,</span> <span class="n">lTxCtx</span><span class="p">)</span>
            <span class="n">lTxCtx</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="c"># Handle errors.</span>
        <span class="k">if</span> <span class="n">lTxCtx</span><span class="o">.</span><span class="n">mRC</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;failed to save PINs.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="c"># Determine if we need to process the output.</span>
        <span class="n">lProcessOutput</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">lTxCtx</span><span class="o">.</span><span class="n">isOutputIgnored</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lProcessOutput</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">iP</span> <span class="ow">in</span> <span class="n">pPINs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">iP</span><span class="o">.</span><span class="n">mIsUpdate</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">iP</span><span class="o">.</span><span class="n">mIsUpdate</span><span class="o">.</span><span class="n">mOtherPINs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">lProcessOutput</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lProcessOutput</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">lTxCtx</span><span class="o">.</span><span class="n">mPBOutput</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pPINs</span>
        <span class="c"># Obtain the resulting IDs generated by Affinity.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lTxCtx</span><span class="o">.</span><span class="n">mPBOutput</span><span class="o">.</span><span class="n">pins</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pPINs</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> PINs were saved, but response contained only </span><span class="si">%s</span><span class="s"> PINs.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pPINs</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">lTxCtx</span><span class="o">.</span><span class="n">mPBOutput</span><span class="o">.</span><span class="n">pins</span><span class="p">)))</span>
        <span class="n">lReadCtx</span> <span class="o">=</span> <span class="n">PBReadCtx</span><span class="p">(</span><span class="n">lTxCtx</span><span class="o">.</span><span class="n">mPBOutput</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">iPBPin</span><span class="p">,</span> <span class="n">iPin</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lTxCtx</span><span class="o">.</span><span class="n">mPBOutput</span><span class="o">.</span><span class="n">pins</span><span class="p">,</span> <span class="n">pPINs</span><span class="p">):</span>
            <span class="c"># Substitute iPin if it&#39;s an update PIN on an identified actual PIN.</span>
            <span class="c"># Review: lots of potential improvements and verifications...</span>
            <span class="n">lPin</span> <span class="o">=</span> <span class="n">iPin</span>
            <span class="k">if</span> <span class="n">iPin</span><span class="o">.</span><span class="n">mIsUpdate</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">iPin</span><span class="o">.</span><span class="n">mIsUpdate</span><span class="o">.</span><span class="n">mOtherPINs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lPin</span> <span class="o">=</span> <span class="n">iPin</span><span class="o">.</span><span class="n">mIsUpdate</span><span class="o">.</span><span class="n">mOtherPINs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c"># The PID.</span>
            <span class="k">if</span> <span class="n">lPin</span><span class="o">.</span><span class="n">mPID</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">lPin</span><span class="o">.</span><span class="n">mPID</span><span class="o">.</span><span class="n">mLocalPID</span> <span class="o">!=</span> <span class="n">iPBPin</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Expected PID </span><span class="si">%s</span><span class="s"> but received </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lPin</span><span class="o">.</span><span class="n">mPID</span><span class="o">.</span><span class="n">mLocalPID</span><span class="p">,</span> <span class="n">iPBPin</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lPin</span><span class="o">.</span><span class="n">mPID</span> <span class="o">=</span> <span class="n">PIN</span><span class="o">.</span><span class="n">PID</span><span class="p">(</span><span class="n">pLocalPID</span><span class="o">=</span><span class="n">iPBPin</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">pIdent</span><span class="o">=</span><span class="n">iPBPin</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">ident</span><span class="p">)</span>
            <span class="c"># The eids.</span>
            <span class="c"># TODO: review if in Sonny&#39;s java impl, he took care of patching the resulting eids...</span>
            <span class="k">for</span> <span class="n">iV</span> <span class="ow">in</span> <span class="n">iPBPin</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                <span class="n">lPN</span> <span class="o">=</span> <span class="n">lReadCtx</span><span class="o">.</span><span class="n">getPropName</span><span class="p">(</span><span class="n">iV</span><span class="o">.</span><span class="n">property</span><span class="p">)</span>
                <span class="n">lExtra</span> <span class="o">=</span> <span class="n">lPin</span><span class="o">.</span><span class="n">mExtras</span><span class="p">[</span><span class="n">lPN</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_ARRAY</span> <span class="o">==</span> <span class="n">iV</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">iE</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">xrange</span><span class="p">(</span><span class="n">iV</span><span class="o">.</span><span class="n">varray</span><span class="o">.</span><span class="n">l</span><span class="p">),</span> <span class="n">iV</span><span class="o">.</span><span class="n">varray</span><span class="o">.</span><span class="n">v</span><span class="p">):</span> <span class="c"># Review: always true?</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">lExtra</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mEid</span> <span class="ow">in</span> <span class="p">(</span><span class="n">EID_COLLECTION</span><span class="p">,</span> <span class="n">EID_LAST_ELEMENT</span><span class="p">,</span> <span class="n">EID_FIRST_ELEMENT</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">lExtra</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mOp</span> <span class="ow">in</span> <span class="p">(</span><span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">OP_ADD</span><span class="p">,</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">OP_ADD_BEFORE</span><span class="p">)):</span>
                            <span class="n">lExtra</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mEid</span> <span class="o">=</span> <span class="n">iE</span><span class="o">.</span><span class="n">eid</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;obtained eid=</span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">iE</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="n">lPN</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">lExtra</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mOp</span> <span class="ow">in</span> <span class="p">(</span><span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">OP_ADD</span><span class="p">,</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">OP_ADD_BEFORE</span><span class="p">):</span>
                    <span class="n">lExtra</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mEid</span> <span class="o">=</span> <span class="n">iV</span><span class="o">.</span><span class="n">eid</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;obtained eid=</span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">iV</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="n">lPN</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;didn&#39;t obtain eid (</span><span class="si">%s</span><span class="s">): </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lPN</span><span class="p">,</span> <span class="n">iV</span><span class="p">))</span>
        <span class="n">lTxCtx</span><span class="o">.</span><span class="n">mPBOutput</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">pPINs</span>
    <span class="k">def</span> <span class="nf">savePIN</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pTxCtx</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s">&quot;Save self to the store.&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;saving </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="n">PIN</span><span class="o">.</span><span class="n">savePINs</span><span class="p">([</span><span class="bp">self</span><span class="p">],</span> <span class="n">pTxCtx</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="c">#--------</span>
    <span class="c"># PUBLIC: Helpers for PIN modifications.</span>
    <span class="c">#--------</span>
    <span class="k">def</span> <span class="nf">addElement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pProperty</span><span class="p">,</span> <span class="n">pValue</span><span class="p">,</span> <span class="n">pAlwaysCollection</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="s">&quot;Add a value for pProperty; if pProperty doesn&#39;t exist yet, create it (if pAlwaysCollection, create a 1-element collection).&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">pProperty</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">pProperty</span><span class="p">],</span> <span class="n">PIN</span><span class="o">.</span><span class="n">Collection</span><span class="p">):</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">pProperty</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pValue</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">pProperty</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="p">[</span><span class="n">pProperty</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">getExtra</span><span class="p">(</span><span class="n">pProperty</span><span class="p">)),</span> <span class="p">(</span><span class="n">pValue</span><span class="p">,</span> <span class="n">PIN</span><span class="o">.</span><span class="n">Extra</span><span class="p">(</span><span class="n">pOp</span><span class="o">=</span><span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">OP_ADD</span><span class="p">,</span> <span class="n">pEid</span><span class="o">=</span><span class="n">EID_LAST_ELEMENT</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="n">pAlwaysCollection</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">pProperty</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pValue</span><span class="p">,</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">pProperty</span><span class="p">]</span> <span class="o">=</span> <span class="n">pValue</span>
    <span class="k">def</span> <span class="nf">moveXafterY</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pProperty</span><span class="p">,</span> <span class="n">pXpos</span><span class="p">,</span> <span class="n">pYpos</span><span class="p">,</span> <span class="n">pTxCtx</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s">&quot;In the collection specified by pProperty, move the element at index pXpos after the element at index pYpos.&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_moveXvsY</span><span class="p">(</span><span class="n">pProperty</span><span class="p">,</span> <span class="n">pXpos</span><span class="p">,</span> <span class="n">pYpos</span><span class="p">,</span> <span class="n">pAfter</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">pTxCtx</span><span class="o">=</span><span class="n">pTxCtx</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">moveXbeforeY</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pProperty</span><span class="p">,</span> <span class="n">pXpos</span><span class="p">,</span> <span class="n">pYpos</span><span class="p">,</span> <span class="n">pTxCtx</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s">&quot;In the collection specified by pProperty, move the element at index pXpos before the element at index pYpos.&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_moveXvsY</span><span class="p">(</span><span class="n">pProperty</span><span class="p">,</span> <span class="n">pXpos</span><span class="p">,</span> <span class="n">pYpos</span><span class="p">,</span> <span class="n">pAfter</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">pTxCtx</span><span class="o">=</span><span class="n">pTxCtx</span><span class="p">)</span>
    <span class="c">#--------</span>
    <span class="c"># PUBLIC: PIN deletion (from Affinity).</span>
    <span class="c">#--------</span>
    <span class="c"># TODO: soft vs purge, undelete etc.</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">deletePINs</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">pPIDs</span><span class="p">,</span> <span class="n">pTxCtx</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s">&quot;Delete pPIDs from the store.&quot;</span>
        <span class="n">lTxCtx</span> <span class="o">=</span> <span class="n">pTxCtx</span> <span class="ow">or</span> <span class="n">AFFINITY</span><span class="p">()</span><span class="o">.</span><span class="n">_txCtx</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">iPid</span> <span class="ow">in</span> <span class="n">pPIDs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">iPid</span><span class="p">,</span> <span class="n">PIN</span><span class="o">.</span><span class="n">PID</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">InvalidParameter</span><span class="p">()</span>
            <span class="n">lPBPin</span> <span class="o">=</span> <span class="n">lTxCtx</span><span class="o">.</span><span class="n">getPBStream</span><span class="p">()</span><span class="o">.</span><span class="n">pins</span><span class="o">.</span><span class="n">add</span><span class="p">()</span>
            <span class="n">lPBPin</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">iPid</span><span class="o">.</span><span class="n">mLocalPID</span>
            <span class="n">lPBPin</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">ident</span> <span class="o">=</span> <span class="n">iPid</span><span class="o">.</span><span class="n">mIdent</span>
            <span class="n">lPBPin</span><span class="o">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">AfyStream</span><span class="o">.</span><span class="n">OP_DELETE</span>
        <span class="n">lTxCtx</span><span class="o">.</span><span class="n">flush</span><span class="p">(</span><span class="n">pExplicit</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="c"># TODO: Decide if final confirmation is a RC or an exception.</span>
    <span class="k">def</span> <span class="nf">deletePIN</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pTxCtx</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s">&quot;Delete self from the store.&quot;</span>
        <span class="k">if</span> <span class="bp">None</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">mPID</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidParameter</span><span class="p">()</span>
        <span class="n">PIN</span><span class="o">.</span><span class="n">deletePINs</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">mPID</span><span class="p">,</span> <span class="p">),</span> <span class="n">pTxCtx</span><span class="p">)</span>
    <span class="c">#--------</span>
    <span class="c"># PUBLIC: PIN loading/refreshing (from Affinity).</span>
    <span class="c">#--------</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">loadPINs</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">pPBStream</span><span class="p">):</span>
        <span class="s">&quot;Load all PINs present in the protobuf stream, and return them.&quot;</span>
        <span class="n">lReadCtx</span> <span class="o">=</span> <span class="n">PBReadCtx</span><span class="p">(</span><span class="n">pPBStream</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">PIN</span><span class="p">()</span><span class="o">.</span><span class="n">loadPIN</span><span class="p">(</span><span class="n">lReadCtx</span><span class="p">,</span> <span class="n">iPBPin</span><span class="p">)</span> <span class="k">for</span> <span class="n">iPBPin</span> <span class="ow">in</span> <span class="n">lReadCtx</span><span class="o">.</span><span class="n">getPBStream</span><span class="p">()</span><span class="o">.</span><span class="n">pins</span><span class="p">]</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">createFromPID</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">pPID</span><span class="p">):</span>
        <span class="s">&quot;Load the PIN specified by pPID, and return it as a new PIN object.&quot;</span>
        <span class="n">lPBStream</span> <span class="o">=</span> <span class="n">AFFINITY</span><span class="p">()</span><span class="o">.</span><span class="n">qProto</span><span class="p">(</span><span class="s">&quot;SELECT * FROM {@</span><span class="si">%x</span><span class="s">};&quot;</span> <span class="o">%</span> <span class="n">pPID</span><span class="o">.</span><span class="n">mLocalPID</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PIN</span><span class="p">()</span><span class="o">.</span><span class="n">loadPIN</span><span class="p">(</span><span class="n">PBReadCtx</span><span class="p">(</span><span class="n">lPBStream</span><span class="p">),</span> <span class="n">lPBStream</span><span class="o">.</span><span class="n">pins</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">loadPIN</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pReadCtx</span><span class="p">,</span> <span class="n">pPBPin</span><span class="p">):</span>
        <span class="s">&quot;Load the specified PIN in-place.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clearPIN</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">iV</span> <span class="ow">in</span> <span class="n">pPBPin</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="n">lPropName</span> <span class="o">=</span> <span class="n">pReadCtx</span><span class="o">.</span><span class="n">getPropName</span><span class="p">(</span><span class="n">iV</span><span class="o">.</span><span class="n">property</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">lPropName</span><span class="p">]</span> <span class="o">=</span> <span class="n">PIN</span><span class="o">.</span><span class="n">_valuePB2PY</span><span class="p">(</span><span class="n">pReadCtx</span><span class="p">,</span> <span class="n">iV</span><span class="p">)</span>
        <span class="c"># Assign last, to avoid unwanted persistent update requests.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mPID</span> <span class="o">=</span> <span class="n">PIN</span><span class="o">.</span><span class="n">PID</span><span class="p">(</span><span class="n">pLocalPID</span><span class="o">=</span><span class="n">pPBPin</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">pIdent</span><span class="o">=</span><span class="n">pPBPin</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">ident</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="nf">refreshPIN</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Refresh the contents of self, by rereading the whole PIN from the store.&quot;</span>
        <span class="k">if</span> <span class="bp">None</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">mPID</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="n">lPBStream</span> <span class="o">=</span> <span class="n">AFFINITY</span><span class="p">()</span><span class="o">.</span><span class="n">qProto</span><span class="p">(</span><span class="s">&quot;SELECT * FROM {@</span><span class="si">%x</span><span class="s">};&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">mPID</span><span class="o">.</span><span class="n">mLocalPID</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadPIN</span><span class="p">(</span><span class="n">PBReadCtx</span><span class="p">(</span><span class="n">lPBStream</span><span class="p">),</span> <span class="n">lPBStream</span><span class="o">.</span><span class="n">pins</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">_clearPIN</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Clear the contents of self.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mPID</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># Assign first, since the goal is not to clear the persisted PIN.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mExtras</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="c"># Review: mIsUpdate?</span>
    <span class="c">#---------</span>
    <span class="c"># PRIVATE: Conversions between affinity_pb2.Value and our python native representation of values.</span>
    <span class="c">#---------</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_valuePY2PB</span><span class="p">(</span><span class="n">pPBValue</span><span class="p">,</span> <span class="n">pPYValue</span><span class="p">,</span> <span class="n">pPropDict</span><span class="p">):</span>
        <span class="s">&quot;[internal] Convert a native python value (pPYValue) into a affinity_pb2.Value. If pPYValue is a tuple containing an &#39;Extra&#39; description, use every available field.&quot;</span>
        <span class="n">lType</span> <span class="o">=</span> <span class="n">pPBValue</span><span class="o">.</span><span class="n">type</span>
        <span class="n">pPBValue</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_ANY</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pPYValue</span><span class="p">,</span> <span class="n">PIN</span><span class="o">.</span><span class="n">Url</span><span class="p">):</span>
            <span class="n">pPBValue</span><span class="o">.</span><span class="n">str</span> <span class="o">=</span> <span class="n">pPYValue</span>
            <span class="n">lType</span> <span class="o">=</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_URL</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pPYValue</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">pPBValue</span><span class="o">.</span><span class="n">str</span> <span class="o">=</span> <span class="n">pPYValue</span>
            <span class="n">lType</span> <span class="o">=</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_STRING</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pPYValue</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
            <span class="n">pPBValue</span><span class="o">.</span><span class="n">str</span> <span class="o">=</span> <span class="n">pPYValue</span>
            <span class="n">lType</span> <span class="o">=</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_STRING</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pPYValue</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">):</span>
            <span class="n">pPBValue</span><span class="o">.</span><span class="n">bstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pPYValue</span><span class="p">)</span>
            <span class="n">lType</span> <span class="o">=</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_BSTR</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pPYValue</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="n">pPBValue</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">pPYValue</span>
            <span class="n">lType</span> <span class="o">=</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_BOOL</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pPYValue</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">)):</span>
            <span class="c"># If we already know the type, don&#39;t mess with it.</span>
            <span class="c"># Review: There might be cases where the new value is voluntarily not compatible; for now, expect explicit type spec in such case.</span>
            <span class="k">if</span> <span class="n">lType</span> <span class="o">==</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_INT</span><span class="p">:</span>
                <span class="n">pPBValue</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="n">pPYValue</span>
            <span class="k">elif</span> <span class="n">lType</span> <span class="o">==</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_UINT</span><span class="p">:</span>
                <span class="n">pPBValue</span><span class="o">.</span><span class="n">ui</span> <span class="o">=</span> <span class="n">pPYValue</span>
            <span class="k">elif</span> <span class="n">lType</span> <span class="o">==</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_INT64</span><span class="p">:</span>
                <span class="n">pPBValue</span><span class="o">.</span><span class="n">i64</span> <span class="o">=</span> <span class="n">pPYValue</span>
            <span class="k">elif</span> <span class="n">lType</span> <span class="o">==</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_UINT64</span><span class="p">:</span>
                <span class="n">pPBValue</span><span class="o">.</span><span class="n">ui64</span> <span class="o">=</span> <span class="n">pPYValue</span>
            <span class="c"># Otherwise, guess.</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">pPYValue</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">2147483648</span> <span class="ow">and</span> <span class="n">pPYValue</span> <span class="o">&lt;=</span> <span class="mi">2147483647</span><span class="p">):</span>
                <span class="n">pPBValue</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="n">pPYValue</span>
                <span class="n">lType</span> <span class="o">=</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_INT</span>
            <span class="k">elif</span> <span class="n">pPYValue</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">pPYValue</span> <span class="o">&lt;=</span> <span class="mi">4294967295</span><span class="p">:</span>
                <span class="n">pPBValue</span><span class="o">.</span><span class="n">ui</span> <span class="o">=</span> <span class="n">pPYValue</span>
                <span class="n">lType</span> <span class="o">=</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_UINT</span>
            <span class="k">elif</span> <span class="n">pPYValue</span> <span class="o">&lt;=</span> <span class="mi">9223372036854775807</span><span class="p">:</span>
                <span class="n">pPBValue</span><span class="o">.</span><span class="n">i64</span> <span class="o">=</span> <span class="n">pPYValue</span>
                <span class="n">lType</span> <span class="o">=</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_INT64</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pPBValue</span><span class="o">.</span><span class="n">ui64</span> <span class="o">=</span> <span class="n">pPYValue</span>
                <span class="n">lType</span> <span class="o">=</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_UINT64</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pPYValue</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">lType</span> <span class="o">==</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_FLOAT</span><span class="p">:</span>
                <span class="n">pPBValue</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">pPYValue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pPBValue</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">pPYValue</span>
                <span class="n">lType</span> <span class="o">=</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_DOUBLE</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pPYValue</span><span class="p">,</span> <span class="n">PIN</span><span class="o">.</span><span class="n">Ref</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pPYValue</span><span class="o">.</span><span class="n">mEid</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">pPBValue</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">pPYValue</span><span class="o">.</span><span class="n">mLocalPID</span>
                <span class="n">pPBValue</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">ident</span> <span class="o">=</span> <span class="n">pPYValue</span><span class="o">.</span><span class="n">mIdent</span>
                <span class="n">pPBValue</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">property</span> <span class="o">=</span> <span class="n">pPropDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pPYValue</span><span class="o">.</span><span class="n">mProperty</span><span class="p">)</span>
                <span class="n">pPBValue</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">eid</span> <span class="o">=</span> <span class="n">pPYValue</span><span class="o">.</span><span class="n">mEid</span>
                <span class="n">lType</span> <span class="o">=</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_REFIDELT</span>
            <span class="k">elif</span> <span class="n">pPYValue</span><span class="o">.</span><span class="n">mProperty</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">pPBValue</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">pPYValue</span><span class="o">.</span><span class="n">mLocalPID</span>
                <span class="n">pPBValue</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">ident</span> <span class="o">=</span> <span class="n">pPYValue</span><span class="o">.</span><span class="n">mIdent</span>
                <span class="n">pPBValue</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">property</span> <span class="o">=</span> <span class="n">pPropDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pPYValue</span><span class="o">.</span><span class="n">mProperty</span><span class="p">)</span>
                <span class="n">lType</span> <span class="o">=</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_REFIDPROP</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pPBValue</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">pPYValue</span><span class="o">.</span><span class="n">mLocalPID</span>
                <span class="n">pPBValue</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">ident</span> <span class="o">=</span> <span class="n">pPYValue</span><span class="o">.</span><span class="n">mIdent</span>
                <span class="n">lType</span> <span class="o">=</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_REFID</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pPYValue</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="c"># Review: Probably shouldn&#39;t need to deal with {Affinity, timezone, dst} conversion on client side. </span>
            <span class="n">lTT</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pPYValue</span><span class="o">.</span><span class="n">timetuple</span><span class="p">());</span> <span class="n">lTT</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">pPBValue</span><span class="o">.</span><span class="n">datetime</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1000000.0</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">lTT</span><span class="p">)</span> <span class="o">+</span> <span class="n">pPYValue</span><span class="o">.</span><span class="n">microsecond</span> <span class="o">+</span> <span class="n">PIN</span><span class="o">.</span><span class="n">TIME_OFFSET</span><span class="p">)</span>
            <span class="n">lType</span> <span class="o">=</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_DATETIME</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pPYValue</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">):</span>
            <span class="n">pPBValue</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pPYValue</span><span class="o">.</span><span class="n">days</span><span class="o">*</span><span class="mf">86400000000.0</span> <span class="o">+</span> <span class="n">pPYValue</span><span class="o">.</span><span class="n">seconds</span><span class="o">*</span><span class="mf">1000000.0</span> <span class="o">+</span> <span class="n">pPYValue</span><span class="o">.</span><span class="n">microseconds</span><span class="p">)</span>
            <span class="n">lType</span> <span class="o">=</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_INTERVAL</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Value type not yet supported: </span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">pPYValue</span><span class="p">),</span> <span class="n">pPYValue</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">pPBValue</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_ANY</span><span class="p">:</span>
            <span class="n">pPBValue</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">lType</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_valuePB2PY</span><span class="p">(</span><span class="n">pPBReadCtx</span><span class="p">,</span> <span class="n">pPBValue</span><span class="p">):</span>
        <span class="s">&quot;[internal] Convert a affinity_pb2.Value into either a single (native python value, Extra), or a list of them (if pPBValue is a collection), and return it.&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_ARRAY</span><span class="p">):</span>
            <span class="n">lResult</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">iV</span> <span class="ow">in</span> <span class="n">pPBValue</span><span class="o">.</span><span class="n">varray</span><span class="o">.</span><span class="n">v</span><span class="p">:</span>
                <span class="n">lResult</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PIN</span><span class="o">.</span><span class="n">_valuePB2PY</span><span class="p">(</span><span class="n">pPBReadCtx</span><span class="p">,</span> <span class="n">iV</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">lResult</span>
        <span class="n">lExtra</span> <span class="o">=</span> <span class="n">PIN</span><span class="o">.</span><span class="n">Extra</span><span class="o">.</span><span class="n">createFromPB</span><span class="p">(</span><span class="n">pPBValue</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_URL</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">PIN</span><span class="o">.</span><span class="n">Url</span><span class="p">(</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">str</span><span class="p">),</span> <span class="n">lExtra</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_STRING</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">str</span><span class="p">),</span> <span class="n">lExtra</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_BSTR</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">bstr</span><span class="p">),</span> <span class="n">lExtra</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_INT</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="n">lExtra</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_UINT</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">ui</span><span class="p">,</span> <span class="n">lExtra</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_INT64</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">i64</span><span class="p">,</span> <span class="n">lExtra</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_UINT64</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">ui64</span><span class="p">,</span> <span class="n">lExtra</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_FLOAT</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">f</span><span class="p">,</span> <span class="n">lExtra</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_DOUBLE</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="n">lExtra</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_INTERVAL</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">microseconds</span><span class="o">=</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">interval</span><span class="p">),</span> <span class="n">lExtra</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_BOOL</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">((</span><span class="bp">False</span><span class="p">,</span> <span class="bp">True</span><span class="p">)[</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">b</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">],</span> <span class="n">lExtra</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_DATETIME</span><span class="p">):</span>
            <span class="c"># Review: Probably shouldn&#39;t need to deal with {Affinity, timezone, dst} conversion on client side. </span>
            <span class="n">lMsInS</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">datetime</span> <span class="o">%</span> <span class="mi">1000000</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1000000.0</span>
            <span class="n">lTT</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">datetime</span> <span class="o">-</span> <span class="n">PIN</span><span class="o">.</span><span class="n">TIME_OFFSET</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1000000.0</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">timezone</span><span class="p">));</span> <span class="n">lTT</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">lTT</span><span class="p">)</span> <span class="o">+</span> <span class="n">lMsInS</span><span class="p">),</span> <span class="n">lExtra</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_QUERY</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">str</span><span class="p">,</span> <span class="n">lExtra</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_REFID</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">PIN</span><span class="o">.</span><span class="n">Ref</span><span class="p">(</span><span class="n">pLocalPID</span><span class="o">=</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">pIdent</span><span class="o">=</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">ident</span><span class="p">),</span> <span class="n">lExtra</span><span class="p">)</span> 
        <span class="k">elif</span> <span class="p">(</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_REFIDPROP</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">PIN</span><span class="o">.</span><span class="n">Ref</span><span class="p">(</span><span class="n">pLocalPID</span><span class="o">=</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">pIdent</span><span class="o">=</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">ident</span><span class="p">,</span> <span class="n">pProperty</span><span class="o">=</span><span class="n">pPBReadCtx</span><span class="o">.</span><span class="n">getPropName</span><span class="p">(</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">property</span><span class="p">)),</span> <span class="n">lExtra</span><span class="p">)</span> 
        <span class="k">elif</span> <span class="p">(</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_REFIDELT</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">PIN</span><span class="o">.</span><span class="n">Ref</span><span class="p">(</span><span class="n">pLocalPID</span><span class="o">=</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">pIdent</span><span class="o">=</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">ident</span><span class="p">,</span> <span class="n">pProperty</span><span class="o">=</span><span class="n">pPBReadCtx</span><span class="o">.</span><span class="n">getPropName</span><span class="p">(</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">property</span><span class="p">),</span> <span class="n">pEid</span><span class="o">=</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">eid</span><span class="p">),</span> <span class="n">lExtra</span><span class="p">)</span> 
        <span class="k">elif</span> <span class="p">(</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_URIID</span><span class="p">):</span>
            <span class="n">lV</span> <span class="o">=</span> <span class="n">pPBReadCtx</span><span class="o">.</span><span class="n">getPropName</span><span class="p">(</span><span class="n">pPBValue</span><span class="o">.</span><span class="n">ui</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lV</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">lV</span> <span class="o">=</span> <span class="n">pPBValue</span><span class="o">.</span><span class="n">ui</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Could not resolve VT_URIID </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">pPBValue</span><span class="o">.</span><span class="n">ui</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">lV</span><span class="p">,</span> <span class="n">lExtra</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Unknown value type </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">pPBValue</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="c">#---------</span>
    <span class="c"># PRIVATE: Preparation steps for protobuf streams sent to Affinity.</span>
    <span class="c">#---------</span>
    <span class="k">def</span> <span class="nf">_preparePBPropIDs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pTxCtx</span><span class="p">):</span>
        <span class="s">&quot;[internal] Extract the StringMap of this PIN&#39;s properties, and merge it into pTxCtx.mPropDict.&quot;</span>
        <span class="k">def</span> <span class="nf">__prepid</span><span class="p">(</span><span class="n">_pPropName</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pTxCtx</span><span class="o">.</span><span class="n">mPropDict</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">_pPropName</span><span class="p">):</span>
                <span class="n">_lPBProp</span> <span class="o">=</span> <span class="n">pTxCtx</span><span class="o">.</span><span class="n">getPBStream</span><span class="p">()</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">add</span><span class="p">()</span>
                <span class="n">_lPBProp</span><span class="o">.</span><span class="n">str</span> <span class="o">=</span> <span class="n">_pPropName</span>
                <span class="n">_lPBProp</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="n">affinity_pb2</span><span class="o">.</span><span class="n">SP_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">pTxCtx</span><span class="o">.</span><span class="n">mPropDict</span><span class="p">)</span>
                <span class="n">pTxCtx</span><span class="o">.</span><span class="n">mPropDict</span><span class="p">[</span><span class="n">_lPBProp</span><span class="o">.</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">_lPBProp</span><span class="o">.</span><span class="n">id</span>
        <span class="k">def</span> <span class="nf">__preprefid</span><span class="p">(</span><span class="n">_pValue</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_pValue</span><span class="p">,</span> <span class="n">PIN</span><span class="o">.</span><span class="n">Ref</span><span class="p">)</span> <span class="ow">and</span> <span class="n">_pValue</span><span class="o">.</span><span class="n">mProperty</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">__prepid</span><span class="p">(</span><span class="n">_pValue</span><span class="o">.</span><span class="n">mProperty</span><span class="p">)</span>
        <span class="c"># Add all the PIN&#39;s properties to the StringMap.</span>
        <span class="c"># Review: Use the mPropID of mExtras, when possible... maybe...</span>
        <span class="k">for</span> <span class="n">iPropName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">():</span>
            <span class="n">__prepid</span><span class="p">(</span><span class="n">iPropName</span><span class="p">)</span>
        <span class="c"># If there are property references, account for them.</span>
        <span class="k">for</span> <span class="n">iPV</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">iPV</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">MutableSequence</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">iE</span> <span class="ow">in</span> <span class="n">iPV</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">__preprefid</span><span class="p">(</span><span class="n">iE</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">__preprefid</span><span class="p">(</span><span class="n">iPV</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">_preparePBValues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pTxCtx</span><span class="p">,</span> <span class="n">pPBPin</span><span class="p">):</span>
        <span class="s">&quot;[internal] Add affinity_pb2.Value objects to pPBPin, representing self.items().&quot;</span>
        <span class="k">def</span> <span class="nf">__prep</span><span class="p">(</span><span class="n">_pPropName</span><span class="p">,</span> <span class="n">_pExtra</span><span class="p">,</span> <span class="n">_pPYVal</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_pPYVal</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">):</span>
                <span class="n">_lV</span> <span class="o">=</span> <span class="n">pPBPin</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">add</span><span class="p">()</span>
                <span class="n">_lV</span><span class="o">.</span><span class="n">property</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">_pExtra</span><span class="o">.</span><span class="n">mPropID</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">_lV</span><span class="o">.</span><span class="n">property</span> <span class="o">=</span> <span class="n">_pExtra</span><span class="o">.</span><span class="n">mPropID</span>
                <span class="k">if</span> <span class="n">_pExtra</span><span class="o">.</span><span class="n">mType</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">_lV</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">_pExtra</span><span class="o">.</span><span class="n">mType</span>
                <span class="n">_lV</span><span class="o">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">_pExtra</span><span class="o">.</span><span class="n">mOp</span>
                <span class="n">_lV</span><span class="o">.</span><span class="n">eid</span> <span class="o">=</span> <span class="n">_pExtra</span><span class="o">.</span><span class="n">mEid</span>
                <span class="n">_lV</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="n">_pExtra</span><span class="o">.</span><span class="n">mMeta</span>
                <span class="n">PIN</span><span class="o">.</span><span class="n">_valuePY2PB</span><span class="p">(</span><span class="n">_lV</span><span class="p">,</span> <span class="n">_pPYVal</span><span class="p">,</span> <span class="n">pTxCtx</span><span class="o">.</span><span class="n">mPropDict</span><span class="p">)</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">==</span> <span class="n">_lV</span><span class="o">.</span><span class="n">property</span><span class="p">:</span>
                    <span class="n">_lV</span><span class="o">.</span><span class="n">property</span> <span class="o">=</span> <span class="n">pTxCtx</span><span class="o">.</span><span class="n">mPropDict</span><span class="p">[</span><span class="n">_pPropName</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">iPV</span><span class="p">,</span> <span class="n">iExtra</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">mExtras</span><span class="o">.</span><span class="n">itervalues</span><span class="p">()):</span>
            <span class="c"># Collection.</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">iPV</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">MutableSequence</span><span class="p">)):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">iExtra</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">iE</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">iPV</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span> <span class="n">iPV</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">__prep</span><span class="p">(</span><span class="n">iPV</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">iExtra</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">iE</span><span class="p">)</span>
            <span class="c"># Scalar.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">__prep</span><span class="p">(</span><span class="n">iPV</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">iExtra</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">iPV</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="c">#---------</span>
    <span class="c"># PRIVATE: Implementation of persistent modifications to an existing PIN.</span>
    <span class="c">#---------</span>
    <span class="k">class</span> <span class="nc">_SilentChange</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pPIN</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mPIN</span> <span class="o">=</span> <span class="n">pPIN</span>
        <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mPID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mPIN</span><span class="o">.</span><span class="n">mPID</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mPIN</span><span class="o">.</span><span class="n">mPID</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etyp</span><span class="p">,</span> <span class="n">einst</span><span class="p">,</span> <span class="n">etb</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mPIN</span><span class="o">.</span><span class="n">mPID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mPID</span>
    <span class="k">def</span> <span class="nf">_handlePINUpdate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pPINUpdate</span><span class="p">,</span> <span class="n">pTxCtx</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">lTxCtx</span> <span class="o">=</span> <span class="n">pTxCtx</span> <span class="ow">or</span> <span class="n">AFFINITY</span><span class="p">()</span><span class="o">.</span><span class="n">mTxCtx</span>
        <span class="n">pPINUpdate</span><span class="o">.</span><span class="n">markAsUpdate</span><span class="p">(</span><span class="n">PIN</span><span class="o">.</span><span class="n">PINUpdate</span><span class="p">([</span><span class="bp">self</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">lTxCtx</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">lTxCtx</span><span class="o">.</span><span class="n">performImmediateUpdates</span><span class="p">()</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">!=</span> <span class="n">lTxCtx</span><span class="o">.</span><span class="n">mTxCnt</span><span class="p">:</span> <span class="c"># XXXXX check that equivalent...</span>
            <span class="n">lTxCtx</span><span class="o">.</span><span class="n">recordPINUpdate</span><span class="p">(</span><span class="n">pPINUpdate</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pPINUpdate</span><span class="o">.</span><span class="n">savePIN</span><span class="p">(</span><span class="n">lTxCtx</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_moveXvsY</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pProperty</span><span class="p">,</span> <span class="n">pXpos</span><span class="p">,</span> <span class="n">pYpos</span><span class="p">,</span> <span class="n">pAfter</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">pTxCtx</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c"># Validate the arguments.</span>
        <span class="k">if</span> <span class="n">pXpos</span> <span class="o">==</span> <span class="n">pYpos</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">pProperty</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">pProperty</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">MutableSequence</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">InvalidParameter</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isInteger</span><span class="p">(</span><span class="n">pXpos</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pXpos</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">pXpos</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">pProperty</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="n">InvalidParameter</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isInteger</span><span class="p">(</span><span class="n">pYpos</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pYpos</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">pYpos</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">pProperty</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="n">InvalidParameter</span><span class="p">()</span>
        <span class="c"># Perform the local (in-memory) modification.</span>
        <span class="c"># Review: Should this also be abstracted?</span>
        <span class="c"># Review: _SilentChange allows me to produce a more efficient persistent representation than the concatenation of insert+pop; but the mechanism used (setting mPID to None temporarily) is arguable.</span>
        <span class="k">with</span> <span class="n">PIN</span><span class="o">.</span><span class="n">_SilentChange</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">lCollection</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">pProperty</span><span class="p">]</span>
            <span class="n">lCollection</span><span class="o">.</span><span class="n">insert</span><span class="p">((</span><span class="n">pYpos</span><span class="p">,</span> <span class="n">pYpos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)[</span><span class="n">pAfter</span><span class="p">],</span> <span class="n">lCollection</span><span class="p">[</span><span class="n">pXpos</span><span class="p">])</span>
            <span class="n">lCollection</span><span class="o">.</span><span class="n">pop</span><span class="p">((</span><span class="n">pXpos</span><span class="p">,</span> <span class="n">pXpos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)[</span><span class="n">pXpos</span> <span class="o">&gt;</span> <span class="n">pYpos</span><span class="p">])</span>
        <span class="c"># Prepare and record/execute the persistent update.</span>
        <span class="n">lE1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getExtra</span><span class="p">(</span><span class="n">pProperty</span><span class="p">,</span> <span class="n">pEpos</span><span class="o">=</span><span class="n">pXpos</span><span class="p">)</span><span class="o">.</span><span class="n">mEid</span>
        <span class="n">lE2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getExtra</span><span class="p">(</span><span class="n">pProperty</span><span class="p">,</span> <span class="n">pEpos</span><span class="o">=</span><span class="n">pYpos</span><span class="p">)</span><span class="o">.</span><span class="n">mEid</span>
        <span class="n">lOp</span> <span class="o">=</span> <span class="p">(</span><span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">OP_MOVE_BEFORE</span><span class="p">,</span> <span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">OP_MOVE</span><span class="p">)[</span><span class="n">pAfter</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handlePINUpdate</span><span class="p">(</span><span class="n">PIN</span><span class="p">({</span> \
            <span class="n">PIN</span><span class="o">.</span><span class="n">SK_PID</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">mPID</span><span class="p">,</span> \
            <span class="n">pProperty</span><span class="p">:(</span><span class="n">lE2</span><span class="p">,</span> <span class="n">PIN</span><span class="o">.</span><span class="n">Extra</span><span class="p">(</span><span class="n">pType</span><span class="o">=</span><span class="n">affinity_pb2</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">VT_UINT</span><span class="p">,</span> <span class="n">pOp</span><span class="o">=</span><span class="n">lOp</span><span class="p">,</span> <span class="n">pEid</span><span class="o">=</span><span class="n">lE1</span><span class="p">))}))</span>
</pre></div>
<!-- end highlighted code -->

</div>
